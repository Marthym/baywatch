<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />
    <meta name="googlebot" content="index, follow, noarchive" />
    <title>De Paris à Toulouse • wi-run, the code</title>
    <link rel="icon" href="https://blog.i-run.si/images/favicon.png" />
    <meta name="description" content="Déplacement des serveurs de l’infrastructure i-Run depuis Paris jusqu’à Toulouse chez notre hébergeur FullSave. Nouvelles machines, nouvelle infra pour plus de résilience et une meilleure tenue de la charge sur les sites publics comme sur le backoffice." />

    <meta name="generator" content="Hugo 0.68.3" />



    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-M9R5W6Q');</script>



    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://blog.i-run.si/posts/silife/infra-de-paris-a-toulouse/featured.jpg"/>
    <meta name="twitter:title" content="De Paris à Toulouse"/>
    <meta name="twitter:description" content="Déplacement des serveurs de l’infrastructure i-Run depuis Paris jusqu’à Toulouse chez notre hébergeur FullSave. Nouvelles machines, nouvelle infra pour plus de résilience et une meilleure tenue de la charge sur les sites publics comme sur le backoffice."/>

    <meta property="og:title" content="De Paris à Toulouse" />
    <meta property="og:description" content="Déplacement des serveurs de l’infrastructure i-Run depuis Paris jusqu’à Toulouse chez notre hébergeur FullSave. Nouvelles machines, nouvelle infra pour plus de résilience et une meilleure tenue de la charge sur les sites publics comme sur le backoffice.">
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://blog.i-run.si/posts/silife/infra-de-paris-a-toulouse/" />
    <meta property="og:image" content="https://blog.i-run.si/posts/silife/infra-de-paris-a-toulouse/featured.jpg"/>
    <meta property="article:published_time" content="2021-01-28T00:00:00+00:00" />
    <meta property="article:modified_time" content="2021-01-28T00:00:00+00:00" />

    <meta content="With " double quote" property="test:double:quote" />
    <meta content="With double quote" property="test:double:quote />











    <link href="https://fonts.googleapis.com/css?family=Barlow+Condensed:400,600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://blog.i-run.si/css/bundle.min.css">
</head>
<body>

<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-M9R5W6Q"
                  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>


<header class="header">
    <div class="headerContainer">
        <div class="header__title">
            <a href="https://blog.i-run.si/" class="header__title__link" alt="Home">

                <img src="https://blog.i-run.si/images/wi-run-logo.svg" class="header__title__logo" alt="wi-run, the code">

            </a>
        </div>

        <nav class="menu" aria-label="menu">
            <ul class="menu__items" aria-label="menu">


                <li class="menu__items__item" aria-label="Développement">
                    <a href="/posts/development/" class="menu__items__item__link "
                       alt="Développement" role="menuitem">
                        Développement
                    </a>
                </li>

                <li class="menu__items__item" aria-label="Vie du service">
                    <a href="/posts/silife/" class="menu__items__item__link "
                       alt="Vie du service" role="menuitem">
                        Vie du service
                    </a>
                </li>

                <li class="menu__items__item" aria-label="Carrière">
                    <a href="/posts/career/" class="menu__items__item__link "
                       alt="Carrière" role="menuitem">
                        Carrière
                    </a>
                </li>

                <li class="menu__items__item" aria-label="L’équipe">
                    <a href="/about/" class="menu__items__item__link "
                       alt="L’équipe" role="menuitem">
                        L’équipe
                    </a>
                </li>

            </ul>
        </nav>
        <nav class="hamburger-menu" aria-label="mobile-menu"  role="navigation">
            <div class="hamburger-menu__toggle">
                <input type="checkbox" class="hamburger__toggle" id="hamburgerToggle" name="hamburger toggle" aria-label="Hamburguer menu">
                <label class="hamburger__toggle__icon" for="hamburgerToggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </label>

                <ul class="hamburger__items" aria-label="mobile-menu">


                    <li class="hamburger__items__item" aria-label="Développement">
                        <a href="/posts/development/" class="hamburger__items__item__link "
                           alt="Développement" role="menuitem">
                            Développement
                        </a>
                    </li>

                    <li class="hamburger__items__item" aria-label="Vie du service">
                        <a href="/posts/silife/" class="hamburger__items__item__link "
                           alt="Vie du service" role="menuitem">
                            Vie du service
                        </a>
                    </li>

                    <li class="hamburger__items__item" aria-label="Carrière">
                        <a href="/posts/career/" class="hamburger__items__item__link "
                           alt="Carrière" role="menuitem">
                            Carrière
                        </a>
                    </li>

                    <li class="hamburger__items__item" aria-label="L’équipe">
                        <a href="/about/" class="hamburger__items__item__link "
                           alt="L’équipe" role="menuitem">
                            L’équipe
                        </a>
                    </li>

                </ul>
            </div>
        </nav>

    </div>
</header>

<article class="post">
    <header class="post__header">
        <h1 class="post__title">De Paris à Toulouse</h1>


        <p class="post__date date">
            28/01/2021 par Team Infra.
        </p>


    </header>


    <main class="post__body">
        <figure>
            <img src="/posts/silife/infra-de-paris-a-toulouse/featured.jpg"
                 alt="Paris Toulouse"/>
        </figure>
        <p>La semaine dernière, le site i-Run est passé en maintenance pour la première fois depuis 2012. Une maintenance programmée de longue date, étape importante de notre projet de modernisation des applications et des infrastructures.</p>
        <p>On vous explique ça&hellip;</p>
        <h2 id="contexte">Contexte</h2>
        <p>Jusqu’à la semaine dernière, les serveurs de tous les sites i-Run se trouvaient à Paris dans une baie chez OVH. De bons et loyaux serveurs qui depuis 12 ans vous servent sans faillir les pages de nos sites. Mais voilà, vous êtes de plus en plus nombreux et aujourd’hui nos vielles machines peinent de plus en plus à vous répondre comme il se doit. Il est temps pour elles de céder la place à une nouvelle génération de serveurs frais et hautement disponibles.</p>
        <p>C’est pourquoi depuis plusieurs mois, notre équipe d’infra travaille à la mise en place d’une nouvelle infrastructure sur Toulouse. Plus de serveurs, plus de capacité, plus de nœuds, plus de résilience, &hellip; bref des serveurs <strong class="runstoppable">#RUNSTOPPABLE</strong> !</p>
        <h2 id="les-dessous-de-lopération">Les dessous de l’opération</h2>
        <h3 id="la-préparation">La préparation</h3>




        <figure class="img-float-left">
            <img src="/posts/silife/infra-de-paris-a-toulouse/preparation.svg"
                 alt="préparation"/>
        </figure>
        <p>Cette opération, c’est tout d’abord des mois de préparation. Avec la mise au point d’une architecture crédible pour supporter notre trafic d’aujourd’hui mais aussi celui de demain. De nombreux tests de composants et de possibilités pour déterminer la meilleure solution. Une <strong>documentation claire avec des schémas lisibles</strong> qui nous permet de communiquer simplement et de faire valider les besoins et les solutions sans risque d’incompréhension.</p>
        <p>Une fois le projet défini et validé, un découpage en tâches de tailles raisonnables (2~3 jours de travail) va permettre d’attaquer un projet immense avec une visibilité sur l’avancement semaine par semaine.</p>
        <br/>
        <h3 id="mise-en-place">Mise en place</h3>
        <p>Durant la phase de mise en place, chacun des Administrateurs &amp; Devops de l’équipe s’est attaqué aux tâches, une par une. Bien sur comme les problèmes n’attendent pas la fin du projet, il a fallu s’organiser pour avancer sur le projet tout en continuant de traiter les problématiques de maintenance courantes : Matériels à remplacer, imprimantes à configurer, évolutions et mises à jours, &hellip;</p>
        <p>Chaque participant alterne entre les tâches du projet de migration et les tâches courantes afin de toujours avancer sans accumuler de la dette par ailleurs. La stratégie fut compliquée tant que Maxence était seul administrateur, mais dès que Nicolas nous a rejoint, il a été plus simple d’alterner.</p>
        <h3 id="tests-de-montées-en-charge">Tests de montées en charge</h3>
        <p>



        <figure class="img-float-right">
            <img src="/posts/silife/infra-de-paris-a-toulouse/load-test.svg"
                 alt="Tests de montée en charge"/>
        </figure>
        Le gros avantage à transférer la production d’un site à l’autre, c’est que les serveurs destination sont disponibles bien avant le transfert, il est facile de tester l’infrastructure et les applications en condition réelle.</p>
        <p>Pendant deux semaines l’équipe d’infra a tenu les serveurs fraîchement installés sous de multiples <a href="https://github.com/JoeDog/siege">sièges</a> en continu. Plusieurs scénarios de test avaient été décrits :</p>
        <ul>
            <li>Des sieges intensifs avec une grande quantité de clients</li>
            <li>Des sièges moins soutenus mais sur des durées très longues</li>
            <li>Des restarts de serveur pendant la charge</li>
            <li>Des déploiements d’applications sous charge</li>
            <li>&hellip;</li>
        </ul>
        <p>Pour chaque test, les conditions d’acceptances sont clairement définies.</p>
        <p>Viennent ensuite les tests fonctionnels. Ici le but n’est pas de tester les applications car le code ne changera pas durant la migration mais plutôt les interactions entre les applications et l’extérieur du système.</p>
        <ul>
            <li>Vérifier les ouvertures de flux</li>
            <li>Vérifier les modes de paiements</li>
            <li>Déclarer les nouvelles IP aux prestataires</li>
            <li>&hellip;</li>
        </ul>
        <p>Plusieurs jours de tests qui ont occupé les développeurs et les fonctionnels. Pendant ce temps les tests d’infra ont continué, afin de valider que les opérations de maintenance n’avaient pas d’impact sur l’utilisation des applications.</p>
        <h3 id="transfert">Transfert</h3>
        <p>Une fois les préparatifs terminés et testés, l’équipe est sereine pour cette opération de maintenance particulière qu’est le déplacement des serveurs de Paris vers Toulouse.</p>
        <p>Vers <strong>10h</strong> le lundi matin, une première synchro des données est réalisée à chaud afin de gagner un peu de temps durant la phase critique prévue pour 23h00. La bande passante est limitée pour ne pas impacter la production.</p>
        <p>A <strong>23h</strong> le site est passé en maintenance pour <strong>la première fois depuis 2012</strong> et toutes les applications, ainsi que la BDD sont stoppées. On lance ensuite une nouvelle synchronisation à froid des données afin de rattraper le retard de la journée.</p>
        <p>Vers <strong>3h</strong> mardi matin, les données sont enfin disponibles sur les nouveaux serveurs à Toulouse. On peut maintenant relancer la BDD et les applications. Une fois les applications relancées et avant de rouvrir le site, on prend le temps de tester les applications et les tâches planifiées la nuit.</p>
        <p>Quelques paramétrages et corrections de dernière minute plus tard, on est prêt à remettre le site en route et à rediriger le trafic vers les IPs de notre nouveau cluster de production.</p>




        <figure class="img-float-left">
            <img src="/posts/silife/infra-de-paris-a-toulouse/transfert.svg"
                 alt="Transfert de la production"/>
        </figure>
        <p>Vers <strong>6h</strong> (oui, c’était des grosses corrections) on commence par mettre à jour les DNS pour qu’ils pointent vers les nouvelles IPs. On avait pris soin la semaine précédente de baisser les TTL sur nos domaines pour que le changement se propage plus rapidement.</p>
        <p>On configure aussi les anciens serveurs pour servir de reverse proxy vers les nouveaux, ainsi les gens qui utilisent les DNS de FAI lents sur les mises à jour DNS, ne seront pas obligés d’attendre une semaine pour accéder à nouveau au site.</p>
        <p>En parallèle les slaves de la BDD ont été synchronisés et reconfigurés pour suivre la nouvelle BDD.</p>
        <p>Enfin, vers <strong>7h</strong> les sites ont quitté la maintenance et sont redevenus pleinement fonctionnels.</p>
        <h3 id="post-migration">Post-migration</h3>
        <p>Bien sûr, et malgré beaucoup de préparation, tout ne se passe jamais sans accros, et le lendemain, en dépit de la fatigue, il a fallu faire face à quelques imprévus.</p>
        <p>Le plus marquant fut un <strong>timeout mal placé sur les proxys</strong> qui, le temps que l’on comprenne, nous a obligé à relancer ces derniers plusieurs fois. Heureusement, comme la <strong>nouvelle infra est résiliente, aucune coupure n’a été remarquée</strong> et une fois le timeout fautif repéré, tout est rapidement rentré dans l’ordre.</p>
        <p>D’autres soucis moins gênants ont été remontés par les autres équipes i-Run durant les jours qui suivirent :</p>
        <ul>
            <li>Des flux sortant qui sont passés à travers les mailles du filet</li>
            <li>Des réglages de HTTPS et de CORS</li>
            <li>Des CRON qui se lancent plus de fois qu’ils ne devraient à cause du nombre d’instances des applications</li>
            <li>&hellip;</li>
        </ul>
        <p>Tous ces problèmes se sont rapidement réglés au cours de la semaine grâce à <strong>la réactivité des devs, du devops et des admins</strong>.</p>
        <h3 id="retour-à-la-normale">Retour à la normale</h3>
        <p>Au final, cette migration représente pour nous, le service info et pour i-Run, la <strong>première étape concrète d’un projet plus vaste de restructuration globale de notre Système d’Information</strong>.</p>
        <p>Pour le service info, ce projet représente :</p>
        <ul>
            <li><strong>2 mois</strong> d’architecture et de recherche</li>
            <li><strong>5 mois</strong> de préparation et d&rsquo;installation des serveurs</li>
            <li><strong>1 mois</strong> de test d’infrastructure</li>
            <li><strong>15 tâches</strong> dans notre board</li>
            <li><strong>66 points de charge</strong> réalisés (572 réalisés en 2020)</li>
            <li><strong>12 heures</strong> de migration et de suivi</li>
        </ul>
        <p>Le tout en parallèle des tâches de maintenance quotidiennes.</p>
        <p><strong>Mais au final le challenge est relevé et la tâche accomplie !</strong></p>




        <figure class="img-center">
            <img src="/posts/silife/infra-de-paris-a-toulouse/big-up_SI-crew.gif"
                 alt="transfert done"/>
        </figure>
        <p>Mais ça n’est que la première pierre de l’édifice. Et si cette aventure vous intéresse, nous recherchons toujours un <a href="/posts/career/2020-12-14-administrateur-system/">Administrateur Système <strong class="runstoppable">#RUNSTOPPABLE</strong></a>, n’hésitez pas à nous contacter.</p>
    </main>



    <footer class="post__footer">

        <ul class="tags">


            <li class="tags__tag">
                <a href="https://blog.i-run.si/tags/infra/" class="tag__link" alt="infra.">
                    #infra
                </a>
            </li>


            <li class="tags__tag">
                <a href="https://blog.i-run.si/tags/system/" class="tag__link" alt="system.">
                    #system
                </a>
            </li>


            <li class="tags__tag">
                <a href="https://blog.i-run.si/tags/production/" class="tag__link" alt="production.">
                    #production
                </a>
            </li>

        </ul>


    </footer>

</article>
<footer class="footer">


    <address class="footer__contact">







    </address>

    <div class="copy">

        <p>© 2021 - wi-run, the code</p>

    </div>






    <script src="https://blog.i-run.si/js/bundle.min.243a483d5297388ef2f4a1b2d5e5d30218e01e8a2dfe213a376ea24d130837c860762a23e9daaa68ae3a7bcd5a3869287a14dc3b738f10486cf4e8fb4291b478.js"></script>







    <script
            defer
            src="https://use.fontawesome.com/releases/v5.7.2/js/all.js"
            integrity="sha384-0pzryjIRos8mFBWMzSSZApWtPl/5&#43;&#43;eIfzYmTgBBmXYdhvxPc&#43;XcFEk&#43;zJwDgWbP"
            crossorigin="anonymous"
    ></script>


</footer></body>

</html>

