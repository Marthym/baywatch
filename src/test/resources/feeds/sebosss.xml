<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
                                           xmlns:content="http://purl.org/rss/1.0/modules/content/"
                                           xmlns:wfw="http://wellformedweb.org/CommentAPI/"
                                           xmlns:dc="http://purl.org/dc/elements/1.1/"
                                           xmlns:atom="http://www.w3.org/2005/Atom"
                                           xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
                                           xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
>

    <channel>
        <title>Le blog de Seboss666</title>
        <atom:link href="https://blog.seboss666.info/feed/" rel="self" type="application/rss+xml" />
        <link>https://blog.seboss666.info</link>
        <description>Les divagations d&#039;un pseudo-geek curieux</description>
        <lastBuildDate>Wed, 18 Nov 2020 17:00:47 +0000</lastBuildDate>
        <language>fr-FR</language>
        <sy:updatePeriod>hourly</sy:updatePeriod>
        <sy:updateFrequency>1</sy:updateFrequency>
        <generator>https://wordpress.org/?v=4.9.15</generator>
        <item>
            <title>Passage √† la fibre : c&#8217;est mon tour !</title>
            <link>https://blog.seboss666.info/2020/11/passage-a-la-fibre-cest-mon-tour/</link>
            <comments>https://blog.seboss666.info/2020/11/passage-a-la-fibre-cest-mon-tour/#comments</comments>
            <pubDate>Wed, 18 Nov 2020 17:00:47 +0000</pubDate>
            <dc:creator><![CDATA[Seboss666]]></dc:creator>
            <category><![CDATA[Projets]]></category>
            <category><![CDATA[alternatives]]></category>
            <category><![CDATA[choix]]></category>
            <category><![CDATA[concurrence]]></category>
            <category><![CDATA[connexion]]></category>
            <category><![CDATA[d√©bit]]></category>
            <category><![CDATA[fibre]]></category>
            <category><![CDATA[limitations]]></category>
            <category><![CDATA[Livebox]]></category>
            <category><![CDATA[manque]]></category>
            <category><![CDATA[orange]]></category>
            <category><![CDATA[performances]]></category>
            <category><![CDATA[r√©seau]]></category>

            <guid isPermaLink="false">https://blog.seboss666.info/?p=6416</guid>
            <description><![CDATA[Et dieu sait que je rageais d&#8217;√™tre le dernier de la famille √† ne pas √™tre √©quip√©. Mon propri√©taire √† fini par faire les travaux [...]]]></description>
            <content:encoded><![CDATA[<p style="text-align: justify;">Et dieu sait que je rageais d&rsquo;√™tre le dernier de la famille √† ne pas √™tre √©quip√©. Mon propri√©taire √† fini par faire les travaux au mois de mai, au sortir du confinement, et d√©but Ao√ªt j&rsquo;ai v√©rifi√© quelles √©taient mes options. Je suis rentr√© fin septembre et n&rsquo;ai pas tra√Æn√© pas besoin de faire plusieurs √©pisodes je pense, enfin on verra bien.</p>
<p style="text-align: justify;"><span id="more-6416"></span></p>
<p style="text-align: justify;">Dans l&rsquo;Oise, et plus sp√©cifiquement le r√©seau public de l&rsquo;Oise, la situation √©tait particuli√®re jusqu&rsquo;√† d√©but 2019, √† savoir que seul SFR √©tait disponible comme op√©rateur, contrairement √† chez ma m√®re qui certes n&rsquo;avaient pas les options les plus sexy du monde, mais avait quand m√™me du choix. Ici donc, Orange a d√©barqu√© par la suite, mais de mani√®re un peu particuli√®re, √† savoir que tout le r√©seau public de l&rsquo;Oise n&rsquo;√©tait pas ¬´¬†exploitable¬†¬ª, ils n&rsquo;activaient les connexions que par plaques, correspondant peu ou prou aux secteurs dans lesquels les abonnements ADSL disparaissaient au profit d&rsquo;SFR. Une situation bien sale, mais si on a suivi les grandes √©tapes du plan THD on n&rsquo;est plus √† un cadeau pr√®s pour que les utilisateurs souffrent et que les op√©rateurs s&rsquo;en mettent plein les poches (enfin surtout leurs actionnaires).</p>
<p style="text-align: justify;">Bref, √©tant dans un immeuble je devais de toute fa√ßon attendre que le bo√Ætier de r√©partition soit pos√© √† l&rsquo;int√©rieur avant de pouvoir pr√©tendre √† la fibre. Autant dire que quand j&rsquo;ai vu que c&rsquo;√©tait possible d&rsquo;avoir autre chose qu&rsquo;SFR comme op√©rateur, j&rsquo;ai bondi sur l&rsquo;occasion. Oui car j&rsquo;ai √©t√© abonn√© mobile SFR pendant pas mal d&rsquo;ann√©es, j&rsquo;ai vu le service client se d√©grader √† la vitesse de la lumi√®re et quand on voit ce qu&rsquo;ils font avec les abonnements, autant vous dire que c&rsquo;est pas demain la veille qu&rsquo;on me verra de nouveau approcher l&rsquo;op√©rateur au carr√© rouge.</p>
<h3 style="text-align: justify;">Le choix de l&rsquo;abonnement, la bonne surprise de l&rsquo;installation</h3>
<p style="text-align: justify;">Avec l&rsquo;univers Orange restant la seule possibilit√©, j&rsquo;ai fait le tour des forfaits et finalement, par rapport √† ma situation actuelle, je me suis finalement tourn√© vers <a href="https://shop.sosh.fr/box-internet" target="_blank" rel="noopener">le forfait Sosh fibre</a>. Non seulement le tarif est plus int√©ressant que les autres offres Orange, mais en plus au mois de Septembre j&rsquo;ai b√©n√©fici√© d&rsquo;une r√©duction pour ne payer que 15‚Ç¨ par mois pendant un an, encore plus int√©ressant ! Et l&rsquo;offre est sans engagement, ce qui sera pratique lorsque je vais d√©m√©nager, ce qui est pr√©vu dans moins d&rsquo;un an. Par contre, la contrepartie, c&rsquo;est que je n&rsquo;ai ¬´¬†que¬†¬ª 300Mbps de bande passante sym√©trique, largement suffisant pour moi tout seul, ce qui est de toute fa√ßon infiniment plus agr√©able qu&rsquo;un ¬´¬†maigre¬†¬ª 16/1 en ADSL.</p>
<p style="text-align: justify;">J&rsquo;ai pris rendez-vous quelques jours avant mon retour √† l&rsquo;appartement, apr√®s six mois √† soutenir ma m√®re qui s&rsquo;√©tait litt√©ralement d√©mont√© le dos (quand votre premi√®re vert√®bre lombaire est d√©cal√©e de plus d&rsquo;un centim√®tre, et qu&rsquo;en plus un morceau est cass√©, oui, d√©mont√© c&rsquo;est le bon terme). Je chois de prendre rendez-vous le 25 septembre, d&rsquo;abord l&rsquo;apr√®s-midi, et apr√®s discussion avec Pierre-marie, je reprogramme tout de suite pour faire le matin, car avec les surprises du matin parfois les rendez-vous de l&rsquo;apr√®s-midi ne sont pas honor√©s. La box est partie moins de deux jours plus tard, et je re√ßois un texto pour me confirmer le rendez-vous du matin. Et un autre deux heures plus tard pour me confirmer le rendez-vous de l&rsquo;apr√®s-midi. C&rsquo;est des rigolos chez Orange dis donc, c&rsquo;est rassurant. La box est livr√©e dans un point relai √† deux pas de la maison, puisqu&rsquo;il s&rsquo;agit du salon de coiffure chez qui mon ventirad avait d√©j√† √©t√© livr√©, <a href="https://blog.seboss666.info/2019/09/on-change-le-pc-de-jeu-part-4/" target="_blank" rel="noopener">remember</a>.</p>
<p style="text-align: justify;">Mais quand je parle de bonne surprise de l&rsquo;installation, c&rsquo;est pour deux raisons. La premi√®re, c&rsquo;est que je re√ßois en fait un appel d√®s le lundi matin d&rsquo;une petite dame qui m&rsquo;explique, apr√®s m&rsquo;avoir demand√© de confirmer que j&rsquo;avais bien pris rendez-vous pour le vendredi, que les techniciens peuvent en fait passer dans le quart d&rsquo;heure qui suit l&rsquo;appel, soit avec quatre jours d&rsquo;avance. Je n&rsquo;ai m√™me pas encore pu r√©cup√©rer la box car le salon de coiffure est ferm√© le lundi ! Pas grave me dit-on, les techniciens posent la prise, et on branche la boiboite d√®s que c&rsquo;est possible. Je stress juste un peu parce que je n&rsquo;ai m√™me pas l&rsquo;ONT qui est livr√© avec la box, et que le technicien est sens√© le configurer directement.</p>
<p style="text-align: justify;">La deuxi√®me bonne nouvelle donc, c&rsquo;est l&rsquo;installation elle-m√™me, contrairement aux prestataires qui ont pos√© le r√©partiteur et ont fait √ßa comme de salopards de premi√®re, avec le fil qui court sans alignement avec les goulottes existantes, les deux poseurs sont consciencieux, longent syst√©matiquement tous les murs et encoignures, passent l&rsquo;√©tage par l&rsquo;endroit que voulait proposer le propri√©taire, rentrent chez moi pile sous les poutres, et suivent l√† encore toute la longueur, passent comme il faut dans le salon, et suit la jonction mur/plafond pour aller poser la prise dans le coin de la pi√®ce o√π la prise t√©l√©phonique existe d√©j√†, ce qui √©tait ce que je voulais. Le c√¢ble est blanc, les murs sont blanc, tout est presque invisible. Et tout est fait √† la colle chaude, donc facile √† refaire si besoin (le propri√©taire voulait que √ßa soit fait en goulotte, ce que ne proposent pas les techniciens &#8212; allez voir les prix en magasin vous comprendrez). Le jour et la nuit par rapport √† la pose du r√©partiteur donc.</p>
<h3 style="text-align: justify;">La Livebox 4, mais quelle horreur</h3>
<p style="text-align: justify;">Le lendemain donc, je fonce √† la premi√®re heure r√©cup√©rer la box (et prendre rendez-vous pour refaire la perruque du nounours au passage, parce qu&rsquo;il √©tait temps). L&rsquo;installation est particuli√®rement simple, on branche l&rsquo;Ethernet, on branche le transfo, on allume, on attend, et quelques minutes de mise √† jour plus tard, la box est d√©marr√©e et on re√ßoit un SMS validant l&rsquo;activation. M√™me pour un technicien qui s&rsquo;attend √† devoir aller toucher du param√®tre, un tel d√©marrage rapide et simple est appr√©ciable.</p>
<p><a href="https://blog.seboss666.info/wp-content/uploads/2020/11/livebox_4_front.jpg" rel="lightbox[6416]"><img class="aligncenter size-medium wp-image-6449" src="https://blog.seboss666.info/wp-content/uploads/2020/11/livebox_4_front-300x153.jpg" alt="" width="300" height="153" srcset="https://blog.seboss666.info/wp-content/uploads/2020/11/livebox_4_front-300x153.jpg 300w, https://blog.seboss666.info/wp-content/uploads/2020/11/livebox_4_front-768x392.jpg 768w, https://blog.seboss666.info/wp-content/uploads/2020/11/livebox_4_front-1024x522.jpg 1024w, https://blog.seboss666.info/wp-content/uploads/2020/11/livebox_4_front.jpg 1400w" sizes="(max-width: 300px) 100vw, 300px" /></a></p>
<p style="text-align: justify;">Comme je n&rsquo;ai pas sp√©cialement envie de tout p√©ter direct, je tente simplement de relier le switch du bureau, qui raccorde mon PC de jeu et mon PC de boulot (eh oui, rentr√© chez moi, mais toujours t√©l√©travail), et je fais un test rapide. Ben √ßa tient ses promesses d√©j√† en termes de d√©bit et de latence, donc c&rsquo;est un bon point, et √ßa rend le boulot plus agr√©able (je vous jure que les 1Mbps montants de l&rsquo;ADSL, quand vous faites un <code>terraform plan</code> sur plus d&rsquo;une trentaine de ressources, √ßa tue la connexion). Je passe donc la semaine en mode hybride, la ¬´¬†grosse bertha¬†¬ª et le laptop pro sur la fibre, le reste encore sur la Freebox.</p>
<p style="text-align: justify;">Il faudra patienter encore un jour ou deux pour que je commence √† faire l&rsquo;inventaire de ce que j&rsquo;ai √† param√©trer pour retrouver un r√©seau dans le m√™me √©tat que pr√©c√©demment. Je n&rsquo;ai pas grand chose et rien n&rsquo;est tr√®s isol√©, mais je cherche √† avoir le moins de choses possibles √† reconfigurer. Choix est donc fait de changer l&rsquo;adresse IP de la Livebox pour coller √† celle de la Freebox, √† savoir 192.168.1.254. Eh oui, √ßa permet d&rsquo;√©viter de reconfigurer tous les serveurs physiques et virtuels pour refaire les passerelles par d√©faut. Je me tourne vers le DHCP pour aligner √©galement la plage d&rsquo;IP pour les clients (PC fixe, PC portables, smartphones&#8230;). Mauvaise nouvelle que je savais d√©j√†, on ne peut pas contr√¥ler les serveurs DNS qui sont utilis√©s par le r√©seau, il impose la box comme relai local, avec toutes les conneries de filtrage impos√© qui vont avec. Encore une fois dans l&rsquo;urgence, je laisse comme √ßa.</p>
<p><a href="https://blog.seboss666.info/wp-content/uploads/2020/11/network_livebox_dhcp.png" rel="lightbox[6416]"><img class="size-medium wp-image-6450 aligncenter" src="https://blog.seboss666.info/wp-content/uploads/2020/11/network_livebox_dhcp-300x248.png" alt="" width="300" height="248" srcset="https://blog.seboss666.info/wp-content/uploads/2020/11/network_livebox_dhcp-300x248.png 300w, https://blog.seboss666.info/wp-content/uploads/2020/11/network_livebox_dhcp-768x634.png 768w, https://blog.seboss666.info/wp-content/uploads/2020/11/network_livebox_dhcp.png 875w" sizes="(max-width: 300px) 100vw, 300px" /></a></p>
<p style="text-align: justify;"><a href="https://blog.seboss666.info/wp-content/uploads/2020/11/network_freebox_dhcp.png" rel="lightbox[6416]"><img class="aligncenter size-medium wp-image-6451" src="https://blog.seboss666.info/wp-content/uploads/2020/11/network_freebox_dhcp-300x281.png" alt="" width="300" height="281" srcset="https://blog.seboss666.info/wp-content/uploads/2020/11/network_freebox_dhcp-300x281.png 300w, https://blog.seboss666.info/wp-content/uploads/2020/11/network_freebox_dhcp.png 644w" sizes="(max-width: 300px) 100vw, 300px" /></a>Au d√©but avec la Freebox je m&rsquo;√©tais ¬´¬†amus√©¬†¬ª √† utiliser les baux DHCP statiques pour les VMs, ce qui est une √©norme connerie, et je m&rsquo;en √©tais pass√© lors de la refonte du serveur pour le passage √† k3s. Mais il restait une machine dissidente, √† savoir le Raspberry Pi. Je suis pass√© vite fait dans les r√©glages de <a href="https://blog.seboss666.info/2016/12/openelec-libreelec-osmc-mais-cest-devenu-le-bordel-ma-pauvre-dame/" target="_blank" rel="noopener">LibreELEC</a> pour passer en manual, il propose par d√©faut de garder les param√®tres d√©j√† affect√©s par le DHCP, ce qui fait que via la t√©l√©commande on a rien √† faire et c&rsquo;est tant mieux. Et oui, comme les partages NFS sont filtr√©s par IP, il n&rsquo;est √©videmment pas question que le Pi change d&rsquo;IP tous les quatre matins.</p>
<p style="text-align: justify;">Quand j&rsquo;attaque les grosses op√©rations le weekend, c&rsquo;est le bordel. J&rsquo;essaie de pr√©-param√©trer les redirections de port dans l&rsquo;onglet NAT/PAT, mais pas moyen de rentrer manuellement les adresses IP pour les r√®gles, la s√©lection ne se fait que via une liste d√©roulante qui est remplie avec les appareils que la box d√©tecte. C&rsquo;est chiant au possible, √ßa veut donc dire que je dois tout reparam√©trer APR√àS avoir tout d√©branch√©/rebranch√©. Et quand je finis par le faire, c&rsquo;est rigolo, parce que y&rsquo;a pas la moiti√© des noms des machines qui sont bons, tous les serveurs Linux ne sont pas identifi√©s mais ont un nom ¬´¬†PC-00¬†¬ª √† la place, pareil pour le laptop. Autre fait navrant, on peut indiquer le type d&rsquo;appareil s&rsquo;il n&rsquo;est pas correctement d√©tect√©, mais une fois encore, la liste d√©roulante ne propose pas d&rsquo;option serveur. Au mieux on a quand m√™me une ic√¥ne NAS qu&rsquo;il a fallu que j&rsquo;ajoute moi-m√™me parce que le NAS, si son nom s&rsquo;affiche correctement, n&rsquo;est pas identifi√© en tant que stockage. Au final mes r√®gles sont bien remises en place, mais quel manque d&rsquo;ergonomie en 2020&#8230; J&rsquo;ai fini par une bascule DNS et quelques minutes plus tard, j&rsquo;ai pu valider que tout refonctionnait comme avant. Mais beaucoup plus vite donc. Mais avec des limitations √† faire sauter.</p>
<p style="text-align: justify;">Ah oui, alors la Freebox ne fait pas beaucoup mieux en la mati√®re, mais on a bien une option activer/d√©sactiver le pare-feu IPv6 (oui j&rsquo;ai bien de l&rsquo;IPv6, ouf), on ne l&rsquo;a m√™me pas sur la Livebox. Au moins j&rsquo;ai pu valider que je ne pouvais pas joindre une machine en IPv6 de l&rsquo;ext√©rieur, ce qui est ce que j&rsquo;avais avec Free. Donc toujours pas de possibilit√© de faire de l&rsquo;h√©bergement IPv6 chez soi, quand je vous dis que c&rsquo;est une honte en 2020&#8230; Au moins le NAT fonctionne comme attendu, pas comme chez ma m√®re o√π je n&rsquo;ai pas pu r√©pliquer la m√™me configuration de bastion que chez moi.</p>
<h3 style="text-align: justify;">On contourne rapidos les premi√®res limitations</h3>
<p style="text-align: justify;">Le probl√®me imm√©diat que je veux r√©soudre est le serveur DHCP. Comme c&rsquo;est impossible de faire quoi que ce soit avec, la solution est de le remplacer par un service adapt√©. Je n&rsquo;ai jamais eu √† d√©ployer de service DHCP, c&rsquo;est comme n&rsquo;importe quel service r√©seau et je pourrais tout √† faire le mettre sur une des VMs. J&rsquo;ai pu voir des alternatives indiquant que sur certains NAS il existe un service DHCP qu&rsquo;on peut activer. Et oui, c&rsquo;est le cas sur Asustor, bon par contre le chemin pour s&rsquo;y rendre n&rsquo;est pas trivial. Il n‚Äôappara√Æt pas comme n&rsquo;importe quel service du NAS, il faut se rendre dans les param√®tres, section r√©seau, s√©lectionner l&rsquo;interface r√©seau Ethernet, et cliquer enfin sur le bouton serveur DHCP. La page en question dispose l√† aussi d&rsquo;un bouton pour g√©rer les plages d&rsquo;IP √† fournir aux clients, via une popup d√©di√©e. C&rsquo;est donc compliqu√© √† trouver, et pas ergonomique. Mais le fait est que j&rsquo;ai pu remettre la plage IP que j&rsquo;avais d√©j√†, avec les r√©solveurs DNS que je veux (FDN pour l&rsquo;instant, bient√¥t la remise en service d&rsquo;un cache local ?), et indiquer la Livebox comme passerelle. On d√©sactive le DHCP de la box, on active celui du NAS, et on teste avec le smartphone et le laptop (j&rsquo;ai eu plus de mal avec le PC de jeu, Windows mon amour).</p>
<p><a href="https://blog.seboss666.info/wp-content/uploads/2020/11/asustor_adm_dhcp.png" rel="lightbox[6416]"><img class="aligncenter size-medium wp-image-6452" src="https://blog.seboss666.info/wp-content/uploads/2020/11/asustor_adm_dhcp-300x87.png" alt="" width="300" height="87" srcset="https://blog.seboss666.info/wp-content/uploads/2020/11/asustor_adm_dhcp-300x87.png 300w, https://blog.seboss666.info/wp-content/uploads/2020/11/asustor_adm_dhcp-768x223.png 768w, https://blog.seboss666.info/wp-content/uploads/2020/11/asustor_adm_dhcp-1024x298.png 1024w, https://blog.seboss666.info/wp-content/uploads/2020/11/asustor_adm_dhcp.png 1581w" sizes="(max-width: 300px) 100vw, 300px" /></a></p>
<p style="text-align: justify;">L&rsquo;autre probl√®me que j&rsquo;ai est d&rsquo;ordre physique. Comme chez ma m√®re, la box et l&rsquo;ONT sont aliment√©s par des satan√©s transfos qui prennent une place monstre. J&rsquo;ai donc profit√© de cette migration pour r√©installer l&rsquo;onduleur, r√©organiser les multiprises, pour avoir quelque chose de propre, qui couvre les appareils importants, en g√©rant la place monstrueuse que √ßa prend.j&rsquo;ai une multiprise de 6 points et pratiquement 4 sont bloqu√©s √† cause des deux blocs, je vous laisse imaginer la frustration.</p>
<h3 style="text-align: justify;">La Livebox doit mourir</h3>
<p style="text-align: justify;">C&rsquo;est pas pour demain, les politiques des op√©rateurs sont toujours d&rsquo;essayer de vous enfermer dans leur univers via cette box. Tout n&rsquo;est pas perdu, c&rsquo;est encore possible pour l&rsquo;instant, √ßa demande par contre du mat√©riel d√©di√©. Mais j&rsquo;aimerai bien retrouver certaines fonctionnalit√©s qui sont utiles sur Freebox, comme la visualisation du trafic par port Ethernet de la box (non, √ßa n&rsquo;existe pas sur Livebox), une vraie gestion DHCP/DNS int√©gr√©e (pareil), un vrai pare-feu IPv4/IPv6 (bon l√† on est presque √† √©galit√©), et une observabilit√© par API pour retrouver mes infos dans Prometheus, <a href="https://github.com/saphoooo/freebox_exporter/" target="_blank" rel="noopener">qu&rsquo;on peut faire</a> avec la Freebox (jamais publi√© mon PoC, et tout est d√©sormais d√©truit&#8230;). J&rsquo;envisage de tester le <a href="https://www.ui.com/edgemax/edgerouter-x/" target="_blank" rel="noopener">EdgeRouter X d&rsquo;Ubiquity</a>, certes ce n&rsquo;est pas OpenSource mais √ßa semble, pour une cinquantaine/soixantaine d&rsquo;euros, supporter tout ce dont j&rsquo;ai besoin, et m√™me plus.</p>
]]></content:encoded>
            <wfw:commentRss>https://blog.seboss666.info/2020/11/passage-a-la-fibre-cest-mon-tour/feed/</wfw:commentRss>
            <slash:comments>2</slash:comments>
        </item>
        <item>
            <title>Huawei P20 Lite, deux ans apr√®s</title>
            <link>https://blog.seboss666.info/2020/11/huawei-p20-lite-deux-ans-apres/</link>
            <comments>https://blog.seboss666.info/2020/11/huawei-p20-lite-deux-ans-apres/#respond</comments>
            <pubDate>Mon, 16 Nov 2020 17:00:48 +0000</pubDate>
            <dc:creator><![CDATA[Seboss666]]></dc:creator>
            <category><![CDATA[Humeur]]></category>
            <category><![CDATA[Mobilit√©]]></category>
            <category><![CDATA[android]]></category>
            <category><![CDATA[autonomie]]></category>
            <category><![CDATA[conflit]]></category>
            <category><![CDATA[√©volutions]]></category>
            <category><![CDATA[Huawei]]></category>
            <category><![CDATA[obsolescence]]></category>
            <category><![CDATA[s√©curit√©]]></category>
            <category><![CDATA[smartphone]]></category>
            <category><![CDATA[solidit√©]]></category>
            <category><![CDATA[stabilit√©]]></category>

            <guid isPermaLink="false">https://blog.seboss666.info/?p=6237</guid>
            <description><![CDATA[Eh ouais, √ßa fait d√©j√† plus de deux ans que j&#8217;ai achet√© mon t√©l√©phone, vous savez celui qui collait pas du tout √† ma checklist [...]]]></description>
            <content:encoded><![CDATA[<p style="text-align: justify;">Eh ouais, √ßa fait d√©j√† plus de deux ans que j&rsquo;ai achet√© mon t√©l√©phone, vous savez celui qui collait pas du tout √† ma checklist de pr√©requis. On avait d√©j√† fait un premier point d&rsquo;√©tape <a href="https://blog.seboss666.info/2019/04/mon-p20-lite-presque-un-an-apres/" target="_blank" rel="noopener">au bout d&rsquo;un an</a>, comme il est toujours debout, il serait temps d&rsquo;en reparler apr√®s sa deuxi√®me bougie <img src="https://s.w.org/images/core/emoji/11/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<p style="text-align: justify;"><span id="more-6237"></span></p>
<h3 style="text-align: justify;">Physiquement, RAS</h3>
<p style="text-align: justify;">Je suis quelqu&rsquo;un de pas sp√©cialement stress√© sur mon t√©l√©phone, mais avec sa protection en verre et sa coque silicone, autant dire que je fais un peu attention quand m√™me. Le silicone c&rsquo;est la vie, pour les smartphones √©videmment, sinon en dehors du latex je pr√©f√®re le naturel <img src="https://s.w.org/images/core/emoji/11/72x72/1f600.png" alt="üòÄ" class="wp-smiley" style="height: 1em; max-height: 1em;" /> Plus s√©rieusement, le silicone transparent a quand m√™me bien jauni, c&rsquo;est un ph√©nom√®ne que j&rsquo;avais d√©j√† constat√© avec la coque en silicone transparent qui √©tait fournie avec le OnePlus X. Et la protection en verre a pris un peu cher, mais d&rsquo;une part c&rsquo;est dans un coin, de l&rsquo;autre, c&rsquo;est tellement l√©ger que m√™me √©cran allum√© on le voit pas. Faut dire qu&rsquo;il est bien plaqu√© sur l&rsquo;√©cran, √† part les coins sup√©rieurs mais √ßa ne l&rsquo;a jamais d√©rang√©. Si vraiment j&rsquo;√©tais capricieux, j&rsquo;en ai une toute neuve dans le tiroir de mon bureau <img src="https://s.w.org/images/core/emoji/11/72x72/1f600.png" alt="üòÄ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<p style="text-align: justify;">Le truc qui √©tait d√©j√† chiant et qui l&rsquo;est toujours sur ce smartphone, c&rsquo;est la grille du haut parleur qu&rsquo;il faut r√©guli√®rement nettoyer des poussi√®res et des in√©vitables crasses qui se collent dedans. Idem pour l&rsquo;unique trou du microphone encore plus minuscule. J&rsquo;ai pris l&rsquo;habitude de le faire avec une petite √©pingle de couture que m&rsquo;a laiss√© ma ch√®re maman. C&rsquo;est le probl√®me quand le t√©l√©phone passe son temps dans la poche d&rsquo;un jean&#8230;</p>
<h3 style="text-align: justify;">L&rsquo;autonomie : c&rsquo;est toujours bon, mais on sent du moins bien</h3>
<p style="text-align: justify;">C&rsquo;est une des bonnes surprises de ce t√©l√©phone deux ans apr√®s. L&rsquo;autonomie est encore tr√®s bonne malgr√© le fait que j&rsquo;ai multipli√© les recharges, avec l&rsquo;utilisation intensive dans les transports et chez moi o√π √ßa capte pas super, je le recharge en temps normal tous les jours. √âvidemment pendant le premier confinement, sans l&rsquo;utilisation dans les transports, je m&rsquo;en sers moins et il capte bien mieux, ce qui fait que je le recharge tous les deux jours.</p>
<div id="attachment_6338" style="width: 227px" class="wp-caption aligncenter"><a href="https://blog.seboss666.info/wp-content/uploads/2020/05/lapin_duracell.jpg" rel="lightbox[6237]"><img class="size-medium wp-image-6338" src="https://blog.seboss666.info/wp-content/uploads/2020/05/lapin_duracell-217x300.jpg" alt="" width="217" height="300" srcset="https://blog.seboss666.info/wp-content/uploads/2020/05/lapin_duracell-217x300.jpg 217w, https://blog.seboss666.info/wp-content/uploads/2020/05/lapin_duracell.jpg 300w" sizes="(max-width: 217px) 100vw, 217px" /></a><p class="wp-caption-text">Paie ta ref de vieux</p></div>
<p style="text-align: justify;">Il ne faudra malgr√© tout pas que je tra√Æne pour acheter une batterie de rechange pour pr√©voir un futur d√©montage (chose que je n&rsquo;ai pas faite pour le OnePlus X en m√™me temps, donc je sais pas si √ßa va durer). Ou que je change de t√©l√©phone si un futur mod√®le qui colle √† mes crit√®res, qui ont peu boug√©, se pr√©sente. Mais j&rsquo;ai un doute.</p>
<h3 style="text-align: justify;">Logiciel : bugs, mises √† jour&#8230;</h3>
<p style="text-align: justify;">La situation de Twidere est toujours compliqu√©e, le logiciel est principalement en mode maintenance, c&rsquo;est donc au petit bonheur la chance par rapport aux √©volutions de Twitter. Mais je n&rsquo;ai pas r√©install√© l&rsquo;application officielle parce que franchement, vu le peu que j&rsquo;utilise Twitter sur le t√©l√©phone en fait, il fait suffisamment bien le boulot (j&rsquo;ai par contre r√©cemment d√©couvert qu&rsquo;il manquait les sondages, alors que √ßa fonctionnait avant, et c&rsquo;est la foire avec les messages priv√©s. La gestion de l&rsquo;API est infernale, d&rsquo;ici √† ce que je doive encore jouer avec les cl√©s d&rsquo;API&#8230;).</p>
<p style="text-align: justify;">L√† o√π j&rsquo;ai fait √©voluer la configuration, c&rsquo;est sur la gestion d&rsquo;applications. F-Droid toujours au poste √©videmment, mais Yalp n&rsquo;√©tait plus maintenu et posait de plus en plus de probl√®mes avec certaines applications empaquet√©es en mode ¬´¬†instant app¬†¬ª qui g√©n√®re plusieurs fichiers apk, que Yalp ne savait pas g√©rer. Celui-ci avait √©t√© fork√© pour donner <a href="https://f-droid.org/fr/packages/com.aurora.adroid/" target="_blank" rel="noopener">Aurora Store</a>, qui fonctionne pas mal et r√®gle cette histoire de ¬´¬†split apk¬†¬ª, mais qui peut encore avoir sporadiquement quelques difficult√©s avec la connexion anonyme. Avec les probl√®mes sur la gestion en arri√®re-plan des applications qui n&rsquo;a pas vraiment chang√©, je continue de d√©clencher manuellement les mises √† jour. Quelques minutes le weekend pour v√©rifier ce qui tra√Æne, la plupart du temps √ßa suffit largement quand on a d√©j√† une bonne hygi√®ne num√©rique. Aurora n&rsquo;est lui-m√™me pas exempt de bug, j&rsquo;ai du r√©trograder de version il y a quelques temps √† cause d&rsquo;un probl√®me avec la cr√©ation de l&rsquo;API pour acc√©der au store Google, pas tr√®s pratique. Et F-Droid n&rsquo;est pas toujours tr√®s r√©actif dans les builds des nouvelles versions. C&rsquo;est rentr√© dans l&rsquo;ordre depuis.</p>
<p style="text-align: justify;">Un dernier bug m√©chant qui faisait chier et pour lequel j‚Äôattendais Fenix avec impatience, c&rsquo;est Firefox Mobile. Avec le bordel sur la mise en veille des applications, une fois sur deux, quand je veux rouvrir la fen√™tre j&rsquo;avais un souci avec les cookies qui ne sont plus lus ni stock√©s, ce qui plante toutes les applis, FreshRSS en t√™te puisque c&rsquo;est son principal usage. J&rsquo;√©tais alors oblig√© de le fermer compl√®tement et le relancer, ce qui prend de nombreuses secondes parce que la lourdeur √©tait de mise. J&rsquo;ai eu l&rsquo;occasion de passer sur Firefox Beta maintenant que c&rsquo;est le <a href="https://blog.seboss666.info/2020/08/firefox-pour-android-le-renouveau-imparfait-une-fois-de-plus/" target="_blank" rel="noopener">Firefox Nouveau</a>, il n&rsquo;est √† mon sens toujours pas au niveau fonctionnel de son pr√©c√©desseur, mais au moins sa stabilit√© est bien meilleure qu&rsquo;avant. On va dire que je me r√©p√®te, mais le niveau de finition, y&rsquo;a un truc qui m&rsquo;√©chappe forc√©ment, comme la feignantise sur le support de WebRTC mis en lumi√®re salement avec <a href="https://github.com/jitsi/jitsi-meet/issues/4758" target="_blank" rel="noopener">les probl√®mes de Jitsi Meet</a>. C&rsquo;est vrai que <a href="https://www.lesnumeriques.com/vpn/firefox-private-network-le-vpn-a-la-sauce-mozilla-pour-android-et-windows-10-n147389.html" target="_blank" rel="noopener">vendre un VPN host√© aux US</a> c&rsquo;est plus important que de respecter les standards ouverts pour lesquels on s&rsquo;est battu y&rsquo;a quelques ann√©es&#8230;</p>
<p style="text-align: justify;">Sinon dans l&rsquo;ensemble c&rsquo;est toujours tr√®s stable, je n&rsquo;ai pratiquement jamais de ¬´¬†force close¬†¬ª des applis (√ßa doit arriver une fois tous les deux mois, voire encore plus rarement). La fluidit√© est toujours globalement bonne, il arrive tout de m√™me sur le switch d&rsquo;applications un peu lourdes que √ßa lag un poil. Reste les applis par d√©faut de Huawei qui sont vraiment p√©nibles parce qu&rsquo;on peut pas les d√©sactiver et qu&rsquo;elles ne perdent pas une occasion de revenir sur le devant de la sc√®ne, je pense notamment √† l&rsquo;application Musique qui emp√™che VLC de capturer les √©v√®nements casque correctement.</p>
<h3 style="text-align: justify;">Version d&rsquo;Android, s√©curit√© : √† la limite de la mention assez bien</h3>
<p style="text-align: justify;">Sur les mises √† jour de l&rsquo;OS, le t√©l√©phone est toujours en version 9 d&rsquo;Android, je pense pas avoir droit un jour √† la version 10, et la situation de Huawei avec l&rsquo;acc√®s aux technologies US ne s&rsquo;arrange pas, d&rsquo;autant plus avec Donald Duck en t√™te de ligne (ouais il est pas beaucoup plus intelligent qu&rsquo;un canard ce mec alors&#8230;). L&rsquo;arriv√©e compliqu√©e de Biden en remplacement ne devrait toutefois pas changer les choses dans un avenir proche. Les mises √† jour de s√©curit√© et les corrections de bug mineurs sont toujours au programme mais souvent avec de gros d√©calages (genre deux √† trois mois), et l√† on sent que Huawei ne va pas faire beaucoup d&rsquo;efforts suppl√©mentaires, quand il cherche √† convaincre que <a href="https://www.frandroid.com/marques/huawei/694554_test-huawei-p40-avis-smartphone-haut-de-gamme" target="_blank" rel="noopener">son P40 et ses ersatz de services Google</a> sont suffisants dans un monde drogu√© au logiciel ricain; spoiler alert, c&rsquo;est rat√©. Et encore, il faudra que je fasse une v√©rification parce qu&rsquo;il parait que les constructeurs mentent parfois sur la r√©alit√© du niveau de patch appliqu√©. Ouais parce que vous comprenez, non contents de forcer les gens √† acheter un nouveau t√©l√©phone en pr√©tendant que c&rsquo;est le seul moyen possible pour avoir la derni√®re version d&rsquo;Android, en plus ils pipeautent sur le suivi de s√©curit√© essentiel qu&rsquo;on leur demande de faire. Et Huawei ne serait ni le meilleur √©l√®ve ni le pire en la mati√®re.</p>
<p style="text-align: justify;"><a href="https://blog.seboss666.info/wp-content/uploads/2020/11/screenshot_p20_updates_november.jpg" rel="lightbox[6237]"><img class="aligncenter size-medium wp-image-6445" src="https://blog.seboss666.info/wp-content/uploads/2020/11/screenshot_p20_updates_november-142x300.jpg" alt="" width="142" height="300" srcset="https://blog.seboss666.info/wp-content/uploads/2020/11/screenshot_p20_updates_november-142x300.jpg 142w, https://blog.seboss666.info/wp-content/uploads/2020/11/screenshot_p20_updates_november-768x1621.jpg 768w, https://blog.seboss666.info/wp-content/uploads/2020/11/screenshot_p20_updates_november-485x1024.jpg 485w, https://blog.seboss666.info/wp-content/uploads/2020/11/screenshot_p20_updates_november.jpg 1080w" sizes="(max-width: 142px) 100vw, 142px" /></a>Mise √† jour d√©ploy√©e d√©but novembre. Donc deux mois de retard sur les patches de s√©cu Android. On va se consoler en se disant que √ßa fait plus de deux ans et que c&rsquo;est d√©j√† bien d&rsquo;en avoir encore ? Alors qu&rsquo;un Microsoft continue encore de fournir des mises √† jour pour Windows 8.1 sorti&#8230; en 2013, et qui sera maintenu jusqu&rsquo;en 2023. Voil√†&#8230;</p>
<p style="text-align: justify;">Par contre c&rsquo;est p√©nible, √† l&rsquo;instar d&rsquo;un Windows 10 qu&rsquo;il est toujours compliqu√© de mater, il vous reboot dans la nuit pour appliquer les mises √† jour sans vous demander la permission. Heureusement que le r√©veil est fonctionnel √† ce moment-l√† parce que ce n&rsquo;est plus le cas de la connexion mobile qui attend le code de d√©verrouillage de la carte SIM. Imaginez un t√©l√©phone d&rsquo;astreinte qui vous fait √ßa en pleine nuit&#8230;</p>
<h3 style="text-align: justify;">Alors, le rempla√ßant ?</h3>
<p style="text-align: justify;">Forc√©ment je me pose la question. Pas pour tout de suite, la situation mondiale actuelle ne donne pas envie de d√©penser inutilement de l&rsquo;argent. Malgr√© la fin act√©e des mises √† jour de l&rsquo;OS, le reste va continuer de fonctionner, et finalement, les vraies failles syst√®mes exploitables demandent d&rsquo;abord d&rsquo;attaquer les couches sup√©rieures, qui elles sont encore mises √† jour (Google Play Services, applications). Le mat√©riel √©tant encore en tr√®s bon √©tat, pas la peine de nourrir la montagne de d√©chets √©lectroniques. Cette remarque est d&rsquo;ailleurs √† garder, on pourrait s&rsquo;orienter vers un smartphone d&rsquo;occasion, de moins d&rsquo;un an id√©alement, qui aura un support complet de LineageOS ? On pourrait r√™ver, mais qui sait&#8230;</p>
<p style="text-align: justify;">Le fait est qu&rsquo;il faudra bien √† un moment donn√© se pencher s√©rieusement sur le probl√®me. Entre la base m√™me de l&rsquo;OS qui est toujours plus attach√©e √† son initiateur, Google, les constructeurs qui continuent de faire des mod√®les jetables sous pr√©texte officiel d&rsquo;√©conomies de fabrication (mais pas de prix d&rsquo;achat hein, faut pas d√©conner), sans parler de leurs saloperies de surcouches et applications maison qui sont l√† juste pour vous espionner un peu plus (Xiaomi √©tant le dernier en date √† s&rsquo;√™tre fait prendre <a href="https://www.frandroid.com/marques/xiaomi/706441_quand-la-collecte-de-donnees-fait-tache-sur-les-smartphones-xiaomi-abusive-non-anonymisee-et-mal-chiffree" target="_blank" rel="noopener">la main dans le pot de confiture</a>), √ßa devient compliqu√© de trouver une plateforme qui ne soit pas con√ßue dans un but malveillant, et surtout sur laquelle on ne VEUT pas que vous ayez le contr√¥le.</p>
<p style="text-align: justify;">Alors que c&rsquo;est toujours plus vital √† mesure que le monde ouvert d&rsquo;Internet menace toujours plus de s&rsquo;√©crouler face √† ces requins&#8230;</p>
]]></content:encoded>
            <wfw:commentRss>https://blog.seboss666.info/2020/11/huawei-p20-lite-deux-ans-apres/feed/</wfw:commentRss>
            <slash:comments>0</slash:comments>
        </item>
        <item>
            <title>O√π en est le blog ?</title>
            <link>https://blog.seboss666.info/2020/11/ou-en-est-le-blog/</link>
            <comments>https://blog.seboss666.info/2020/11/ou-en-est-le-blog/#respond</comments>
            <pubDate>Mon, 02 Nov 2020 17:00:43 +0000</pubDate>
            <dc:creator><![CDATA[Seboss666]]></dc:creator>
            <category><![CDATA[Editos]]></category>
            <category><![CDATA[chantier]]></category>
            <category><![CDATA[d√©m√©nagement]]></category>
            <category><![CDATA[fibre]]></category>
            <category><![CDATA[motivation]]></category>
            <category><![CDATA[plugins]]></category>
            <category><![CDATA[ravalement]]></category>
            <category><![CDATA[temps]]></category>
            <category><![CDATA[wordpress]]></category>

            <guid isPermaLink="false">https://blog.seboss666.info/?p=6439</guid>
            <description><![CDATA[Eh ouais, √ßa fait un bout de temps que j&#8217;ai pas fait d&#8217;articles, et les 38 brouillons avancent tellement au ralenti que je ne sais [...]]]></description>
            <content:encoded><![CDATA[<p style="text-align: justify;">Eh ouais, √ßa fait un bout de temps que j&rsquo;ai pas fait d&rsquo;articles, et les 38 brouillons avancent tellement au ralenti que je ne sais pas trop lequel sortira en premier, certains d√©pendant d&rsquo;abord de la sortie d&rsquo;autres, etc&#8230; Mais y&rsquo;a pas mal de facteurs et j&rsquo;aimerai faire un point rapide pour vous dire ce qui viendra dans un futur plus ou moins proche.</p>
<p style="text-align: justify;"><span id="more-6439"></span></p>
<h3 style="text-align: justify;">Le temps</h3>
<p style="text-align: justify;">Eh oui, c&rsquo;est le plus global des probl√®mes, ce blog est tenu sur le temps ¬´¬†libre¬†¬ª, et du temps libre, je n&rsquo;en alloue pratiquement pas ces derniers temps. Je continue de faire la stricte maintenance n√©cessaire, qui ne sera bient√¥t plus suffisante, mais j&rsquo;y reviendrai, et c&rsquo;est √† peu pr√®s tout.</p>
<p style="text-align: justify;">Le fait est que les journ√©es sont charg√©es, et m√™me si le transport a √©t√© pratiquement √©limin√© de mon temps de mon temps allou√© au travail, ce qui va donc perdurer avec l&rsquo;annonce de ce deuxi√®me confinement, je passe beaucoup de temps sur ma veille techno orient√©e boulot. Et en ce moment je suis aussi dans une phase de rattrapage de jeux que j&rsquo;ai laiss√© de c√¥t√©, je viens de terminer Assassin&rsquo;s Creed Origins apr√®s 82h de jeu, et il y en a d&rsquo;autres qui suivront certainement avec pour certains le meÃÇme genre de temps pass√© (99h sur Horizon Zero Dawn, vraiment fa√Ætes ce jeu c&rsquo;est un bonheur).</p>
<div id="attachment_6441" style="width: 310px" class="wp-caption aligncenter"><a href="https://blog.seboss666.info/wp-content/uploads/2020/11/assassins_creed_origins_time_spent.jpg" rel="lightbox[6439]"><img class="size-medium wp-image-6441" src="https://blog.seboss666.info/wp-content/uploads/2020/11/assassins_creed_origins_time_spent-300x225.jpg" alt="" width="300" height="225" srcset="https://blog.seboss666.info/wp-content/uploads/2020/11/assassins_creed_origins_time_spent-300x225.jpg 300w, https://blog.seboss666.info/wp-content/uploads/2020/11/assassins_creed_origins_time_spent-768x576.jpg 768w, https://blog.seboss666.info/wp-content/uploads/2020/11/assassins_creed_origins_time_spent-1024x768.jpg 1024w" sizes="(max-width: 300px) 100vw, 300px" /></a><p class="wp-caption-text">Je vous mens pas hein <img src="https://s.w.org/images/core/emoji/11/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p></div>
<p style="text-align: justify;">Il n&rsquo;y a pas que le blog qui en p√¢tit, j&rsquo;ai deux/trois bouquins qu&rsquo;il faut que je d√©pile aussi. Et pour l&rsquo;instant, je vois pas trop comment √ßa √©voluerait dans un sens ou l&rsquo;autre. Il faut dire que m√™me en faisant des pr√©dictions sur trois semaines, on se fait couper la chique par un gouvernement en roue libre dans un pays qui semble tourner au d√©sastre intellectuel et √©conomique (m√™me si on est encore loin du Liban&#8230;), et c&rsquo;est compliqu√© d&rsquo;en faire abstraction.</p>
<h3 style="text-align: justify;">La refonte/upgrade du WordPress</h3>
<p style="text-align: justify;">Il n&rsquo;y a quand m√™me pas ¬´¬†rien¬†¬ª. En effet, apr√®s avoir abandonn√© l&rsquo;environnement docker pour les exp√©rimentations sur le blog (trop contraignant pour un truc qu&rsquo;on bidouille toutes les deux minutes), j&rsquo;ai remont√© une copie du blog √† c√¥t√© de celui-ci pour m&rsquo;atteler √† quelques chantiers. Je ne vais pas avoir le choix, tant que je reste sur WordPress, il faut que je passe aux branches 5.x pour la s√©curit√©; mais non, d√©finitivement, apr√®s 1h d&rsquo;essais, l&rsquo;√©diteur Gutemberg est juste une r√©gression monumentale qui n&rsquo;a √©t√© con√ßue que pour plaire √† ceux qui devraient utiliser un autre moteur de site pour faire leurs publications pourries. Pour l&rsquo;instant on a encore le <a href="https://wordpress.org/plugins/classic-editor/" target="_blank" rel="noopener">Classic Editor</a>, mais il y a d&rsquo;autres probl√®mes qui d√©coulent de cette mise √† jour.</p>
<p style="text-align: justify;">Eh oui, j&rsquo;ai un souci soit d√©j√† pr√©sent, soit sp√©cifique √† WP5, avec quelques extensions. On m&rsquo;a remont√© d√©j√† y&rsquo;a un moment que le plugin pour la gestion des boutons de partage sur les r√©seaux sociaux ne fonctionnaient plus, et c&rsquo;est vrai, la partie du code PHP qui devrait √™tre interpr√©t√©e ne fonctionne plus, et comme je passais par une extension particuli√®rement g√©n√©rique pour faire pour √ßa, j&rsquo;imagine que c&rsquo;est li√© √† une s√©curit√© suppl√©mentaire au niveau de WordPress. C&rsquo;est pas un mal, mais du coup je dois revoir la copie. Autre souci, celui du partage automatique sur les r√©seaux sociaux. J&rsquo;utilisais jusque-l√† Microblog Poster, mais il est d√©finitivement abandonn√© et apparemment le d√©veloppeur, sans retirer son travail devenu inutile, semble peu enclin √† faire son travail de support ne serait-ce que pour dire que c&rsquo;est plus la peine. Pire, la page pour acheter la version entreprise est toujours en ligne, on est donc d√©sormais tomb√© dans l&rsquo;arnaque la plus flagrante. Le passage √† WP5 fait aussi grimper la version de WpDiscuz, et cette nouvelle version me laisse pour le moins perplexe, j&rsquo;ai l&rsquo;impression que la seule forme d&rsquo;antispam restante est cette saloperie de reCaptcha de Google, sans g√™ne, ce qui ne m&rsquo;arrange pas le moins du monde. J&rsquo;ai aussi eu des soucis avec certaines fonctions que j&rsquo;avais int√©gr√©es au th√®me et qui font planter le blog, par exemple la suppression des query strings, et le defer pour le JavaScript fait mal aussi.</p>
<p style="text-align: justify;">Aussi, √ßa fait maintenant longtemps que j&rsquo;ai le m√™me th√®me, et je cherche √† le changer pour quelque chose de plus a√©r√©. Mais j&rsquo;aimerai toutefois pouvoir r√©-inclure de mani√®re √©l√©gante un bouton de soutien √† une association, j&rsquo;ai fini par retirer celui de la Quadrature apr√®s leurs derni√®res pitreries. La gestion des √©crans tr√®s larges est encore trop absentes, il est vrai qu&rsquo;avec un Google qui vous tanne pour que votre site soit optimis√© pour mobile, c&rsquo;est un peu contre-intuitif. Mais voir 60% de son espace d&rsquo;affichage inutilis√© c&rsquo;est juste une honte. Et parce que je dois l&rsquo;avouer c&rsquo;est un mode qui me plait, je r√©fl√©chis √† un th√®me sombre. Et pour l&rsquo;instant je trouve rien qui me plait vraiment, je suis aussi noy√© sous la masse des th√®mes ¬´¬†Freemium¬†¬ª ce qui me gonfle parce que la fronti√®re entre la promesse et la r√©alit√© gratuite n&rsquo;est jamais claire, et j&rsquo;y passe d√©j√† trop peu de temps pour en plus cramer du cash dans un th√®me √† la dur√©e de vie pas forc√©ment plus importante. J&rsquo;exclus pas du coup de reporter ce point du th√®me pour une prochaine fois et livrer les √©volutions du blog sous-jacentes, on le voit ces tests d&rsquo;√©volution prennent un temps non n√©gligeable sur celui que je peux allouer au blog il va falloir donc trancher.</p>
<h3 style="text-align: justify;">Les articles, leur vie, leur mort</h3>
<p style="text-align: justify;">Avec un tel d√©lai dans l&rsquo;√©criture et le peaufinage des articles, et des exp√©rimentations qui vont souvent avec, il y a des d√©g√¢ts. Je viens de voir repasser un tweet ¬´¬†teaser¬†¬ª ou je parlais de lib√©ration de routeur. Le Netgear a √©t√© salement briqu√© au premier essai et je n&rsquo;ai jamais r√©ussi √† reprendre la main. L&rsquo;autre routeur a du √™tre remis en service en urgence lors de mon s√©jour prolong√© chez ma m√®re suite au d√©calage de plus de deux mois de son op√©ration du dos. T√©l√©travail c&rsquo;est bien, avec du r√©seau fiable c&rsquo;est mieux. Je suis rentr√© chez moi mais maintenant le routeur n&rsquo;est plus disponible donc ce ¬´¬†projet¬†¬ª tombe √† l&rsquo;eau.</p>
<p style="text-align: justify;">J&rsquo;avais dans les cartons la mise en place du Freebox Exporter pour Prometheus, sauf que j&rsquo;ai r√©install√© le serveur from scratch dans l&rsquo;urgence √† l&rsquo;occasion d&rsquo;un aller-retour √©clair chez moi pendant le confinement, j&rsquo;avais bien commenc√© l&rsquo;√©criture, et j&rsquo;ai r√©install√© aussi les VMs from scratch donc j&rsquo;ai rien gard√©. Et comme je n&rsquo;ai plus de Freebox en place, √ßa tombe √† l&rsquo;eau. C&rsquo;est pas la box rempla√ßante qui fera honneur, car je suis pass√© √† la fibre chez Sosh, et √ßa je vais vous en parler dans pas super longtemps parce qu&rsquo;on est sur une prestation √† peine moins honteuse <a href="https://blog.seboss666.info/2019/02/la-fibre-chez-ma-mere-chapitre-3-on-tente-de-prendre-le-controle-du-reseau/" target="_blank" rel="noopener">que chez NordNet</a>.</p>
<p style="text-align: justify;">Je vous ai parl√© <a href="https://blog.seboss666.info/2020/08/de-docker-swarm-a-kubernetes-avec-k3s/" target="_blank" rel="noopener">du cluster K3s</a> et j&rsquo;ai potentiellement des trucs √† vous en redire, mais pour l&rsquo;instant, je suis coinc√© dans son ¬´¬†remplissage¬†¬ª par la gestion des backups. En effet, ce couillon de NAS Asustor ne sait pas supporter NFSv4, donc pas de gestion via le backup natif de Longhorn, pas sans faire de sales bidouilles. J&rsquo;√©tudie les alternatives mais je suis aussi coinc√© par les ressources mat√©rielles du serveur qui m&#8217;emp√™chent un peu de d√©ployer plus de VMs. Et les bonnes options de machines sous AMD en passif se font attendre. Le brouillon d&rsquo;article que j&rsquo;avais commenc√© qui parle de cette √©volution mat√©rielle vient d&rsquo;ailleurs de souffler sa premi√®re bougie&#8230;</p>
<h3 style="text-align: justify;">Le d√©m√©nagement de l&rsquo;infra</h3>
<p style="text-align: justify;">Ah oui y&rsquo;a √ßa aussi, il est vraiment plus que temps que je d√©m√©nage le site, Debian 8 c&rsquo;est vraiment la fin cette fois, m√™me en ayant <a href="https://blog.seboss666.info/2020/06/un-peu-damour-pour-le-blog-et-la-vm-en-general/" target="_blank" rel="noopener">fait ce que je pouvais</a> pour corriger certaines tares; il est surtout temps que le serveur physique qui va sur ses huit ans prenne sa retraite (il ira grossir les rangs de l&rsquo;offre SYS d&rsquo;OVH, sachez-le leurs serveurs sont d√©j√† des retrait√©s). Et vu les niveaux de prix et la ¬´¬†fra√Æcheur¬†¬ª du mat√©riel, je pense qu&rsquo;OVH ne sera pas l&rsquo;heureux √©lu du prochain h√©bergement. Tout √ßa aussi va prendre du temps qu&rsquo;il faudra trouver, mais possible que je parte chez Hetzner. J&rsquo;ai d√©j√† fait une petite v√©rification √ßa pourra induire un poil de latence suppl√©mentaire (genre une dizaine de millisecondes), parce que ce n&rsquo;est pas en France et que nos op√©rateurs pr√©f√©reraient qu&rsquo;on fasse pas de l&rsquo;Internet chez eux, mais bon, pour avoir du mat√©riel r√©cent, et de l&rsquo;AMD par dessus le march√©, sans que √ßa co√ªte deux fois le prix que je paie actuellement, pas le choix.</p>
<p style="text-align: justify;">Ben oui, j&rsquo;ai beau √™tre pass√© √† la fibre, pour certains √©l√©ments je n&rsquo;ai aucun int√©r√™t √† h√©berger √ßa directement chez moi, parce que pouvoir r√©parer 24/7, ce n&rsquo;est pas une option et chez moi, m√™me confin√© c&rsquo;est impossible. Comme il y a des gens dont c&rsquo;est le m√©tier, autant leur faire confiance <img src="https://s.w.org/images/core/emoji/11/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<h3 style="text-align: justify;">Stay Tuned, comme ils disent&#8230;</h3>
<p style="text-align: justify;">Donc voil√† une partie des raisons pour lesquelles il n&rsquo;y a plus trop de bruit ici en ce moment. La b√™te n&rsquo;est tout de m√™me pas encore morte, et il va falloir que je me r√©organise un peu pour allouer quand m√™me un peu plus de temps √† vous partager les quelques rares trucs qui m&rsquo;ont int√©ress√©, sur lesquels j&rsquo;ai boss√©, ou que je compte faire sous un angle qui ne soit pas d√©j√† vu et revu. En √©tant quatre mois √† la bourre derri√®re mes confr√®res, s√ªr que c&rsquo;est pas toujours √©vident&#8230;</p>
<p><a href="https://blog.seboss666.info/wp-content/uploads/2020/11/t2_thumbs_up.jpg" rel="lightbox[6439]"><img class="aligncenter size-medium wp-image-6442" src="https://blog.seboss666.info/wp-content/uploads/2020/11/t2_thumbs_up-300x128.jpg" alt="" width="300" height="128" srcset="https://blog.seboss666.info/wp-content/uploads/2020/11/t2_thumbs_up-300x128.jpg 300w, https://blog.seboss666.info/wp-content/uploads/2020/11/t2_thumbs_up.jpg 590w" sizes="(max-width: 300px) 100vw, 300px" /></a></p>
]]></content:encoded>
            <wfw:commentRss>https://blog.seboss666.info/2020/11/ou-en-est-le-blog/feed/</wfw:commentRss>
            <slash:comments>0</slash:comments>
        </item>
        <item>
            <title>R√©soudre les probl√®mes de Microsoft Teams avec KDE sous Linux</title>
            <link>https://blog.seboss666.info/2020/09/resoudre-les-problemes-de-microsoft-teams-avec-kde-sous-linux/</link>
            <comments>https://blog.seboss666.info/2020/09/resoudre-les-problemes-de-microsoft-teams-avec-kde-sous-linux/#comments</comments>
            <pubDate>Wed, 09 Sep 2020 16:00:30 +0000</pubDate>
            <dc:creator><![CDATA[Seboss666]]></dc:creator>
            <category><![CDATA[Astuces]]></category>
            <category><![CDATA[Humeur]]></category>
            <category><![CDATA[bug]]></category>
            <category><![CDATA[KDE]]></category>
            <category><![CDATA[linux]]></category>
            <category><![CDATA[microsoft]]></category>
            <category><![CDATA[noyau]]></category>
            <category><![CDATA[opengl]]></category>
            <category><![CDATA[team]]></category>
            <category><![CDATA[vid√©o]]></category>
            <category><![CDATA[xrender]]></category>

            <guid isPermaLink="false">https://blog.seboss666.info/?p=6289</guid>
            <description><![CDATA[Microsoft a mis √† disposition il y a plusieurs mois d√©j√† son client Teams pour les linuxiens. Il est tr√®s proche fonctionnellement de la version [...]]]></description>
            <content:encoded><![CDATA[<p style="text-align: justify;">Microsoft a mis √† disposition il y a plusieurs mois d√©j√† son client Teams pour les linuxiens. Il est tr√®s proche fonctionnellement de la version Windows, avec aussi peu de r√©glages que son homologue, et son statut de preview fait qu&rsquo;il est souvent √† la bourre sur les toutes derni√®res √©volutions introduites dans le client. Il a aussi d&rsquo;autres probl√®mes qui d√©pendent de l&rsquo;environnement de bureau dans lequel vous tournez, et √ßa a √©t√© mon cas avec KDE.</p>
<p style="text-align: justify;"><span id="more-6289"></span></p>
<h3 style="text-align: justify;">KDE mon amour (je l&rsquo;ai d√©j√† faite, non ?)</h3>
<p style="text-align: justify;">KDE, c&rsquo;est l&rsquo;environnement qu&rsquo;on dit sympa pour les nouveaux utilisateurs parce que proche de Windows. Alors les gens qui disent √ßa n&rsquo;ont soit pas vu un Windows depuis longtemps, soit jamais utilis√© KDE non plus. Parce que l&rsquo;environnement qui repose sur le toolkit graphique Qt est un bordel sans nom tellement il est configurable dans tous les sens. J&rsquo;en utilise moi-m√™me probablement qu&rsquo;un petit tiers des capacit√©s, et ce nombre est probablement surestim√©.</p>
<p style="text-align: justify;">Je l&rsquo;ai quand m√™me s√©lectionn√© quand j&rsquo;ai bascul√© mon laptop pro sous Linux, <a href="https://blog.seboss666.info/2019/09/les-challenges-quand-on-vire-windows-de-son-pc-de-boulot/" target="_blank" rel="noopener">j&rsquo;en avais parl√©</a>, parce que maintenant que la g√©n√©ration 5 avait matur√©, je me suis dit que √ßa serait suffisamment stable et je voulais voir ce qu&rsquo;ils en avaient fait apr√®s avoir appr√©ci√© la version 4. Globalement, c&rsquo;est fluide, en fonction des th√®mes c&rsquo;est visuellement proche d&rsquo;un Windows mais avec quelques sp√©cificit√©s parce que bon sinon √ßa serait pas KDE (pour ceux qui veulent vraiment mimer y&rsquo;a l&rsquo;incognito mode de Kali :D). C&rsquo;est un environnement plaisant dont j&rsquo;ai pu modifier les aspects que je voulais pour le rendre plus fluide pour mes besoins, et c&rsquo;est finalement ce qu&rsquo;on demande en priorit√© √† son environnement de bureau.</p>
<p style="text-align: justify;">Malgr√© tout, sur le Latitude 5470 j&rsquo;ai quand m√™me eu quelques gal√®res. La consommation m√©moire est d√©j√† un peu √©lev√©e, genre 800Mo √† froid, sans rien de charg√©. Ensuite, en fonction des mises √† jour j&rsquo;ai d√©j√† eu des soucis avec des freezes de l&rsquo;√©cran de verrouillage. Comprenez que l&rsquo;image est fig√©e √† l&rsquo;√©cran, mais la souris bouge, et si on saisit le mot de passe au clavier, √ßa fonctionne, juste on ne le voit pas. Et √ßa, aussi bien sur le noyau d&rsquo;origine √† l&rsquo;installation (4.19 LTS) que celui que j&rsquo;ai s√©lectionn√© apr√®s, le 5.4 LTS. La solution √©tait de rebasculer sur un TTY, et de revenir sur la session graphique pour qu&rsquo;il reprenne le dessin. Bizarre autant qu&rsquo;√©trange, mais c&rsquo;√©tait limit√© au login screen.</p>
<p style="text-align: justify;">J&rsquo;ai quand m√™me pris un peu de temps pour chercher un peu. Kwin, qui est le composant responsable du dessin de tout √ßa, et qu&rsquo;on appelle √† juste titre compositeur de fen√™tres, dispose lui-m√™me, √† l&rsquo;image du reste de l&rsquo;environnement, de pas mal de r√©glages, sur les effets, et aussi sur un point important, le mode de rendu. Chez moi, et je n&rsquo;ai aucune id√©e de pourquoi, le mode de rendu s√©lectionn√© √©tait OpenGL 2, alors que le pilote et le GPU int√©gr√© supportent, au moins sous Linux, OpenGL 3.3+ depuis la g√©n√©ration Haswell, c&rsquo;√©tait en 2014. V√©rification faite, depuis cet √©t√© Intel a valid√© OpenGL 4.6 pour tout ce qui est Broadwell+, ce qui est le cas de Skylake. Et dans les options propos√©es, je n&rsquo;ai qu&rsquo;un OpenGL 3.1. J&rsquo;ai donc tent√© le coup, c&rsquo;est plus stable effectivement, mais rien de r√©volutionnaire sur la consommation CPU ou RAM. Moins de bug, c&rsquo;est toujours √ßa.</p>
<p></p><pre class="crayon-plain-tag">$ glxinfo
(...)
OpenGL vendor string: Intel
OpenGL renderer string: Mesa Intel(R) HD Graphics 520 (SKL GT2)
OpenGL core profile version string: 4.6 (Core Profile) Mesa 20.0.7
OpenGL core profile shading language version string: 4.60
OpenGL core profile context flags: (none)
OpenGL core profile profile mask: core profile
(...)</pre><p></p>
<p style="text-align: justify;">√áa n&#8217;emp√™che pas de temps en temps d&rsquo;avoir un √©norme message d&rsquo;erreur sur fond noir me disant qu&rsquo;il faut d√©verrouiller la session via la ligne de commande dans un TTY justement, ceci dit c&rsquo;est assez rare pour ne pas poser plus de probl√®me que √ßa.</p>
<h3 style="text-align: justify;">Tu voulais pas nous parler de Teams ?</h3>
<p style="text-align: justify;">Alors pourquoi je m&rsquo;attarde sur tout √ßa ? D√©j√† pour dire que l&rsquo;environnement sur lequel il s&rsquo;ex√©cute a d√©j√† quelques soucis graphiques av√©r√©s au moins par le pass√©. Ensuite parce qu&rsquo;√©videmment, avec une utilisation toujours plus pouss√©e de Teams voire m√™me une utilisation exclusive depuis quelques mois maintenant, je ne peux pas me permettre d&rsquo;avoir un outil non fonctionnel. Certains √©l√©ments ne d√©pendent pas de moi, comme la t√©l√©phonie, dont la proc√©dure de migration que j&rsquo;ai pu lire me donne encore des migraines tellement elle est complexe par rapport aux tests du d√©but qui fonctionnaient bien mais qui, selon Microsoft, posaient ¬´¬†des probl√®mes de s√©curit√©¬†¬ª. Pour d&rsquo;autres c&rsquo;est li√© √† mon PC et lui seul, donc autant chercher √† agir.</p>
<p style="text-align: justify;">En dehors d&rsquo;une consommation CPU et RAM d√©mesur√©e qui est r√©guli√®rement point√©e du doigt et qui ne semble pas la priorit√© de Microsoft (ajouter les fonds custom sur les visio et les grilles 3&#215;3 ¬´¬†√† la Zoom¬†¬ª, c&rsquo;est tellement plus important), le principal probl√®me que j&rsquo;ai rencontr√© est pratiquement impossible √† capturer et visible uniquement par mes interlocuteurs : le partage d&rsquo;√©cran ¬´¬†clignote¬†¬ª, et on voit r√©guli√®rement des bouts de fonds d&rsquo;√©cran par dessus les fen√™tres, ce qui est particuli√®rement d√©sagr√©able pour eux. Au d√©but justement je pensais que c&rsquo;√©tait d√ª √† l&rsquo;OpenGL 2, mais le passage √† OpenGL 3.1 n&rsquo;a rien r√©gl√©. Je me suis dit que j&rsquo;√©tais maudit, j&rsquo;ai repens√© au fait qu&rsquo;Electron, qui est le framework applicatif utilis√© pour d√©velopper Teams, repose sur Chromium, qui n&rsquo;utilise pas Qt mais GTK comme toolkit. Possible, apr√®s tout Pierre-Marie qui va me faire payer une taxe √† chaque fois que je le cite l&rsquo;utilise sans souci avec Cinnamon, m√™me si lui utilise la version non-officielle, donc la version d&rsquo;Electron pourrait jouer.</p>
<p style="text-align: justify;"><a href="https://blog.seboss666.info/wp-content/uploads/2020/09/kde_render_mode.png" rel="lightbox[6289]"><img class="aligncenter size-medium wp-image-6405" src="https://blog.seboss666.info/wp-content/uploads/2020/09/kde_render_mode-300x178.png" alt="" width="300" height="178" srcset="https://blog.seboss666.info/wp-content/uploads/2020/09/kde_render_mode-300x178.png 300w, https://blog.seboss666.info/wp-content/uploads/2020/09/kde_render_mode-768x454.png 768w, https://blog.seboss666.info/wp-content/uploads/2020/09/kde_render_mode-1024x606.png 1024w, https://blog.seboss666.info/wp-content/uploads/2020/09/kde_render_mode.png 1232w" sizes="(max-width: 300px) 100vw, 300px" /></a>Au passage dans les recherches, je vois que la consommation CPU peut √™tre un peu r√©duite en d√©sactivant l&rsquo;acc√©l√©ration mat√©rielle. Me demandez pas pourquoi mais c&rsquo;est vrai, j&rsquo;ai d√©coch√© l&rsquo;acc√©l√©ration mat√©rielle, red√©marr√© l&rsquo;application et √ßa va un peu mieux. √áa reste toujours Bagdad sur le Core i5 en conf√©rence audio/vid√©o, mais bon, le reste du temps, c&rsquo;est √† dire au ¬´¬†repos¬†¬ª il est beaucoup plus calme. Mais rien de mieux sur le partage d&rsquo;√©cran qui clignote toujours. Et en continuant de chercher, je finis par retomber sur cette histoire de mode de rendu.</p>
<p style="text-align: justify;">En effet, j&rsquo;ai √©voqu√© diff√©rentes versions d&rsquo;OpenGL, mais il existe une derni√®re option pour Kwin qui s&rsquo;appelle <a href="https://en.wikipedia.org/wiki/X_Rendering_Extension" target="_blank" rel="noopener">Xrender</a>. Ce mode de rendu historique remonte √† 2001 et d√©j√† √† l&rsquo;√©poque permettait d&rsquo;exploiter les capacit√©s d&rsquo;acc√©l√©ration des cartes graphiques pour s&rsquo;occuper d&rsquo;un ou plusieurs aspects de l&rsquo;environnement de bureau. Il est toujours support√© sur les installations r√©centes qui reposent encore sur X.org, et c&rsquo;est mon cas. Certains semblent avoir r√©ussi √† calmer les glitches du partage d&rsquo;√©cran avec, et comme je n&rsquo;avais aucune information sur le fait que √ßa pourrait faire mal au CPU et/ou √† la RAM, j&rsquo;ai tent√©.</p>
<p style="text-align: justify;">Eh ben devinez quoi, c&rsquo;est la solution ! Donc pour avoir Teams + KDE + x¬† = partage d&rsquo;√©cran, x = Xrender. J&rsquo;√©tais content, j&rsquo;allais pouvoir repartager mon √©cran facilement, c&rsquo;est d&rsquo;autant plus important en ces temps de t√©l√©travail continu.</p>
<h3 style="text-align: justify;">Le retour de la vengeance des bugs bizarre de KDE</h3>
<p style="text-align: justify;">Et oui, tel un <a href="https://fr.wikipedia.org/wiki/Jason_Voorhees" target="_blank" rel="noopener">Jason Voorhees</a> qu&rsquo;on croit mort et qui revient toujours, un nouveau bug encore plus √©trange est venu se mettre en travers de ma route : de mani√®re tr√®s al√©atoire, m√™me si je pensais √† un lien direct avec Teams, ce n&rsquo;est plus l&rsquo;√©cran de verrouillage qui freeze mais le bureau, carr√©ment ! Je peux encore basculer entre les fen√™tres avec Alt+Tab, mais plus question d&rsquo;utiliser le menu KDE ou la barre des t√¢ches. Et m√™me certaines fen√™tres finissent par un peu souffrir et freezer elles aussi. La solution trouv√©e sur un forum est de ¬´¬†tuer¬†¬ª plasmashell et de le relancer dans la foul√©e. Ce qui fonctionne, mais pour un temps plus ou moins limit√© avant de devoir recommencer.</p>
<p style="text-align: justify;">Retour donc dans les m√©andres de la recherche sur le web, pour d√©couvrir que cette fois-ci, c&rsquo;est la combinaison Xrender + noyau 5.14 qui semble probl√©matique, et que 4.19 permettra de retrouver sa stabilit√©. Au point o√π j&rsquo;en √©tais j&rsquo;ai tent√©. Et au bout d&rsquo;une semaine sans freeze avec moults partages d&rsquo;√©crans et sessions audio/vid√©o Teams, force est de constater que le r√©sultat est l√†. Le prix √† payer est que les noyaux plus r√©cents disposent d&rsquo;am√©liorations de performances et/ou d&rsquo;autonomie qui ne sont pas critiques non plus, surtout en ce moment o√π le laptop est constamment reli√© au secteur.</p>
<h3 style="text-align: justify;">Un possible basculement sur XFCE ?</h3>
<p style="text-align: justify;">Par rapport √† ce que j&rsquo;utilise de KDE, franchement je me pose la question. la version 4.14 a am√©lior√© son support GTK 3, qui est le toolkit sur lequel repose la majorit√© de mes applications en dehors de KeepassXC et VLC. Firefox, Thunderbird, LibreOffice, Sublime Text, Terminator, Teams, la liste n&rsquo;est pas compl√®te mais vous avez l&rsquo;id√©e. Le probl√®me, c&rsquo;est que pouvoir basculer dessus demande tellement de changements sur le syst√®me que je me demande comment je vais proc√©der, la r√©installation √©tant probablement le mieux.</p>
<p style="text-align: justify;">En attendant, j&rsquo;ai retrouv√© une stabilit√© n√©cessaire, ce qui une fois de plus nous montre bien que non, ¬´¬†Linux¬†¬ª c&rsquo;est pas pour tout le monde, quelque soit la qualit√© du mat√©riel.</p>
<hr />
<p style="text-align: justify;">PS : j&rsquo;ai √©crit cet article au mois de mai, il se trouve qu&rsquo;entre temps, j&rsquo;ai d√©couvert une cons√©quence malencontreuse, √† savoir que docker est cass√© dans ce contexte, depuis la derni√®re mise √† jour de Docker il y a une r√©gression qui casse le dossier /var/run quand on tente un pull. Les d√©tails et malheureusement la solution inapplicable dans mon cas sont <a href="https://github.com/moby/moby/issues/40008" target="_blank" rel="noopener">√† consulter dans cette issue</a>. Une raison de plus pour passer sur container dockerless ?</p>
]]></content:encoded>
            <wfw:commentRss>https://blog.seboss666.info/2020/09/resoudre-les-problemes-de-microsoft-teams-avec-kde-sous-linux/feed/</wfw:commentRss>
            <slash:comments>1</slash:comments>
        </item>
        <item>
            <title>Quelques astuces diverses, dix-neuvi√®me</title>
            <link>https://blog.seboss666.info/2020/09/quelques-astuces-diverses-dix-neuvieme/</link>
            <comments>https://blog.seboss666.info/2020/09/quelques-astuces-diverses-dix-neuvieme/#comments</comments>
            <pubDate>Sun, 06 Sep 2020 10:00:44 +0000</pubDate>
            <dc:creator><![CDATA[Seboss666]]></dc:creator>
            <category><![CDATA[Astuces diverses]]></category>
            <category><![CDATA[alpine]]></category>
            <category><![CDATA[AUR]]></category>
            <category><![CDATA[docker]]></category>
            <category><![CDATA[git]]></category>
            <category><![CDATA[ic√¥nes]]></category>
            <category><![CDATA[outlook]]></category>
            <category><![CDATA[terraform]]></category>
            <category><![CDATA[thunderbird]]></category>
            <category><![CDATA[Ubuntu]]></category>
            <category><![CDATA[wifi]]></category>
            <category><![CDATA[youtube-dl]]></category>
            <category><![CDATA[zstd]]></category>

            <guid isPermaLink="false">https://blog.seboss666.info/?p=6232</guid>
            <description><![CDATA[√áa faisait un bail en plus que je n&#8217;avais plus propos√© de pot pourri de bidouilles directes et vari√©es. C&#8217;est pas faute de bricoler, faut [...]]]></description>
            <content:encoded><![CDATA[<p style="text-align: justify;">√áa faisait un bail en plus que je n&rsquo;avais plus propos√© de pot pourri de bidouilles directes et vari√©es. C&rsquo;est pas faute de bricoler, faut juste trouver le temps d&rsquo;avoir des choses utiles/int√©ressantes √† proposer <img src="https://s.w.org/images/core/emoji/11/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;" /><span id="more-6232"></span></p>
<h3 style="text-align: justify;">D√©sactiver le motd pourri d&rsquo;Ubuntu Server</h3>
<p style="text-align: justify;">J&rsquo;ai appris qu&rsquo;une Ubuntu pouvait s&rsquo;amuser √† aller chercher des infos √† l&rsquo;ext√©rieur, et surtout en transmettre, pour vous afficher un message de bienvenue √† la connexion SSH. C&rsquo;est sale, mais fort heureusement, il y a moyen de le d√©sactiver, il faut modifier le fichier <span style="font-family: courier new, courier, monospace;">/etc/default/motd-news</span> :</p>
<p></p><pre class="crayon-plain-tag"># Enable/disable the dynamic MOTD news service
# This is a useful way to provide dynamic, informative
# information pertinent to the users and administrators
# of the local system
ENABLED=0</pre><p></p>
<p style="text-align: justify;">On l&rsquo;aura compris, c&rsquo;est le <span style="font-family: courier new, courier, monospace;">ENABLED=0</span> qui fait le taf. (<a href="https://ma.ttias.be/what-exactly-being-sent-ubuntu-motd/" target="_blank" rel="noopener">source</a>)</p>
<h3 style="text-align: justify;">youtube-dl, youtube, erreur 403</h3>
<p style="text-align: justify;">Alors que sur certaines vid√©os je n&rsquo;ai aucun probl√®me avec youtube-dl, il arrive de temps en temps que je prenne une belle erreur 403. Non pas que la vid√©o soit priv√©e (il sait me l&rsquo;afficher), mais c‚Äôest li√© √† un probl√®me avec le cache interne de youtube-dl.</p>
<p style="text-align: justify;">Pour le r√©initialiser, il suffit de relancer le t√©l√©chargement avec l&rsquo;option qui va bien :</p>
<p></p><pre class="crayon-plain-tag">$ youtube-dl -f 137+140 --rm-cache-dir https://www.youtube.com/watch?v=Og3JM8abqxI</pre><p></p>
<p style="text-align: justify;">Sinon, je vous conseille de chercher d&rsquo;abord dans <a href="https://github.com/ytdl-org/youtube-dl/issues" target="_blank" rel="noopener">les issues d√©j√† pr√©sentes</a> sur le d√©p√¥t Github avant de vous lancer dans un gros d√©bug m√©chant, la solution a de grandes chances d&rsquo;avoir d√©j√† √©t√© propos√©es.</p>
<h3 style="text-align: justify;">Icones Paper, Manjaro : AUR !</h3>
<p style="text-align: justify;">J&rsquo;ai eu des soucis avec des ic√¥nes qui ne s&rsquo;affichaient plus correctement. Il s&rsquo;av√®re que le paquet community ¬´¬†paper-icon-theme-git¬†¬ª n&rsquo;a pas l&rsquo;air tr√®s maintenu. Et il existe une version AUR avec exactement le m√™me nom (ce dont je ne suis pas fan, c&rsquo;est la f√™te aux conflits). Yay dispose cependant d&rsquo;un flag &lsquo;-a&rsquo; pour forcer l&rsquo;installation du paquet AUR plut√¥t que le paquet community :</p>
<p></p><pre class="crayon-plain-tag">$ yay -Ss paper-icon-theme
aur/paper-icon-theme 1.5.0-2 (+39 0.00%)
    Paper is an open source desktop theme and icon project by Sam Hewitt
aur/paper-icon-theme-git 805.8c7bf8d2-1 (+216 0.98%)
    Paper is an icon theme for GTK based desktops and fits perfectly the paper-gtk-theme
community/paper-icon-theme-git 746.04115106-1 (40.3 MiB 57.4 MiB)
    Paper is an icon theme for GTK based desktops and fits perfectly the paper-gtk-theme
 ~ ÓÇ∞ blog ÓÇ± images ÓÇ∞
$ yay -Sa paper-icon-theme-git
:: Checking for conflicts...
:: Checking for inner conflicts...
[Repo Make: 2]  ninja-1.10.0-1  meson-0.54.0-2
[Aur: 1]  paper-icon-theme-git-805.8c7bf8d2-1</pre><p></p>
<p style="text-align: justify;">Par la suite √ßa gueulera que le paquet local est plus r√©cent que le paquet distant, mais c&rsquo;est pas grave <img src="https://s.w.org/images/core/emoji/11/72x72/1f600.png" alt="üòÄ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<h3 style="text-align: justify;">Docker, Alpine, telnet sont dans un b√¢teau&#8230;</h3>
<p style="text-align: justify;">J&rsquo;avais besoin de faire un test rapide de connexion au SMTP Free depuis le container gitea, qui est bas√© sur alpine. Pour avoir √† disposition la commande telnet qui n&rsquo;es pas pr√©sente par d√©faut, il faut un petit paquet en plus :</p>
<p></p><pre class="crayon-plain-tag">/ # telnet smtp.free.fr 587
/bin/sh: telnet: not found
/ # apk add busybox-extras
fetch http://dl-cdn.alpinelinux.org/alpine/v3.11/main/x86_64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/v3.11/community/x86_64/APKINDEX.tar.gz
(1/1) Installing busybox-extras (1.31.1-r9)
Executing busybox-extras-1.31.1-r9.post-install
Executing busybox-1.31.1-r9.trigger
OK: 59 MiB in 71 packages
/ # busybox-extras telnet smtp.free.fr 587
Connected to smtp.free.fr
220 smtp2-g21.free.fr ESMTP Postfix
QUIT
221 2.0.0 Bye
Connection closed by foreign host
/ #</pre><p></p>
<h3 style="text-align: justify;">Cloner un d√©p√¥t git sans son historique</h3>
<p style="text-align: justify;">Coup de main d&rsquo;un coll√®gue de boulot qui migre nos Wiki vers un cluster OpenShift. Lors du build des images, il clone la source de mediawiki depuis Github, et constate que √ßa prend beaucoup trop de temps, et √† raison : le dossier fait 1 Go !!! Dans ce contexte, on a pas besoin de l&rsquo;historique complet de git, on peut donc contourner ce probl√®me avec l&rsquo;option <code>--depth</code> de git :</p>
<p></p><pre class="crayon-plain-tag">git clone --depth 1 https://github.com/wikimedia/mediawiki -b REL1_34</pre><p></p>
<p style="text-align: justify;">Comme √ßa on r√©cup√®re l&rsquo;arborescence de la branche/tag/ref qu&rsquo;on indique, sans tout l&rsquo;historique git qui va avec et qui est inutile dans l&rsquo;image Docker finale <img src="https://s.w.org/images/core/emoji/11/72x72/1f609.png" alt="üòâ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<h3 style="text-align: justify;">Thunderbird/Lightning : masquer les weekends</h3>
<p style="text-align: justify;">Je n&rsquo;utilise pas de calendrier perso, mais au boulot oui, mais par contre, contrairement √† Outlook, Lightning m&rsquo;affiche les semaines compl√®tes, ce qui ne m&rsquo;int√©resse pas puisque les weekend je ne travaille pas. Il est tout de m√™me possible de masquer ces weekends inutiles, mais c&rsquo;est pas intuitif. Il faut avoir le calendrier affich√©, ouvrir le menu, Affichage, Calendar, Current view, Workweek days only. Et voil√† <img src="https://s.w.org/images/core/emoji/11/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<h3><a href="https://blog.seboss666.info/wp-content/uploads/2020/09/tb_lightning_view.jpg" rel="lightbox[6232]"><img class="aligncenter size-medium wp-image-6397" src="https://blog.seboss666.info/wp-content/uploads/2020/09/tb_lightning_view-300x169.jpg" alt="" width="300" height="169" srcset="https://blog.seboss666.info/wp-content/uploads/2020/09/tb_lightning_view-300x169.jpg 300w, https://blog.seboss666.info/wp-content/uploads/2020/09/tb_lightning_view-768x432.jpg 768w, https://blog.seboss666.info/wp-content/uploads/2020/09/tb_lightning_view-1024x576.jpg 1024w" sizes="(max-width: 300px) 100vw, 300px" /></a>ArchLinux/Manjaro : paquets AUR au format Zstd</h3>
<p style="text-align: justify;">J&rsquo;ai d√©j√† parl√© du format Zstd et de ses avantages et inconv√©nients. ArchLinux et par cons√©quent Manjaro passent petit √† petit le format des paquets sur cet algo de compression. Mais au d√©tour d&rsquo;une lourde mise √† jour de Skype qu&rsquo;on installer par AUR, j&rsquo;ai vu que c&rsquo;√©tait toujours l&rsquo;efficace mais tr√®s lent xz qui √©tait toujours aux commandes. Pour corriger √ßa, direction le fichier /etc/makepkg.conf, et modifier les deux param√®tres :</p>
<p></p><pre class="crayon-plain-tag">#On change l'extension pour pr√©f√©rer le format
PKGEXT='.pkg.tar.zst'
#On change les options pour maximiser l'utilisation du processeur pour la compression
COMPRESSZST=(zstd -T0 -c -z -q -)</pre><p></p>
<h3 style="text-align: justify;">Convertir les fichiers .msg pour Thunderbird sous Linux</h3>
<p style="text-align: justify;">Microsoft et ses formats pourris binaires&#8230; Ayant √©t√© contraint d&rsquo;utiliser Outlook pendant quelques ann√©es, j&rsquo;ai gard√© quelques fichiers en local au format .msg, et il est encore fr√©quent d&rsquo;en trouver en pi√®ce jointe de certains messages. On s&rsquo;en doute, c&rsquo;est un format maison que ne comprennent pas les autres clients mails, Thunderbird en t√™te.</p>
<p style="text-align: justify;">Heureusement, il existe un petit utilitaire qui permet de convertir msg en eml, <a href="https://github.com/mvz/email-outlook-message-perl" target="_blank" rel="noopener">√©crit en perl</a>, un langage qui me r√©sistera toujours je pense, mais qui permet semble-t-il pas mal de choses. Installable sur Arch/Manjaro via AUR, s&rsquo;appelle aussi <a href="https://packages.debian.org/buster/libemail-outlook-message-perl" target="_blank" rel="noopener">libemail-outlook-message-perl</a> sous Debian/Ubuntu.</p>
<h3 style="text-align: justify;">Afficher le d√©tail de la connexion WiFi sous Linux</h3>
<p style="text-align: justify;">Incroyable, mais je n&rsquo;ai trouv√© aucune information sur comment afficher les d√©tails techniques de la connexion Wifi en cours : bande de fr√©quence, norme, canal, alors que NetworkManager a quand m√™me bien m√ªri, je n&rsquo;ai que la puissance du signal. C&rsquo;est chiant, frustrant surtout quand on teste la Livebox 5 flambante neuve de la petite soeur qui vient de passer √† la fibre.</p>
<p style="text-align: justify;">Le plus simple que j&rsquo;ai trouv√©, c&rsquo;est wavemon, dispo sur Debian/Ubuntu et Arch/Manjaro, un utilitaire qui permet d&rsquo;afficher en ligne de commande les d√©tails que je souhaitais :</p>
<p style="text-align: justify;"><a href="https://blog.seboss666.info/wp-content/uploads/2020/08/wavemon.png" rel="lightbox[6232]"><img class="aligncenter size-medium wp-image-6386" src="https://blog.seboss666.info/wp-content/uploads/2020/08/wavemon-300x148.png" alt="" width="300" height="148" srcset="https://blog.seboss666.info/wp-content/uploads/2020/08/wavemon-300x148.png 300w, https://blog.seboss666.info/wp-content/uploads/2020/08/wavemon-768x379.png 768w, https://blog.seboss666.info/wp-content/uploads/2020/08/wavemon.png 942w" sizes="(max-width: 300px) 100vw, 300px" /></a>Le d√©bit et la bande de fr√©quence me font dire que je suis bien en WiFi AC, confirmant les bons d√©bits que j&rsquo;exp√©rimente sur la connexion <img src="https://s.w.org/images/core/emoji/11/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<h3 style="text-align: justify;">Terraform : identifier les variables non-utilis√©es</h3>
<p style="text-align: justify;">Quand on fait √©voluer un code terraform, il est possible que certaines variables soient devenues inutiles. Dans ce cas, pour les identifier et faire le m√©nage dans les d√©clarations (dans votre fichier variables.tf le plus souvent), vous pouvez exploiter ce petit one-liner :</p>
<p></p><pre class="crayon-plain-tag">$ for name in $(grep variable variables.tf | cut -d '"' -f 2); do grep $name *.tf | grep -v variable &gt;/dev/null || echo $name is unused; done
client is unused
$</pre><p></p>
<p style="text-align: justify;">Et √ßa suffira pour aujourd&rsquo;hui, mais on n&rsquo;est pas √† l&rsquo;abri de voir d&rsquo;autres morceaux un peu plus costauds dans le futur (ou plus originaux <img src="https://s.w.org/images/core/emoji/11/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;" /> )</p>
]]></content:encoded>
            <wfw:commentRss>https://blog.seboss666.info/2020/09/quelques-astuces-diverses-dix-neuvieme/feed/</wfw:commentRss>
            <slash:comments>2</slash:comments>
        </item>
        <item>
            <title>De Docker Swarm √† Kubernetes avec k3s</title>
            <link>https://blog.seboss666.info/2020/08/de-docker-swarm-a-kubernetes-avec-k3s/</link>
            <comments>https://blog.seboss666.info/2020/08/de-docker-swarm-a-kubernetes-avec-k3s/#comments</comments>
            <pubDate>Tue, 25 Aug 2020 16:00:14 +0000</pubDate>
            <dc:creator><![CDATA[Seboss666]]></dc:creator>
            <category><![CDATA[Projets]]></category>
            <category><![CDATA[Sysadmin]]></category>
            <category><![CDATA[complexit√©]]></category>
            <category><![CDATA[consommation]]></category>
            <category><![CDATA[docker]]></category>
            <category><![CDATA[futur]]></category>
            <category><![CDATA[k3s]]></category>
            <category><![CDATA[kompose]]></category>
            <category><![CDATA[kubernetes]]></category>
            <category><![CDATA[migration]]></category>
            <category><![CDATA[rancher]]></category>
            <category><![CDATA[ressources]]></category>
            <category><![CDATA[stockage]]></category>

            <guid isPermaLink="false">https://blog.seboss666.info/?p=5962</guid>
            <description><![CDATA[Apr√®s plusieurs mois d&#8217;attentes et de r√©flexion, je me suis enfin sorti les doigts du cul et j&#8217;ai chang√© le SSD du micro-serveur. Double espace [...]]]></description>
            <content:encoded><![CDATA[<p style="text-align: justify;">Apr√®s plusieurs mois d&rsquo;attentes et de r√©flexion, je me suis enfin sorti les doigts du cul et j&rsquo;ai chang√© le SSD du micro-serveur. Double espace pour monter de nouvelles VMs, pour lesquelles j&rsquo;ai d√©cid√© non pas de rester sur Docker Swarm, mais de pleinement embrasser Kubernetes, via un projet tr√®s int√©ressant. Et comme souvent, voici le r√©cit de ce voyage, parce qu&rsquo;il f√ªt sem√© d‚Äôemb√ªches, de celles qu&rsquo;on ne voit √©videmment pas dans les tutos ¬´¬†hello world¬†¬ª.</p>
<p style="text-align: justify;"><span id="more-5962"></span></p>
<p style="text-align: justify;"><strong>Avertissement</strong> : <em>ceci n&rsquo;est pas un tuto complet, mais juste un gros retour d&rsquo;exp√©rience avec les r√©flexions qui vont avec</em>.</p>
<p style="text-align: justify;">Kubernetes&#8230; Le projet initi√© par Google et lib√©r√© depuis est sur toutes les l√®vres des d√©cideurs informatiques captur√©s tels des lapins par les phares des marketeux des agences Web qui pensent pouvoir se passer de qualit√©. Il est vrai que compar√© √† du Docker pur, et m√™me √† Swarm, il a une quantit√© d&rsquo;avantages. Mais il a aussi ses inconv√©nients, et √ßa peut vite s&#8217;emballer.</p>
<p style="text-align: justify;">Je suis toujours aussi critique sur la conteneurisation des applications, et surtout de son usage souvent mauvais, √† l&rsquo;image d&rsquo;un php accessible qui permet trop facilement de faire de la merde. Mais pour le manipuler depuis plus d&rsquo;un an et demi, force est de reconna√Ætre que K8s (le nom abr√©g√© de Kubernetes) me pla√Æt beaucoup, bien que je lui trouve aussi des d√©fauts. C&rsquo;est selon moi, √† date √©videmment, la meilleure impl√©mentation d&rsquo;orchestration de conteneurs que l&rsquo;on puisse trouver.</p>
<p style="text-align: justify;">√Ä l&rsquo;image du cluster Swarm qui √©tait surtout √† la base un moyen d&rsquo;entretenir mes comp√©tences Docker, l&rsquo;√©volution du cluster est donc un moyen d&rsquo;exp√©rimenter et d&rsquo;entretenir mes comp√©tences sur et autour de Kubernetes.</p>
<h3 style="text-align: justify;">Rancher, un acteur cl√© du monde de la conteneurisation</h3>
<p style="text-align: justify;"><a href="https://rancher.com/" target="_blank" rel="noopener">Rancher</a> est une soci√©t√© qui d√©veloppe beaucoup d&rsquo;outils et de services centr√©s sur les containers. OS de supervision de cluster, orchestrateur docker, providers de stockage, et j&rsquo;en passe. Leur expertise dans ce domaine n&rsquo;est plus √† faire, et beaucoup de leurs outils sont open source.</p>
<p style="text-align: justify;"><a href="https://blog.seboss666.info/wp-content/uploads/2019/09/rancher_logo.png" rel="lightbox[5962]"><img class="aligncenter size-medium wp-image-6390" src="https://blog.seboss666.info/wp-content/uploads/2019/09/rancher_logo-300x44.png" alt="" width="300" height="44" srcset="https://blog.seboss666.info/wp-content/uploads/2019/09/rancher_logo-300x44.png 300w, https://blog.seboss666.info/wp-content/uploads/2019/09/rancher_logo-768x113.png 768w, https://blog.seboss666.info/wp-content/uploads/2019/09/rancher_logo-1024x151.png 1024w" sizes="(max-width: 300px) 100vw, 300px" /></a>C&rsquo;est un acteur de poids qui cherche en permanence de nouveaux moyens de mettre ces technos √† la port√©e du plus grand nombre, des gros serveurs de data centers, aux petits auto h√©berg√©s comme moi qui voudraient aussi en profiter. Et dans cette cat√©gorie, tous n&rsquo;ont pas un serveur comme le mien, qui n&rsquo;est d√©j√† pas bien puissant, mais encore plus petit. D&rsquo;ailleurs on verra que finalement j&rsquo;utilise plusieurs projets li√©s venant de Rancher.</p>
<p style="text-align: justify;">Je vous recommande de vous int√©resser √† leurs produits, certains sont int√©ressants, comme l&rsquo;utilitaire qui permet de faire de la centralisation de la gestion de clusters, et ce quelque soit leur origine (maison, ¬´¬†cloud-provided¬†¬ª, etc), parce que parfois, la ligne de commande c&rsquo;est chiant m√™me quand on adore <img src="https://s.w.org/images/core/emoji/11/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;" /> <em>(Ils ont aussi un catalogue de formations et de certifications qui peut vous int√©resser)</em></p>
<h3 style="text-align: justify;">k3s, la r√©ponse pour nano-pc</h3>
<p style="text-align: justify;">Un des reproches qu&rsquo;on fait souvent √† k8s est sa lourdeur, √† savoir que les composants permettant de faire le boulot consomment beaucoup de ressources eux-m√™mes. Chez Microsoft ils nous indiquaient un chiffre, certes un peu au doigt mouill√©, d&rsquo;une dizaine de pourcents pour les n≈ìuds worker. Et les masters doivent aussi √™tre si possible des brutes, surtout en m√©moire vive (merci etcd). De mani√®re g√©n√©ral, on recommande que chaque machine du cluster dispose d&rsquo;au moins 4 coeurs et de 8Go de RAM. C&rsquo;est juste la capacit√© globale de mon micro-serveur actuellement, c&rsquo;est un peu compliqu√©.</p>
<p style="text-align: justify;">Et Rancher avait une cible : le Raspberry PI, un nano-pc disponibles aux alentours d&rsquo;une trentaine euros, sur architecture ARM, d&rsquo;abord con√ßu pour le monde de l&rsquo;√©ducation, mais qui a bien d√©pass√© ce cadre (on en doute m√™me du succ√®s aupr√®s de cette cible primaire, tant les bidouilleurs se sont jet√©s dessus). Avec environ 1Go de RAM pour les PI 3, il est √©vident qu&rsquo;il n&rsquo;est pas possible en l&rsquo;√©tat de faire tourner la b√™te. Ils ont donc boss√©, cherch√© comment r√©duire au maximum, parfois en allant jusqu&rsquo;√† remplacer des composants du control plane par d&rsquo;autres plus l√©gers.</p>
<p style="text-align: justify;"><a href="https://k3s.io/" target="_blank" rel="noopener">k3s</a> est n√©. Avec k3s vous pouvez monter un cluster Kubernetes √† base de machines aussi peu puissantes que des Raspberry PI (3 et suivants), ce qui tombe bien puisque je d√©ploie en g√©n√©ral des machines virtuelles aux caract√©ristiques proches sur mon serveur. Je ne suis ni le premier ni le dernier √† en parler, mais je vais m&rsquo;inspirer du travail d√©j√† produit, ne serait que pour valider que c&rsquo;est r√©utilisable dans d&rsquo;autres situations. Et surtout, j&rsquo;ai des outils d√©j√† d√©ploy√©s qu&rsquo;il faut que je transf√®re, car je n&rsquo;ai pas non plus envie de me paver les deux clusters en maintenance.</p>
<div id="attachment_6380" style="width: 310px" class="wp-caption aligncenter"><a href="https://blog.seboss666.info/wp-content/uploads/2019/09/pi_cluster.jpg" rel="lightbox[5962]"><img class="size-medium wp-image-6380" src="https://blog.seboss666.info/wp-content/uploads/2019/09/pi_cluster-300x295.jpg" alt="" width="300" height="295" srcset="https://blog.seboss666.info/wp-content/uploads/2019/09/pi_cluster-300x295.jpg 300w, https://blog.seboss666.info/wp-content/uploads/2019/09/pi_cluster-768x755.jpg 768w, https://blog.seboss666.info/wp-content/uploads/2019/09/pi_cluster.jpg 800w" sizes="(max-width: 300px) 100vw, 300px" /></a><p class="wp-caption-text">Spoiler, c&rsquo;est pas des Pi 4 <img src="https://s.w.org/images/core/emoji/11/72x72/1f61b.png" alt="üòõ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p></div>
<p style="text-align: justify;">Et comme indiqu√© au d√©but, j&rsquo;ai pas pr√©vu de me faire mal avec des raspberry PI, j&rsquo;ai juste un micro-serveur dont j&rsquo;ai <a href="https://blog.seboss666.info/2017/01/le-futur-de-mon-infrastructure-personnelle/" target="_blank" rel="noopener">d√©j√† parl√© dans le pass√©</a>.</p>
<h3 style="text-align: justify;">Monter un cluster en mode ¬´¬†Infra as Code¬†¬ª</h3>
<p style="text-align: justify;">Parce que √ßa fait aussi partie des mes activit√©s au boulot d√©sormais, j&rsquo;avais envie de d√©ployer tout le cluster en mode Infrastructure-as-Code. Rien de r√©volutionnaire, j&rsquo;ai vis√© l&rsquo;utilisation de <a href="https://www.terraform.io/" target="_blank" rel="noopener">Terraform</a> pour d√©ployer mes machines, et d&rsquo;<a href="https://docs.ansible.com/" target="_blank" rel="noopener">Ansible</a> pour faire leur configuration de base.</p>
<p style="text-align: justify;">Je pensais faire la transition en douceur entre Docker Swarm et Kubernetes, mais quelques m√©saventures avec le LVM de Proxmox VE m&rsquo;ont pouss√© √† carr√©ment r√©installer celui-ci dans sa derni√®re version et donc refaire les machines de z√©ro. Ce fut √©galement l&rsquo;occasion de tout refaire √† base de Debian 10 (dont j&rsquo;aurais s√ªrement l&rsquo;occasion de faire quelques remarques plus tard). Comme je suis toujours en t√©l√©travail prolong√© chez ma m√®re, √ßa s&rsquo;est fait lors d&rsquo;un aller-retour rapide chez moi, car j&rsquo;ai d√ª aller au boulot chercher ma <a href="https://www.yubico.com/products/" target="_blank" rel="noopener">Yubikey</a>. J&rsquo;ai juste pris le temps de r√©installer Proxmox VE sur un SSD flambant neuf deux fois plus gros que celui d&rsquo;origine, et r√©installer le bastion √† la main pour pouvoir faire tout le boulot √† distance par la suite, j&rsquo;avais d√©j√† √† disposition mes r√¥les de bases d&rsquo;Ansible c&rsquo;est donc all√© tr√®s vite.</p>
<p style="text-align: justify;">D√©ployer des machines avec Terraform suppose d&rsquo;avoir √† disposition un template de machine √† d√©ployer. Au final j&rsquo;ai suivi la plupart des <a href="https://notamax.be/proxmox-v6-cluster-k8s-kubeadm-via-terraform-cloud-init/" target="_blank" rel="noopener">instructions partag√©es par Anthony</a> (et sur lequel j&rsquo;ai apport√© une pr√©cision apr√®s avoir rencontr√© des soucis), apr√®s tout pourquoi r√©inventer la roue quand la solution existe d√©j√† ? L&rsquo;article propose l&rsquo;installation bout-en-bout d&rsquo;un kube complet via kubeadm, je me suis juste inspir√© de la partie Terraform car je compte bien rester sur du k3s. Je suis parti sur une base d&rsquo;un master/deux workers, et j&rsquo;ai cette fois d√©ploy√© des machines √† 2vCPU et 2 Go de RAM. La seule contrari√©t√© finalement que j&rsquo;ai rencontr√© c&rsquo;est que j&rsquo;√©tais √† distance, et que l&rsquo;interface de Proxmox VE n&rsquo;est pas joignable de l&rsquo;ext√©rieur. Je suis donc pass√© par un transfert de port via SSH pour exposer en local le port 8006, et c&rsquo;est localhost qui √©tait d√©sign√© comme adresse dans la configuration du provider pour taper sur l&rsquo;API de Proxmox. Et pour l&rsquo;anecdote, l&rsquo;instance Consul qui me sert √† stocker mes tfstate √©tait d√©ploy√©e sur Docker Swarm, du coup dans l&rsquo;imm√©diat le tfstate reste en local sur mon poste.</p>
<p></p><pre class="crayon-plain-tag">$ ssh -L 8006:127.0.0.1:8006 root@pimousse.seboss666.ovh</pre><p></p>
<p style="text-align: justify;">Pour la partie configuration de base, comme je disais, j&rsquo;ai d√©j√† mes r√¥les Ansible, que j&rsquo;ai remis √† jour pour prendre en compte les changements effectu√©s dans Debian 10. Certains paquets ont chang√© de nom ou ont disparu, d&rsquo;autres n&rsquo;√©taient pas inclus de base dans l&rsquo;image utilis√©e pour le template, et j&rsquo;ai √©galement eu √† faire une ou deux modifications mineures dans l&rsquo;environnement bash (via <a href="https://gitlab.com/bersace/powerline.bash/" target="_blank" rel="noopener">powerline.bash</a>), en vue justement de pouvoir utiliser k3s par la suite.</p>
<p style="text-align: justify;">Pour l&rsquo;installation de k3s et la cr√©ation du cluster lui-m√™me, √ßa a √©t√© un peu plus compliqu√©. J&rsquo;avais ressorti un article d&rsquo;itwars et surtout le d√©p√¥t Github gard√© apr√®s avoir lu <a href="https://blog.zwindler.fr/2019/03/21/deployer-en-5-minutes-un-cluster-kubernetes-sur-arm-avec-k3s-et-ansible/" target="_blank" rel="noopener">l&rsquo;article de Zwindler</a> sur une telle op√©ration sur des machines Scaleway. Cette premi√®re version n&rsquo;avait que peu boug√©, et surtout, j&rsquo;ai perdu du temps en recopiant tout plut√¥t qu&rsquo;en clonant, parce qu&rsquo;au passage j&rsquo;effectuais en direct mes propres changements dans les t√¢ches, et √ßa avait abouti √† un truc qui ne fonctionnait pas, en tout cas pas compl√®tement. Avant de me rendre compte que le contenu du d√©p√¥t a <a href="https://github.com/rancher/k3s-ansible" target="_blank" rel="noopener">√©t√© repris et am√©lior√©</a> de mani√®re communautaire directement par Rancher. Avec toute la maintenance qui va avec, et bizarrement, apr√®s avoir fait les deux/trois modifications qui s&rsquo;imposaient (entre autres d√©sactivation de l&rsquo;installation de Traefik pour faire la mienne, et la personnalisation du r√©seau, personnalisation de l&rsquo;inventaire comme le pr√©conise la doc), √ßa a fini par tomber en marche. Mais comptez deux apr√®s-midi de perte de temps quand m√™me, si c&rsquo;est pas un boulot de champion √ßa&#8230;</p>
<p style="text-align: justify;">Comme je pr√©vois d&rsquo;utiliser quelques softs sans forc√©ment pousser la configuration de ouf, j&rsquo;ai cherch√© √† installer Helm, que je viens d&rsquo;√©voquer, en tentant quelques t√¢ches Ansible. Apr√®s plusieurs √©checs minables parce que je ne suis parfois pas dou√© (ou pas concentr√©), j&rsquo;ai finalement retrouv√© la m√©moire, √† savoir qu&rsquo;il existe une base de donn√©es plut√¥t fournie de r√¥les communautaires qui s&rsquo;appelle Ansible Galaxy. J&rsquo;ai donc fouill√© dedans et il n&rsquo;a pas fallu une minute pour que <a href="https://galaxy.ansible.com/andrewrothstein/kubernetes-helm" target="_blank" rel="noopener">Helm soit install√©</a>. On ne regarde pas assez souvent ce que les gens ont contribu√© sur Galaxy, c&rsquo;est une vraie mine d&rsquo;or.</p>
<h3 style="text-align: justify;">Convertir mes services, en mode feignant ?</h3>
<p style="text-align: justify;">√Ä l&rsquo;image de Gogs, qui √©tait pass√© de ¬´¬†bare metal¬†¬ª <a href="https://blog.seboss666.info/2017/12/comment-transformer-un-de-ses-services-avec-docker-gogs/" target="_blank" rel="noopener">√† Docker Swarm</a>, j&rsquo;ai ensuite d√ª me pencher sur la conversion du fichier docker stack/compose en manifestes Kubernetes. On va le voir, de la m√™me fa√ßon qu&rsquo;on d√©clare un r√©seau, des services, et des volumes, il faut aussi d√©clarer plusieurs types d&rsquo;objets pour faire le boulot, l&rsquo;architecture globale n&rsquo;ayant cette-fois-ci pas trop besoin de changer puisqu&rsquo;on est d√©j√† dans un contexte container.</p>
<p style="text-align: justify;">Par contre, m√™me les plus aguerris vous le dirons, la syntaxe des manifestes k8s, √©crit le plus souvent en yaml, est pour le moins verbeuse. √Ä tel point que si on d√©finit une stack Swarm dans un fichier unique g√©n√©ralement, les bonnes pratiques consistent √† cr√©er un fichier par objet ou type d&rsquo;objet pour Kubernetes. Oui, on en est l√†.</p>
<p style="text-align: justify;">De cette complexit√© est n√© l&rsquo;outil <a href="https://kompose.io/getting-started/" target="_blank" rel="noopener">Kompose</a>, un v√©ritable must have selon moi qui permet de cr√©er des manifestes K8s √† partir de fichiers docker-compose. Ils sont rarement exploitables en l&rsquo;√©tat mais permettent de m√¢cher le boulot pour avoir la structure qui va bien, un peu √† l&rsquo;image d&rsquo;ansible-galaxy qui peut vous g√©n√©rer la structure d&rsquo;un module Ansible pour vous, dans l&rsquo;optique d&rsquo;une publication.</p>
<h3 style="text-align: justify;">La question sensible des volumes persistants&#8230;</h3>
<p style="text-align: justify;">Toujours cette satan√©e persistance dont personne ne veut prendre en charge les probl√®matiques. C&rsquo;est faux en partie, Kubernetes embarque nativement pas mal de plugins pour des technos de stockage diverses et vari√©es, notamment celles des fournisseurs de cloud qui proposent des services Kubernetes h√©berg√©s et g√©r√©s pr√™ts √† l&#8217;emploi, ces plugins permettant alors, depuis Kubernetes, de ¬´¬†commander¬†¬ª automatiquement des volumes de diff√©rents types.</p>
<p style="text-align: justify;">K3s √©tant simplifi√©, par d√©faut tous ces plugins sautent et seul le hostpath et l&#8217;emptydir persistent. C&rsquo;est emb√™tant parce que j&rsquo;utilise d√©j√† du NFS et il est possible de d√©clarer les PV NFS sans probl√®me, mais pas les PVC (et on parle de plusieurs heures √† essayer). Comme je l&rsquo;indiquais <a href="https://blog.seboss666.info/2019/12/une-bonne-gestion-des-volumes-nfs-dans-un-cluster-docker-swarm/" target="_blank" rel="noopener">dans le billet d√©di√© √† ce sujet</a> maintenant les volumes NFS sont d√©clar√© explicitement dans mes stacks, et non plus via un montage global sur chaque n≈ìud. J&rsquo;ai de toute fa√ßon pr√©vu de m&rsquo;en d√©barrasser, rappelez-vous, quand tout red√©marre le temps de d√©marrage du NAS faisait que mes services tentaient de d√©marrer sans leur volume, avec un r√©sultat parfois int√©ressant, mais il faut bien que je transf√®re les donn√©es. Une des solutions de contournement, serait d&rsquo;utiliser le <a href="https://github.com/helm/charts/tree/master/stable/nfs-client-provisioner" target="_blank" rel="noopener">nfs-client-provisioner</a>, plugg√© sur mon partage global, qui cr√©e des dossiers dynamiquement, dans lesquels je synchroniserai √©ventuellement les data le temps de faire cette migration. Mais au final, si le nfs-client-provisioner est l√†, il n&rsquo;est que tr√®s peu utilis√©.</p>
<p style="text-align: justify;">Pour disposer de volumes persistants au sein m√™me du cluster, j&rsquo;ai d√©cid√© d&rsquo;utiliser un autre projet de Rancher, <a href="https://longhorn.io/" target="_blank" rel="noopener">Longhorn</a>. J&rsquo;ai eu par contre la d√©sagr√©able surprise de voir sa lourdeur pour mon cluster, donc tant pis, on verra √† l&rsquo;usage. Un autre √©l√©ment √† prendre en compte, c&rsquo;est que les volumes Longhorn ne supporte que le mode d&rsquo;√©criture RWO, pour Read-Write-Once, ce qui veut dire pas de replicas d&rsquo;un m√™me pod, et surtout pas de rolling update. Aussi, m√™me en d√©clarant un volume aussi petit que 32Mi via PVC, il a cr√©√© un PV d&rsquo;1Go, et le PVC mentionne aussi 1Go. Fort heureusement ce sont des volumes ¬´¬†dynamiques¬†¬ª, √† savoir qu&rsquo;ils consomment r√©ellement uniquement ce qu&rsquo;on y met, mais si on vide manuellement un volume, le fichier correspondant sous-jacent sur l&rsquo;OS n&rsquo;est pas redimensionn√©, √† l&rsquo;image d&rsquo;une image disque de machine virtuelle (ce qu&rsquo;on avait pu voir √† l&rsquo;√©poque <a href="https://blog.seboss666.info/2014/08/convertir-une-image-disque-de-machine-virtuelle-au-format-qcow2/" target="_blank" rel="noopener">sur le format qcow2</a>).</p>
<p style="text-align: justify;">Pour contourner la limitation du RWO, il existe un provisioner ¬´¬†<a href="https://longhorn.io/docs/1.0.2/advanced-resources/rwx-workloads/" target="_blank" rel="noopener">longhorn-nfs</a>¬†¬ª disponible dans la derni√®re version qui va cr√©er un volume unique d&rsquo;une certaine taille (20Go par d√©faut), et l&rsquo;exposer en NFS via une StorageClass, ce qui permet du coup de b√©n√©ficier des rolling updates. J&rsquo;arrive toujours pas √† me d√©cider si je vais tout utiliser de cette mani√®re, on verra √† l&rsquo;usage.</p>
<h3 style="text-align: justify;">&#8230; et le r√©apprentissage de l&rsquo;Ingress controller</h3>
<p style="text-align: justify;">Comme je l&rsquo;ai √©voqu√© un peu plus t√¥t, m√™me si k3s est fourni avec Traefik, la version embarqu√©e me plait moyennement car la 2.2 apporte beaucoup de fonctions sympatiques. Pour l&rsquo;installation de cette version, l√† encore rien de transcendant, je me suis bas√© sur le <a href="https://github.com/djerfy/kubernetes-ingress-traefik" target="_blank" rel="noopener">travail de configuration ¬´¬†simple¬†¬ª mis √† disposition par Djerfy</a>, en l&rsquo;adaptant l√©g√®rement pour mes besoins. J&rsquo;avais commenc√© par Helm, mais j&rsquo;avais un petit risque de passer √† c√¥t√© de la souplesse de personnaliser compl√®tement l&rsquo;outil. Je peux maintenant exposer les ports via la box, et faire tout le boulot qu&rsquo;on demande d&rsquo;un reverse-proxy. Et voil√†, j&rsquo;ai la base pour red√©ployer mes services d√©sormais.</p>
<p style="text-align: justify;">Traefik a l&rsquo;air tr√®s int√©ressant, mais son impl√©mentation dans Kubernetes am√®ne pas mal de concepts que je dois r√©apprendre, par rapport √† un Ingress Controller plus classique (Nginx √©tant le plus r√©pandu, et j&rsquo;ai pratiqu√© haproxy lors d&rsquo;un projet client). Et sinon, l√† o√π √ßa restera compliqu√© pour la conversion, c&rsquo;est que je crois que Kompose ne cr√©e pas les fichiers d&rsquo;Ingress, je n&rsquo;ai donc aucune base de travail. Pas √©tonnant, aucun label particulier pour l&rsquo;aider, son travail √† partir du docker-compose se limite donc √† l&rsquo;exposition du service.¬† L&rsquo;avantage c&rsquo;est que tout est document√©, mais √ßa n&#8217;emp√™che pas que je doives apprendre toute la syntaxe de configuration, adapter les ¬´¬†tricks¬†¬ª que j&rsquo;avais pu faire sur mon reverse-proxy Nginx, et surtout, trouver un moyen de coupler les IngressRoute propres √† Kubernetes √† des bouts de configuration plus statiques pour les quelques services qui ne seront pas dans le cluster, l&rsquo;interface du NAS en premier lieu.</p>
<p><a href="https://blog.seboss666.info/wp-content/uploads/2019/09/traefik_dashboard_svc.png" rel="lightbox[5962]"><img class="aligncenter size-medium wp-image-6391" src="https://blog.seboss666.info/wp-content/uploads/2019/09/traefik_dashboard_svc-300x156.png" alt="" width="300" height="156" srcset="https://blog.seboss666.info/wp-content/uploads/2019/09/traefik_dashboard_svc-300x156.png 300w, https://blog.seboss666.info/wp-content/uploads/2019/09/traefik_dashboard_svc-768x399.png 768w, https://blog.seboss666.info/wp-content/uploads/2019/09/traefik_dashboard_svc-1024x532.png 1024w, https://blog.seboss666.info/wp-content/uploads/2019/09/traefik_dashboard_svc.png 1468w" sizes="(max-width: 300px) 100vw, 300px" /></a></p>
<p style="text-align: justify;">En tout cas pas m√©content d&rsquo;avoir dans mes contacts proches un Djerfy qui est Traefik Ambassador pour m&rsquo;√©pauler (bien qu&rsquo;il soit parfois lui-m√™me en train de d√©terrer des trucs), √ßa aide bien pendant cette mini-travers√©e du d√©sert <img src="https://s.w.org/images/core/emoji/11/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<h3 style="text-align: justify;">La mise en pratique de la migration de service</h3>
<p style="text-align: justify;">Pour l&rsquo;article je vais prendre l&rsquo;exemple simple de <a href="https://oss.oetiker.ch/smokeping/" target="_blank" rel="noopener">Smokeping</a>. Un container, deux volumes, un port, on peut difficilement faire plus accessible. Voici d&rsquo;ailleurs la stack actuelle :</p>
<p></p><pre class="crayon-plain-tag">version: "3.2"

volumes:
  smokedata:
    driver_opts:
      type: nfs
      o: "addr=1.2.3.4,rw,nfsvers=3,nolock,soft,exec"
      device: ":/Docker/smokeping/data"
  smokeconfig:
    driver_opts:
      type: nfs
      o: "addr=1.2.3.4,rw,nfsvers=3,nolock,soft,exec"
      device: ":/Docker/smokeping/config"

networks:
  smokeping:
    driver: overlay

services:
  smokeping:
    image: linuxserver/smokeping:191068eb-ls64
    networks:
      - "smokeping"
    ports:
      - "20080:80"
    environment:
      - "PUID=1001"
      - "GUID=1001"
      - "TZ=Europe/Paris"
    volumes:
      - type: volume
        source: smokedata
        target: /data
        volume:
          nocopy: true
      - type: volume
        source: smokeconfig
        target: /config
        volume:
          nocopy: true
    deploy:
      replicas: 1
      restart_policy:
        condition: any</pre><p></p>
<p style="text-align: justify;">Passons maintenant √† Kompose, pas besoin de d√©tailler son installation, il suffit de suivre <a href="https://kompose.io/installation/" target="_blank" rel="noopener">la doc</a> (rtfm quoi). Pour son utilisation, il suffit de le lancer en lui indiquant le fichier compose et paf, √ßa fait des chocapic, ou presque. On constate qu&rsquo;il a cr√©√© plusieurs fichiers yaml, dont on va d√©tailler les √©l√©ments :</p>
<p></p><pre class="crayon-plain-tag">-rw-r--r-- 1 seboss666 seboss666  271 18.08.2020 19:55 smokeconfig-persistentvolumeclaim.yaml
-rw-r--r-- 1 seboss666 seboss666  268 18.08.2020 19:55 smokedata-persistentvolumeclaim.yaml
-rw-r--r-- 1 seboss666 seboss666 1,4K 10.08.2020 19:40 smokeping-deployment.yaml
-rw-r--r-- 1 seboss666 seboss666  294 10.08.2020 19:40 smokeping-networkpolicy.yaml
-rw-r--r-- 1 seboss666 seboss666  381 10.08.2020 19:40 smokeping-service.yaml</pre><p></p>
<p style="text-align: justify;">On a donc deux persistent volume claims, un deployment, un networkpolicy et un service. Il manque encore l&rsquo;IngressRoute et un ou deux √©l√©ments annexes dont on va parler juste apr√®s.</p>
<p style="text-align: justify;">Voyons un peu √† quoi ressemblent ces fichiers, celui du deployment √©tant assez int√©ressant :</p>
<p></p><pre class="crayon-plain-tag">apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: smokeping
  annotations:
    kompose.cmd: kompose convert -f ./smokeping_stack.yml
    kompose.version: 1.21.0 (992df58d8)
  creationTimestamp: null
  labels:
    io.kompose.service: smokeping
  name: smokeping
spec:
  replicas: 1
  selector:
    matchLabels:
      io.kompose.service: smokeping
  strategy:
    type: Recreate
  template:
    metadata:
      annotations:
        kompose.cmd: kompose convert -f ./smokeping_stack.yml
        kompose.version: 1.21.0 (992df58d8)
      creationTimestamp: null
      labels:
        io.kompose.network/smokeping: "true"
        io.kompose.service: smokeping
    spec:
      containers:
      - env:
        - name: GUID
          value: "1001"
        - name: PUID
          value: "1001"
        - name: TZ
          value: Europe/Paris
        image: linuxserver/smokeping:191068eb-ls64
        imagePullPolicy: ""
        name: smokeping
        ports:
        - containerPort: 80
        resources: {}
        volumeMounts:
        - mountPath: /data
          name: smokedata
        - mountPath: /config
          name: smokeconfig
      restartPolicy: Always
      serviceAccountName: ""
      volumes:
      - name: smokedata
        persistentVolumeClaim:
          claimName: smokedata
      - name: smokeconfig
        persistentVolumeClaim:
          claimName: smokeconfig
status: {}</pre><p></p>
<p style="text-align: justify;">Je l&rsquo;avais dit que c&rsquo;√©tait particuli√®rement verbeux ? C&rsquo;est un des reproches que je fais √† la techno. Pareil pour les volumes, dans Swarm, vous d√©clarez un volume, vous l&rsquo;utilisez, point barre. Ici il faut d√©clarer un volume (PersistentVolume), d√©clarer qu&rsquo;on va l&rsquo;utiliser (PersistentVolumeClaim), et ensuite l&rsquo;attacher dans le Deployment en le d√©clarant. Et tout √ßa avec 10 fois plus de lignes. Et encore, gr√¢ce √† Longhorn, on ¬´¬†simplifie¬†¬ª parce qu&rsquo;il n&rsquo;y a besoin que du VolumeClaim, le PV √©tant provisionn√© de mani√®re dynamique derri√®re. Vient ensuite le service, sans lequel le port de l&rsquo;application n&rsquo;est pas r√©ellement expos√©, et m√™me l√†, √ßa reste de la communication ¬´¬†interne¬†¬ª, √† moins de faire un service de type nodePort, qui r√©plique finalement le comportement de docker Swarm.</p>
<p style="text-align: justify;">Car oui, en temps normal dans un cluster K8s, c&rsquo;est l&rsquo;Ingress Controller qui est charg√© de faire le lien entre l&rsquo;ext√©rieur et les services. Et donc Kompose ne s&rsquo;occupe absolument pas de cet aspect, il faut que je bosse le sujet. Pour Smokeping, je suis le seul √† y acc√©der, on a donc une IngressRoute classique avec juste un auth basic http. Un mod√®le qui sera r√©utilis√© pour la plupart des services je pense, comme c&rsquo;√©tait le cas sur mon Nginx. Ce setup a une particularit√© : il a besoin d&rsquo;un secret, pour stocker le couple utilisateur:motdepassehash√©, d&rsquo;un Middleware qui est une ressource Custom cr√©√©e par le d√©ploiement de Traefik pour d√©clarer cette authentification, et dans l&rsquo;IngressRoute lui-m√™me, l&rsquo;appel √† ce Middleware. Certes je pourrais regrouper ces √©l√©ments dans le m√™me fichier, mais pour l&rsquo;exercice, √ßa fait donc trois fichiers de plus :</p>
<p></p><pre class="crayon-plain-tag">-rw-r--r-- 1 seboss666 seboss666  271 18.08.2020 19:55 smokeconfig-persistentvolumeclaim.yaml
-rw-r--r-- 1 seboss666 seboss666  268 18.08.2020 19:55 smokedata-persistentvolumeclaim.yaml
-rw-r--r-- 1 seboss666 seboss666 1,4K 10.08.2020 19:40 smokeping-deployment.yaml
-rw-r--r-- 1 seboss666 seboss666  351 18.08.2020 20:33 smokeping-ingressroute.yaml
-rw-r--r-- 1 seboss666 seboss666  211 18.08.2020 20:17 smokeping-middleware.yaml
-rw-r--r-- 1 seboss666 seboss666  294 10.08.2020 19:40 smokeping-networkpolicy.yaml
-rw-r--r-- 1 seboss666 seboss666  237 18.08.2020 20:16 smokeping-secret.yaml
-rw-r--r-- 1 seboss666 seboss666  381 10.08.2020 19:40 smokeping-service.yaml</pre><p></p>
<p style="text-align: justify;">Dans l&rsquo;imm√©diat je n&rsquo;ai pas appliqu√© la NetworkPolicy, parce que je dois l&rsquo;adapter √† mon installation d&rsquo;abord, mais √ßa fait partie des bonnes pratiques que je recommande vivement d&rsquo;appliquer en production pour isoler vos applications entre elles. J&rsquo;ai d&rsquo;autres priorit√©s dans l&rsquo;imm√©diat, et je radote je sais, mais c&rsquo;est le stockage.</p>
<p style="text-align: justify;">Revenons vite fait √† l&rsquo;Ingress pour mentioner un dernier morceau : pour la g√©n√©ration du mot de passe dans le secret, je recommande d&rsquo;utiliser openssl qui a l&rsquo;avantage, sous Linux, d&rsquo;√™tre d√©j√† fourni par la plupart des distributions :</p>
<p></p><pre class="crayon-plain-tag">$ echo -e "user:$(openssl passwd -apr1 superpassword)\n"</pre><p></p>
<p style="text-align: justify;">Au passage vous pouvez aussi utiliser htpasswd du paquet httpd-tools/apache2-tools.</p>
<p style="text-align: justify;">La migration du stockage des applications a √©t√© une autre aventure. J&rsquo;√©voquais la possible utilisation du nfs-client-provisioner, mais faire un premier d√©ploiement avec un tel volume, proc√©der au rsync depuis le NAS sur le dossier cr√©√©, puis depuis le pod refaire un rsync sur le volume final, c&rsquo;√©tait beaucoup trop lourd. J&rsquo;ai finalement trouv√© quelque chose de pas super souple, mais beaucoup plus simple. On commence par cr√©er le namespace et les pvc, et on cr√©e un micro-d√©ploiement qui monte ces deux volumes. Je me suis bas√© sur nginx parce que c&rsquo;est l√©ger, rapide, avec un compte root pour √©viter les probl√®mes de permissions pendant les manipulations. Ensuite sur le master, j&rsquo;ai √©galement mont√© le partage Docker du NAS en NFS de mani√®re dynamique, parce que √ßa n&rsquo;a pas vocation √† persister, et j&rsquo;ai donc copi√© les donn√©es des volumes via ¬´¬†kubectl cp¬†¬ª, sachant que derri√®re, il peut y avoir encore quelques manipulations √† l&rsquo;int√©rieur du pod nginx parce que les chemins sont souvent mal interpr√©t√©s (ou alors je suis mauvais, je me suis fait une raison avec le temps). Une fois termin√©, je supprime le d√©ploiement temporaire pour lancer le vrai d√©ploiement. Pour l&rsquo;instant, je n&rsquo;ai pas rencontr√© de difficult√©. √áa restera la partie la plus p√©nible des autres migrations.</p>
<h3 style="text-align: justify;">L&rsquo;acc√®s au cluster de l&rsquo;ext√©rieur, pas trivial</h3>
<p style="text-align: justify;">En effet, pour acc√©der √† l&rsquo;admin du cluster via kubectl, √ßa se fait via https sur le port 6443 du master. Je n&rsquo;ai pas l&rsquo;intention de l&rsquo;exposer √† l&rsquo;ext√©rieur dans l&rsquo;imm√©diat, mais pour d√©ployer des services dessus √† distance ou proc√©der aux interventions de mani√®re g√©n√©rale, il va falloir une solution. Exposer le control plane n&rsquo;est <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-8552" target="_blank" rel="noopener">jamais une bonne id√©e</a>, apr√®s quelques tergiversations je vais faire √ßa avec une connexion SSH qui redirige le port 6443 du master vers le port 6443 local, et en plus je fais √ßa via le fichier <span style="font-family: courier new, courier, monospace;">~/.ssh/config</span> plut√¥t que via la ligne de commande, ce qui me permet de gagner du temps :</p>
<p></p><pre class="crayon-plain-tag">Host k3s-master
        LocalForward 6443 127.0.0.1:6443</pre><p></p>
<p style="text-align: justify;">Me reste √† utiliser une copie du fichier kubeconfig en rempla√ßant l&rsquo;ip du master par 127.0.0.1. On retrouve donc la m√™me m√©thode que pour le d√©ploiement via terraform vu plus haut, avec un poil de ¬´¬†sucre¬†¬ª en plus en vue d&rsquo;une utilisation plus r√©guli√®re.</p>
<p style="text-align: justify;">Enfin pour la partie Ingress Controller, j&rsquo;ai d√©j√† indiqu√© comment je comptais proc√©der, j&rsquo;expose les ports 80 et 443 du master via le NAT de la box. Le tout malheureusement en full IPv4 car toujours pas de vrai pare-feu ipv6 sur la Freebox (et √ßa sera bient√¥t aussi le cas sur Livebox, la fibre √©tant au programme pour septembre, Free n&rsquo;√©tant pas encore √† jour dans l&rsquo;Oise malgr√© une promesse de disponibilit√© fin 2019).</p>
<h3 style="text-align: justify;">Les diff√©rences avec le cluster swarm, la suite</h3>
<p style="text-align: justify;">La principale diff√©rence vient du fait que je n&rsquo;ai qu&rsquo;une seule machine qui joue le r√¥le de master/control plane, quand toutes les VMs du swarm √©taient manager. Vu que tout est sur la m√™me machine physique, j&rsquo;ai envie de dire que ce n&rsquo;est pas trop grave. Exit √©galement portainer pour l&rsquo;instant, m√™me s&rsquo;il supporte k8s d√©sormais, et qui avait d√©j√† saut√© √† l&rsquo;occasion d&rsquo;une petite corruption de configuration suite √† une mauvaise manipulation lors d&rsquo;une mise √† jour. Je n&rsquo;ai pas encore pour l&rsquo;instant envisag√© de r√©installer une forme de dashboard ¬´¬†global¬†¬ª, en dehors de celui de Traefik et de Longhorn, je verrai dans le futur si j&rsquo;en ressens le besoin.</p>
<p style="text-align: justify;">M√™me si √† l&rsquo;√©poque j&rsquo;aurais pu exposer le port d&rsquo;admin de Docker Swarm pour me connecter de l&rsquo;ext√©rieur, la configuration est beaucoup plus rudimentaire, et sur ce point Kubernetes est bien plus facilitant. Attention, ce n&rsquo;est pas n√©cessairement recommand√©, d&rsquo;ailleurs la conf par d√©faut de k3s cr√©e un simple token et j&rsquo;avoue que je tenterai bien d&rsquo;ajouter une authentification via certificat client, ce qui est bien plus s√©curisant.</p>
<p style="text-align: justify;">J&rsquo;ai pu constater la r√©activit√© de k8s par rapport √† des actions de mises √† jour ou de relancement d&rsquo;application, de mon point de vue c&rsquo;est plus rapide sur kube quand on tue un pod pour qu&rsquo;il r√©apparaisse, et surtout, j&rsquo;ai d√©sormais la possibilit√© de faire du rolling update (via longhorn-nfs), limitant tr√®s fortement les indisponibilit√©s en cas de mise √† jour. Un √©l√©ment plut√¥t impactant √† prendre en compte tiens d&rsquo;ailleurs, qui a couru d√®s le d√©but de l&rsquo;installation du cluster : sans la fibre, pas mal de manipulations prennent du temps, le t√©l√©chargement de chaque binaire par exemple (via Ansible, k3s √©tait t√©l√©charg√© sur trois serveurs en m√™me temps, idem pour Helm), ou chaque image docker de plusieurs centaines de Mo est p√©nalisant.</p>
<h3 style="text-align: justify;">Les chantiers pour la suite</h3>
<p style="text-align: justify;">Tellement, d√©j√†, en l&rsquo;√©tat j&rsquo;ai red√©ploy√© un peu comme un gougnafier, et il manque des √©l√©ments qui seront importants surtout vu la capacit√© du cluster actuellement, √† savoir les requests et limits pour √©viter tout d√©bordement d&rsquo;une application. Voici l&rsquo;√©tat de la consommation avec Traefik, Longhorn, le nfs-client-provisioner, smokeping et gitea :</p>
<p></p><pre class="crayon-plain-tag">$ kubectl top nodes
NAME            CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%
k3s-master      408m         20%    1156Mi          57%
k3s-worker-01   364m         18%    640Mi           32%
k3s-worker-02   399m         19%    797Mi           39%</pre><p></p>
<p style="text-align: justify;">L&rsquo;id√©e va √™tre de laisser tourner un peu sans ces limites, voir le comportement (via ctop ou kube-capacity par exemple), et appliquer les limites raisonnables en cons√©quence. Dans le m√™me √©tat d&rsquo;esprit, des liveness/readiness ne seront pas de trop pour red√©marrer automatiquement les services, pour l&rsquo;instant c&rsquo;est le d√©sert.</p>
<p style="text-align: justify;">J&rsquo;ai d√©j√† √©voqu√© l‚Äôutilisation de Longhorn, rel√©guant le NFS aux seules sauvegardes. Justement je n&rsquo;ai absolument pas parl√© de sauvegardes, √ßa sera peut-√™tre l&rsquo;occasion de bosser sur Velero, histoire de sauvegarder le contenu des volumes car sauvegarder les VMs ne suffira peut-√™tre pas √† assurer le boulot. Il ne sera d&rsquo;ailleurs pas n√©cessairement utile de sauvegarder toutes les machines, au moins le master, les nodes pouvant √™tre r√©install√©s/ajout√©s √† l&rsquo;envi via terraform/ansible.</p>
<p style="text-align: justify;">√Ä l&rsquo;image du backup, il manque le d√©ploiement d&rsquo;une forme de monitoring. C&rsquo;est d&rsquo;autant plus n√©cessaire qu&rsquo;on est justement dans un mode contraint de ressources, et comme je compte bien r√©installer Prometheus, pas dans le cluster lui-m√™me mais sur un Raspberry Pi qui fera le travail d√©di√© (avec celui de bastion certainement pour laisser toutes les ressources du serveur au cluster). Possible encore que je me base sur le travail de <a href="https://blog.stephane-robert.info/post/monitoring-kubernetes-k3s-prometheus-grafana/" target="_blank" rel="noopener">St√©phane Robert</a> qui a eu l&rsquo;amabilit√© de tout partager.</p>
<p style="text-align: justify;">Enfin, il sera l&rsquo;occasion de commencer √† bosser sur de l&rsquo;int√©gration continue, dans la continuation de ma migration vers gitea, ce sera donc drone qui sera potentiellement amen√© dans le futur √† d√©ployer les mises √† jour de mes services kube sur le cluster.</p>
<p style="text-align: justify;">En dehors du stockage, on parle donc d&rsquo;automatiser les choses un maximum, en bon feignant qui se respecte, mais le feignant va quand m√™me devoir pas mal se retrousser les manches pour arriver au r√©sultat voulu <img src="https://s.w.org/images/core/emoji/11/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<p style="text-align: justify;">Par contre, cela va devoir se faire dans une enveloppe de ressources plut√¥t compliqu√©e √† g√©rer, car en l&rsquo;√©tat, voil√† l&rsquo;√©tat du cluster :</p>
<p style="text-align: justify;"><a href="https://blog.seboss666.info/wp-content/uploads/2019/09/pimousse_resources.png" rel="lightbox[5962]"><img class="aligncenter size-medium wp-image-6381" src="https://blog.seboss666.info/wp-content/uploads/2019/09/pimousse_resources-300x99.png" alt="" width="300" height="99" srcset="https://blog.seboss666.info/wp-content/uploads/2019/09/pimousse_resources-300x99.png 300w, https://blog.seboss666.info/wp-content/uploads/2019/09/pimousse_resources-480x160.png 480w, https://blog.seboss666.info/wp-content/uploads/2019/09/pimousse_resources.png 762w" sizes="(max-width: 300px) 100vw, 300px" /></a>On le voit, c&rsquo;est serr√©, m√™me sur le NAS qui participe au calcul du stockage. Il est temps que je rentre chez moi pour m&rsquo;occuper de tout √ßa <img src="https://s.w.org/images/core/emoji/11/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<hr />
<p style="text-align: justify;"><strong>PS</strong> : On a pu le voir ici, je n&rsquo;ai pas eu √† r√©inventer la roue, j&rsquo;ai pu grandement b√©n√©ficier du travail d√©j√† effectu√© et surtout partag√© par d&rsquo;autres, et je tiens encore √† tous les remercier. Je n&rsquo;ai pas eu l&rsquo;occasion de beaucoup am√©liorer ou compl√©ter leur travail, √† part mes m√©saventures avec Terraform sur le d√©ploiement des VMs apr√®s la cr√©ation du template que j&rsquo;ai remont√©, et des √©changes en direct avec Djerfy par rapport aux bricoles autour de Traefik. Cet article est donc aussi un t√©moignage de mon amour pour leur travail. Un jour peut-√™tre je pourrais moi-m√™me en faire plus.</p>
]]></content:encoded>
            <wfw:commentRss>https://blog.seboss666.info/2020/08/de-docker-swarm-a-kubernetes-avec-k3s/feed/</wfw:commentRss>
            <slash:comments>2</slash:comments>
        </item>
        <item>
            <title>Firefox pour Android : le renouveau, imparfait une fois de plus</title>
            <link>https://blog.seboss666.info/2020/08/firefox-pour-android-le-renouveau-imparfait-une-fois-de-plus/</link>
            <comments>https://blog.seboss666.info/2020/08/firefox-pour-android-le-renouveau-imparfait-une-fois-de-plus/#comments</comments>
            <pubDate>Fri, 21 Aug 2020 10:00:58 +0000</pubDate>
            <dc:creator><![CDATA[Seboss666]]></dc:creator>
            <category><![CDATA[Firefox]]></category>
            <category><![CDATA[android]]></category>
            <category><![CDATA[extensions]]></category>
            <category><![CDATA[limitations]]></category>
            <category><![CDATA[moteur]]></category>
            <category><![CDATA[quantum]]></category>
            <category><![CDATA[recherche]]></category>
            <category><![CDATA[refonte]]></category>

            <guid isPermaLink="false">https://blog.seboss666.info/?p=6354</guid>
            <description><![CDATA[Oui, un nouvel article sur le blog depuis plus d&#8217;un mois ! Et pour parler de Firefox, notre navigateur mobile pr√©f√©r√©, mais pas pour le [...]]]></description>
            <content:encoded><![CDATA[<p style="text-align: justify;">Oui, un nouvel article sur le blog depuis plus d&rsquo;un mois ! Et pour parler de Firefox, notre navigateur mobile pr√©f√©r√©, mais pas pour le bureau, pour Android ! Cela fait plus d&rsquo;un an que Mozilla travaille √† une refonte totale du butineur mobile, et pour l&rsquo;utiliser moi-m√™me depuis plusieurs mois, il est temps de vous en parler, car il commence sa carri√®re ¬´¬†stable¬†¬ª.</p>
<p style="text-align: justify;"><span id="more-6354"></span></p>
<h3 style="text-align: justify;">Un vieux code poussif, consommateur de RAM</h3>
<p style="text-align: justify;">C&rsquo;est un fait, le Firefox pour Android actuel a toujours quelques avantages, avec notamment un support √©tendu des extensions, mais il n&rsquo;est pas r√©put√© pour ses performances, sa r√©activit√©, ou sa l√©g√®ret√©. C&rsquo;est un vrai gouffre √† batterie qui en plus n&rsquo;offre plus aucun confort dans un monde mobile sous perfusion Chromesque, monde poussant les d√©veloppeurs JavaScript √† toujours plus de paresse dans l&rsquo;optimisation du poids de leurs horreurs.</p>
<p style="text-align: justify;">De plus, le code du navigateur lui-m√™me n&rsquo;avait plus aucune marge de man≈ìuvre pour corriger le tir, avec pour cons√©quence, une grosse stagnation dans le support des standards du web, m√™me si on a pu le voir r√©cemment <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1164187" target="_blank" rel="noopener">avec WebRTC</a>, il arrive parfois que Firefox tra√Æne un peu (faire un VPN h√©berg√© aux USA, c&rsquo;est tellement plus urgent&#8230;), sans parler que la consommation de m√©moire d√©clenchait facilement la mise en veille du navigateur, ce qui fait toujours t√¢che quand √ßa se passe √† un simple switch d&rsquo;application (genre on est sur son navigateur, on r√©pond √† un SMS, en revenant sur le navigateur il avait √©t√© d√©charg√© car prenant trop de place&#8230;). Ce qui a pouss√© Mozilla √† prendre la d√©cision de repartir de z√©ro, gardant cette version stable en mode maintenance, ne corrigeant que le strict n√©cessaire en mati√®re de s√©curit√© et de stabilit√©. Stabilit√© √©tant probablement le ma√Ætre mot, parce que j&rsquo;ai utilis√© la version preview, puis beta, et c&rsquo;est pas toujours d&rsquo;une fiabilit√© remarquable, leur statut n&rsquo;est de toute fa√ßon pas pr√©vu pour √ßa</p>
<p style="text-align: justify;">Comme je l&rsquo;ai dit, le support d&rsquo;extensions de toute sorte fait la force de Firefox mobile, mais malheureusement, certaines √©tant d&rsquo;abord con√ßues pour un ordinateur plus classique, l&rsquo;ergonomie et parfois la stabilit√© ne sont pas trop au rendez-vous. Pour ma part j&rsquo;ai le plus souvent limit√© mes usages mobiles √† l&rsquo;ajout d&rsquo;un bloqueur de publicit√©s, et l√†-dessus uBlock Origin ne d√©√ßoit pas. Ce support d&rsquo;extensions √©tait donc un passage oblig√© du petit nouveau, avec quelques surprises √† la cl√©.</p>
<h3 style="text-align: justify;">Here comes a new challenger, nouvelle architecure, chrome-like</h3>
<p style="text-align: justify;">Alors, il faut comprendre un peu comment fonctionne Android, et surtout certains de ses composants. Tout le monde conna√Æt Chrome, le navigateur maison, avec Blink, son moteur de rendu. Mais il y a un ¬´¬†petit fr√®re¬†¬ª, car Android met √† disposition des applications qui ont besoin d&rsquo;afficher du contenu web une version all√©g√©e du moteur, sous le nom de WebView (logique), qui suit les num√©rotations de Chrome dans la pratique. Certains d√©veloppeurs peu inspir√©s reposent d&rsquo;ailleurs enti√®rement sur cette WebView pour faire leur ¬´¬†application¬†¬ª, avec souvent un r√©sultat peu am√®ne pour l&rsquo;int√©gration native d&rsquo;Android. Je n&rsquo;exclus pas qu&rsquo;au final Chrome se base sur la WebView pour faire son taf de navigateur web, vous avez tout √† fait le droit de me corriger si ce n&rsquo;est pas le cas.</p>
<p style="text-align: justify;">Et justement, le nouveau Firefox a choisi cette approche, en d√©veloppant d&rsquo;un c√¥t√© le moteur, appel√© <a href="https://mozilla.github.io/geckoview/" target="_blank" rel="noopener">GeckoView</a>, qui se base en partie sur les technos d√©velopp√©es pour Quantum, et destin√©, √† l&rsquo;instar de WebView, √† pouvoir √™tre exploit√© dans des applications tierces. Et de l&rsquo;autre, l&rsquo;interface qui exploite GeckoView. Ces choix ont permis de prioriser certains d√©veloppements, performance en t√™te, pendant que d&rsquo;un autre c√¥t√©, le d√©veloppement de l&rsquo;interface pouvait se faire √† un rythme diff√©rent.</p>
<h3 style="text-align: justify;">Des performances de ouf, des nouveaut√©s bienvenues</h3>
<p style="text-align: justify;">C&rsquo;est le constat le plus flagrant selon moi : malgr√© un Android un peu trop agressif sur la gestion d&rsquo;applications et de la m√©moire, le rechargement du navigateur et du ou des onglets courants est impressionnant, presque plus rapide que sur mon ordinateur portable √† base de Core i5. C&rsquo;est bien simple, je ne vois plus aucun probl√®me √† revenir dessus, le seul souci serait d&rsquo;avoir un formulaire en cours de remplissage qui du coup serait d√©gomm√©, ce qui arrive tr√®s rarement (vu que j&rsquo;utilise l&rsquo;<a href="https://blog.seboss666.info/2015/02/lapplication-wordpress-pour-android-un-bon-moyen-de-demarrer-rapidement-un-article/" target="_blank" rel="noopener">application mobile wordpress</a> pour g√©rer les brouillons&#8230;).</p>
<p style="text-align: justify;">J&rsquo;ai pu √©galement voir du mieux sur l&rsquo;affichage de certains sites qui ne sont pourtant pas mobile-friendly, sans avoir besoin de recourir au mode lecture. Globalement le support des standards r√©cents, et notamment ceux li√©s au mobile, fait un sacr√© bon en avant et c&rsquo;est tant mieux.</p>
<p style="text-align: justify;">Les temps de chargement des pages m√™me les plus lourdes sont incomparables, je n&rsquo;ai pas de chiffres √† fournir en comparaison de Chrome Mobile, car comme sur ¬´¬†bureau¬†¬ª je le fuis comme la peste, mais compar√© au vieux Firefox c&rsquo;est vraiment le jour et la nuit. C&rsquo;est bien simple, je n&rsquo;ai pas lanc√© l&rsquo;ancien Firefox depuis plusieurs mois, bien qu&rsquo;il soit toujours install√©. Et pour cause, quand il faut pratiquement 10 secondes √† froid pour qu&rsquo;il charge mon FreshRSS, √ßa devient √©liminatoire.</p>
<p style="text-align: justify;">Du c√¥t√© des autres nouveaut√©s pour l&rsquo;instant, il parait qu&rsquo;on a droit au Picture-in-picture, que je n&rsquo;ai pas eu l&rsquo;occasion de tester, et le support des PWA. D&rsquo;un c√¥t√©, j&rsquo;aime l&rsquo;id√©e de ne plus d√©pendre des stores ferm√©s des dealers de plateforme mobiles que sont Android et iOS, d&rsquo;un autre, le fait de tout faire en JavaScript me donne toujours des envies de vomir vu la lourdeur toujours plus grande des frameworks et des applications en question. Pour rappel, PWA veut dire Progressive Web App, en clair, un application web, qui passe par le navigateur en temps normal, mais qu&rsquo;on ¬´¬†installe¬†¬ª comme une application mobile plus classique. Tous les inconv√©nients d&rsquo;un fonctionnement JavaScript dans un navigateur, sans les avantages d&rsquo;une application plus native avec ses performances et son optimisation √† la plateforme cible. Je reproche d√©j√† aux navigateurs web de bureau d&rsquo;√™tre devenus des usines √† gaz, et on reproduit exactement les m√™mes erreurs sur mobile, √† l&rsquo;heure ou l&rsquo;autonomie stagne effroyablement. Ce fonctionnement est justment rendu possible gr√¢ce √† la GeckoView.</p>
<div id="attachment_6376" style="width: 152px" class="wp-caption aligncenter"><a href="https://blog.seboss666.info/wp-content/uploads/2020/08/firefox_android_collections.jpg" rel="lightbox[6354]"><img class="size-medium wp-image-6376" src="https://blog.seboss666.info/wp-content/uploads/2020/08/firefox_android_collections-142x300.jpg" alt="" width="142" height="300" srcset="https://blog.seboss666.info/wp-content/uploads/2020/08/firefox_android_collections-142x300.jpg 142w, https://blog.seboss666.info/wp-content/uploads/2020/08/firefox_android_collections-768x1621.jpg 768w, https://blog.seboss666.info/wp-content/uploads/2020/08/firefox_android_collections-485x1024.jpg 485w, https://blog.seboss666.info/wp-content/uploads/2020/08/firefox_android_collections.jpg 1080w" sizes="(max-width: 142px) 100vw, 142px" /></a><p class="wp-caption-text">Des groupes d&rsquo;onglets quoi</p></div>
<p style="text-align: justify;">Le reste est toujours d&rsquo;actualit√©, protections contre le pistage, synchronisation Firefox Sync, navigation priv√©e. Comme le d√©ploiement n&rsquo;est pas encore g√©n√©ralis√© sur la version stable, je reste en beta, qui est un peu plus stable que la preview, mais je recommande quand m√™me d&rsquo;attendre qu&rsquo;il soit plus naturellement pouss√© sur le canal stable pour l&rsquo;utiliser au quotidien, sauf si √©videmment l&rsquo;aventure ne vous fait pas peur.</p>
<h3 style="text-align: justify;">Des probl√®mes de jeunesse, extensions en t√™te</h3>
<p style="text-align: justify;">Et ce n&rsquo;est pas pour rien : si le ¬´¬†phoenix¬†¬ª impressionne par ses performances, ce n&rsquo;est pas le cas de son interface : c&rsquo;est simple, c&rsquo;est beaucoup trop limit√© par rapport au Firefox ¬´¬†original¬†¬ª, beaucoup moins de menus √† disposition, et m√™me la disparition regrettable du about:config, avec le faux pr√©texte qu&rsquo;un seul mauvais r√©glage peut faire d√©finitivement planter le navigateur, alors que c&rsquo;√©tait dispo depuis des ann√©es et que les critiques n&rsquo;√©taient pas vraiment tourn√©es vers ce genre de probl√®me.</p>
<p style="text-align: justify;">J&rsquo;√©voque les extensions, c&rsquo;est un autre gros gros manque potentiel, chaque release du navigateur vient avec une liste certes grandissante, mais tr√®s limit√©e d&rsquo;extensions valid√©es pour fonctionner avec le nouveau moteur. On atteint m√™me pas la dizaine actuellement, voici la liste :</p>
<ul style="text-align: justify;">
<li>uBlock Origin</li>
<li>Decentraleyes</li>
<li>Dark Reader</li>
<li>Privacy Badger</li>
<li>HTTPS Everywhere</li>
<li>Noscript Security Suite</li>
<li>Search by Image</li>
<li>Youtube HD</li>
<li>Privacy Possum</li>
</ul>
<p style="text-align: justify;">Certaines sont reconnues, indispensables, d&rsquo;autres sont plus cibl√©es voire √©litistes dans le cadre de Noscript, mais avouez que √ßa fait sacr√©ment chiche. Alors que j&rsquo;envisage de remplacer mon KeepassKC local par Bitwarden (via Bitwarden_rs, sur mon cluster k3s, teasing), il n&rsquo;y a pas d&rsquo;extension disponible pour le navigateur afin de remplir les champs automatiquement. C&rsquo;est plut√¥t frustrant, et je pense qu&rsquo;il y avait plus urgent que ¬´¬†Search by Image¬†¬ª par exemple pour rendre de suite le navigateur attractif. Et non, Mozilla a d√©j√† mon historique et mes trop nombreux marque-pages stock√© chez lui via Firefox Sync (parce qu&rsquo;on ne peut toujours pas installer de serveur Firefox Accounts en nodejs avec leur ersatz de documentation), pas question de stocker les identifiants chez eux. Et concernant le support futur des autres extensions, ben bon courage pour avoir des infos, manifestement personne ne sait, m√™me pas les d√©veloppeurs desdites extensions.</p>
<p style="text-align: justify;">En dehors de √ßa, j&rsquo;ai plusieurs r√©serves sur l&rsquo;interface principale, avec une dominante ¬´¬†violet sur noir¬†¬ª qui ne m&rsquo;inspire pas particuli√®rement. Ce n&rsquo;est pas fonci√®rement moche, ou tr√®s mal organis√©, mais voil√†, y&rsquo;a pas d&rsquo;effet wouahouh, j&rsquo;ai m√™me du mal avec les options de nouvel onglet, avec un syst√®me de collections dont j&rsquo;ai vraiment beaucoup de mal √† saisir l&rsquo;int√©r√™t, quand ce qui m&rsquo;int√©resse au ¬´¬†rechargement¬†¬ª c&rsquo;est d&rsquo;avoir √† minima la liste des onglets ouverts pour rapidement basculer dessus. Et l√† encore, sans extensions pour corriger √ßa&#8230;</p>
<div id="attachment_6375" style="width: 152px" class="wp-caption aligncenter"><a href="https://blog.seboss666.info/wp-content/uploads/2020/08/firefox_android_violet.jpg" rel="lightbox[6354]"><img class="size-medium wp-image-6375" src="https://blog.seboss666.info/wp-content/uploads/2020/08/firefox_android_violet-142x300.jpg" alt="" width="142" height="300" srcset="https://blog.seboss666.info/wp-content/uploads/2020/08/firefox_android_violet-142x300.jpg 142w, https://blog.seboss666.info/wp-content/uploads/2020/08/firefox_android_violet-768x1621.jpg 768w, https://blog.seboss666.info/wp-content/uploads/2020/08/firefox_android_violet-485x1024.jpg 485w, https://blog.seboss666.info/wp-content/uploads/2020/08/firefox_android_violet.jpg 1080w" sizes="(max-width: 142px) 100vw, 142px" /></a><p class="wp-caption-text">Du violet partout&#8230;</p></div>
<p style="text-align: justify;">La gestion des moteurs de recherche a aussi vu un gros retour en arri√®re en termes d&rsquo;ergonomie. Bon certes j&rsquo;utilise encore Qwant qui est facilement disponible, mais pour ceux qui ne sont pas ¬´¬†inclus¬†¬ª, il faut manuellement ajouter l&rsquo;url du champ de recherche. Alors que par le pass√©, sur un site pr√©sentant un champ de recherche, on pouvait rester appuy√© sur le champ pour l&rsquo;ajouter directement √† la liste des moteurs de recherche disponibles. Certes, 95% des lambdas continueront d&rsquo;utiliser Google, ce qui est d√©solant, mais avouez que √ßa ne semble pas compliqu√© de conserver un tel fonctionnement sur la nouvelle interface ?</p>
<div id="attachment_6377" style="width: 152px" class="wp-caption aligncenter"><a href="https://blog.seboss666.info/wp-content/uploads/2020/08/firefox_android_search_hell.jpg" rel="lightbox[6354]"><img class="size-medium wp-image-6377" src="https://blog.seboss666.info/wp-content/uploads/2020/08/firefox_android_search_hell-142x300.jpg" alt="" width="142" height="300" srcset="https://blog.seboss666.info/wp-content/uploads/2020/08/firefox_android_search_hell-142x300.jpg 142w, https://blog.seboss666.info/wp-content/uploads/2020/08/firefox_android_search_hell-768x1621.jpg 768w, https://blog.seboss666.info/wp-content/uploads/2020/08/firefox_android_search_hell-485x1024.jpg 485w, https://blog.seboss666.info/wp-content/uploads/2020/08/firefox_android_search_hell.jpg 1080w" sizes="(max-width: 142px) 100vw, 142px" /></a><p class="wp-caption-text">S√©rieux ? En 2020 ?</p></div>
<p style="text-align: justify;">Et parmi les bugs que je rencontre encore, si le t√©l√©chargement de fichiers est fonctionnel (oui √ßa n&rsquo;a pas toujours √©t√© le cas), l&rsquo;ouverture automatique dans l&rsquo;application idoine, ou l&rsquo;affichage des applications candidates √† l&rsquo;ouverture d&rsquo;un fichier, pose toujours probl√®me. J&rsquo;en viens √† t√©l√©charger le fichier, et passer par l&rsquo;explorateur de fichiers, soit celui fourni par Huawei, soit via l&rsquo;interne de VLC quand il s&rsquo;agit de podcasts, encore faut-il conna√Ætre le chemin. La peinture est encore vraiment fra√Æche.</p>
<h3 style="text-align: justify;">C&rsquo;est de la bombe pour les usages l√©gers</h3>
<p style="text-align: justify;">On le voit donc, ce ¬´¬†Firefox nouveau¬†¬ª n&rsquo;a probablement pas un go√ªt de banane, mais ses performances font sourire et dans le bon sens du terme. Cela s&rsquo;est cependant traduit par une finition tr√®s in√©gale, une couverture fonctionnelle tr√®s imparfaite, et il reste beaucoup de chemin √† parcourir. C&rsquo;est plut√¥t √©trange de voir Mozilla rusher la sortie, quand bien m√™me la stabilit√© est au rendez-vous pour le canal stable (c&rsquo;est peu l&rsquo;objectif de son nom), avec des cons√©quences plus importantes peut-√™tre que pour la transition Quantum pour les versions de bureau, qui ont pu se faire de mani√®re beaucoup plus graduelles.</p>
<p style="text-align: justify;">Maintenant on peut comprendre Mozilla : l&rsquo;ancienne version est un boulet qu&rsquo;ils se tra√Ænent depuis un peu trop longtemps, et avec les r√©centes annonces sur <a href="https://www.nextinpact.com/article/43368/mozilla-licencie-250-personnes-quete-rentabilite-au-premier-plan" target="_blank" rel="noopener">les restrictions de personnel</a> qui se profilent, il est essentiel de se d√©barrasser des versions obsol√®tes pour n&rsquo;avoir que l&rsquo;essentiel, un navigateur mobile par√© pour le futur, un futur qu&rsquo;il doit rattraper rapidement.</p>
]]></content:encoded>
            <wfw:commentRss>https://blog.seboss666.info/2020/08/firefox-pour-android-le-renouveau-imparfait-une-fois-de-plus/feed/</wfw:commentRss>
            <slash:comments>10</slash:comments>
        </item>
        <item>
            <title>DroidCam : c&#8217;est cool, mais √ßa pourrait √™tre bien mieux</title>
            <link>https://blog.seboss666.info/2020/06/droidcam-cest-cool-mais-ca-pourrait-etre-bien-mieux/</link>
            <comments>https://blog.seboss666.info/2020/06/droidcam-cest-cool-mais-ca-pourrait-etre-bien-mieux/#respond</comments>
            <pubDate>Sat, 13 Jun 2020 09:01:05 +0000</pubDate>
            <dc:creator><![CDATA[Seboss666]]></dc:creator>
            <category><![CDATA[Astuces]]></category>
            <category><![CDATA[android]]></category>
            <category><![CDATA[laptop]]></category>
            <category><![CDATA[linux]]></category>
            <category><![CDATA[qualit√©]]></category>
            <category><![CDATA[smartphone]]></category>
            <category><![CDATA[webcam]]></category>
            <category><![CDATA[windows]]></category>

            <guid isPermaLink="false">https://blog.seboss666.info/?p=6324</guid>
            <description><![CDATA[Avec le confinement, il se trouve que je n&#8217;ai pas pu voir ma s≈ìur depuis le nouvel an. Idem pour ma m√®re, qui de son [...]]]></description>
            <content:encoded><![CDATA[<p style="text-align: justify;">Avec le confinement, il se trouve que je n&rsquo;ai pas pu voir ma s≈ìur depuis le nouvel an. Idem pour ma m√®re, qui de son c√¥t√© s&rsquo;est flingu√© le dos. Pour organiser une visioconf√©rence de ¬´¬†consolation¬†¬ª, j&rsquo;ai red√©couvert √† quel point les webcam integr√©es dans les laptop sont affreuses. Et si on tentait le smartphone en guise de rempla√ßant ?</p>
<p style="text-align: justify;"><span id="more-6324"></span></p>
<p style="text-align: justify;">Il n&rsquo;y a qu&rsquo;√† voir les rageux fans d&rsquo;Apple gueuler sur la qualit√© m√©diocre (c&rsquo;est m√™me pire que √ßa : <a href="https://www.macg.co/mac/2020/05/webcam-mediocre-sur-les-macbook-quelles-solutions-la-place-113867" target="_blank" rel="noopener">c&rsquo;est moins bon qu&rsquo;avant</a>) de la cam int√©gr√©e aux derniers macbook pro qui coutent deux smic pour comprendre le probl√®me : m√™me chez Apple qui fait rarement dans le compromis, un composant pourtant peu on√©reux par rapport au reste de la machine se retrouve √™tre juste honteux. Apple, qui vante les qualit√©s de son application Facetime, qui utilise une source vid√©o affreuse, √ßa fait t√¢che dans le tableau.</p>
<p style="text-align: justify;">Mais il ne faut pas croire que le probl√®me est sp√©cifique √† la marque √† la pomme, sans vouloir aller jusqu&rsquo;√† des webcam 4k60fps int√©gr√©es (on a pas souvent les r√©seaux pour envoyer une telle image, sans parler de la d√©coder √† l&rsquo;autre bout de la ¬´¬†ligne¬†¬ª), la diff√©rence flagrante de la qualit√© des webcams compar√©es aux √©volutions constantes ann√©e apr√®s ann√©e des capteurs de smartphone me rend perplexe, √† croire qu&rsquo;on ne peut pas capitaliser sur ces √©volutions. Je suis de pr√®s l&rsquo;apparition des mod√®les de laptop qui sortent avec une plateforme Ryzen 4000 (partie CPU de Ryzen 3000 et GPU Vega en 7nm), et le constat est le m√™me √† chaque fois : quelque soit la cible de l&rsquo;appareil, la webcam est au maximum en 720p 30fps, ce qui est d√©sormais limite en 2020. Je demande pas la lune, mais avoir au moins du fullHD avec en bonus, sur les hauts de gamme, du 60FPS, me parait loin d&rsquo;√™tre impossible ni trop cher en 2020, non ?</p>
<p style="text-align: justify;">Arrive quand m√™me l&rsquo;horreur : la webcam du PC de ma m√®re. Un mod√®le 17&Prime; Asus √† base de Core i3 4000m d&rsquo;il y a donc six ans, fourni avec Windows 8.1, dont la webcam est sobrement intitul√©e ¬´¬†USB Camera¬†¬ª. Le mieux que j&rsquo;ai pu apprendre est qu&rsquo;elle est fabriqu√©e par Realtek, mais je n&rsquo;ai rien trouv√© d&rsquo;autre comme r√©f√©rence ni pilote, car c&rsquo;est celui de Microsoft qui est utilis√©, et qui date de&#8230; 2006. Vous la sentez la merde ?</p>
<p style="text-align: justify;"><a href="https://blog.seboss666.info/wp-content/uploads/2020/06/droidcam_integrated_pc_webcam.jpg" rel="lightbox[6324]"><img class="aligncenter size-medium wp-image-6333" src="https://blog.seboss666.info/wp-content/uploads/2020/06/droidcam_integrated_pc_webcam-300x145.jpg" alt="" width="300" height="145" srcset="https://blog.seboss666.info/wp-content/uploads/2020/06/droidcam_integrated_pc_webcam-300x145.jpg 300w, https://blog.seboss666.info/wp-content/uploads/2020/06/droidcam_integrated_pc_webcam.jpg 687w" sizes="(max-width: 300px) 100vw, 300px" /></a></p>
<p style="text-align: justify;">Voil√†, et encore, c&rsquo;est une image fixe, en 640&#215;480 donc, la r√©solution que j&rsquo;utilisais pour mon √©cran en 2002. Et je vous √©pargne la photo le soir avec 4 fois moins de lumi√®re. Dans la pratique en vid√©o si on arrive √† obtenir 10 images par seconde c&rsquo;est tout le bout du monde. Alors imaginez quand un Skype vous √©tire √ßa sur l&rsquo;int√©gralit√© de votre √©cran 16 pouces (celui de ma s≈ìur), √ßa donne quelque chose de tellement immonde que je renonce √† vous l&rsquo;afficher, pour pr√©server votre sant√© mentale et visuelle.</p>
<h3 style="text-align: justify;">Le smartphone en remplacement ?</h3>
<p style="text-align: justify;">J&rsquo;avais d√©j√† eu cette id√©e dans le pass√©, sans avoir √©t√© au bout de la d√©marche en cherchant et en testant, mais avec l&rsquo;id√©e de la comparaison naturelle entre la qualit√© d&rsquo;image des smartphones m√™me d&rsquo;entr√©e de gamme (en gros, pour le prix d&rsquo;une Logitech StreamCam, on a un smartphone 4G complet avec un √©cran de 6&Prime;&#8230;),¬† cette exp√©rimentation a naturellement refait surface. Entre le d√©bit d&rsquo;image, la r√©solution, la gestion de la lumi√®re bien plus optimale, les possibilit√©s √©ventuelles sur le zoom et j&rsquo;en passe, bref, c&rsquo;est une aventure qui se tente.</p>
<p style="text-align: justify;">J&rsquo;ai donc eu l&rsquo;occasion de faire le test sur deux ordiphones diff√©rents : mon Huawei P20 Lite dont il est pr√©vu que je vous donne des nouvelles pour ses deux ans, et le Huawei Y5 version 2019. Mais tout smartphone Android un peu r√©cent fera l&rsquo;affaire, pour peu qu&rsquo;il ait un peu de patate quand m√™me, parce qu&rsquo;on a vu la diff√©rence entre les deux d√©j√†, on va le voir.</p>
<h3 style="text-align: justify;">DroidCam, l&rsquo;application de r√©f√©rence</h3>
<p style="text-align: justify;">Malgr√© son nom, DroidCam est techniquement disponible sur Android et iOS, et les applications PC Windows ET Linux sont √©galement de la partie. Oui oui, aussi pour Linux, mais j&rsquo;ai eu l&rsquo;occasion de faire le test d&rsquo;abord sur Windows, comme √ßa pas de jaloux.</p>
<p style="text-align: justify;">Pour rappel, l&rsquo;application fonctionne en deux parties : la partie install√©e sur mobile capture l&rsquo;image du t√©l√©phone et cr√©e un ¬´¬†serveur vid√©o¬†¬ª, qu&rsquo;on peut ensuite soit consulter directement dans un navigateur (on a que l&rsquo;image), soit contacter via l&rsquo;appli client sur PC qui va cr√©er une webcam virtuelle pour y transmettre le flux r√©cup√©r√© sur le t√©l√©phone. On peut aussi capturer le son du smartphone, mais pour avoir tent√© de faire un comparatif, la qualit√© du micro ambiant du smartphone n&rsquo;est pas forc√©ment plus agr√©able que le micro int√©gr√© du laptop, et on est toujours √† des ann√©es lumi√®re des micro-casques donc&#8230; Deux modes de fonctionnement sont possibles, le premier simple via le wifi/r√©seau local, le deuxi√®me via USB qui demande un peu plus de manipulations que je n&rsquo;ai pas test√©.</p>
<p style="text-align: justify;">Premier constat : les devs sont bons, les applications aussi bien mobiles que PC sont simples et tr√®s fonctionnelles. Par contre, leur site web <a href="http://www.dev47apps.com/" target="_blank" rel="noopener">c&rsquo;est de la merde en barre</a> : aucun menu de navigation, ni de moteur de recherche, on doit sauter de page en page pour tenter de trouver nos informations (j&rsquo;en ai surtout eu besoin pour la partie Linux, j&rsquo;y reviendrai). On se croirait revenu sur un de mes premiers essais de site web en 1998 en cours d&rsquo;informatique en seconde.</p>
<p style="text-align: justify;">Deuxi√®me constat : l&rsquo;application mobile existe en deux versions, une ¬´¬†gratuite¬†¬ª et une payante. Je mets gratuite entre guillemets parce qu&rsquo;on sait que d√©sormais, l&rsquo;affichage de publicit√© n&rsquo;a rien d&rsquo;innocent et d√©sint√©ress√© dans l&rsquo;univers Google et du Web en g√©n√©ral. Pire, et l√† c&rsquo;est vraiment gonfl√© de leur part, <a href="https://www.dev47apps.com/droidcam/hd-mode/" target="_blank" rel="noopener">la r√©solution du flux vid√©o du smartphone est limit√©e</a>, dans la version gratuite, √† 640&#215;480. On garde les autres avantages comme la gestion de la lumi√®re et la fluidit√© relative √† la puissance du smartphone, mais merde, on est plus en 2002. La version payante propose en plus une t√©trachi√©e d&rsquo;options suppl√©mentaires qui permettent de contr√¥ler plusieurs √©l√©ments du smartphone directement depuis l&rsquo;appli, comme le zoom, l&rsquo;autofocus, la balance des blancs, l&rsquo;allumage du flash, etc, mais ils auraient au moins pu amener le 720p par d√©faut quoi !</p>
<h3 style="text-align: justify;">Usage sous Windows, avec le laptop de ma m√®re</h3>
<p style="text-align: justify;">Comme je l&rsquo;ai √©voqu√©, l&rsquo;application est simple, efficace, s&rsquo;installe sans pourrir votre PC. On aimerait voir des freeware comme √ßa plus respectueux de nos machines en 2020 ! L&rsquo;interface est simple, on lance, on saisit l&rsquo;adresse IP du t√©l√©phone (et le port si on s&rsquo;est amus√© √† le changer), et une seconde apr√®s on a l&rsquo;image qui doit s&rsquo;afficher, sauf si on a laiss√© le t√©l√©phone sur la table √©videmment <img src="https://s.w.org/images/core/emoji/11/72x72/1f600.png" alt="üòÄ" class="wp-smiley" style="height: 1em; max-height: 1em;" /> Mais il suffit d√®s lors de cadrer l&rsquo;image qu&rsquo;on souhaite partager. En fonction des t√©l√©phones et de l&rsquo;usage final, on peut poser le ¬´¬†capteur¬†¬ª contre l&rsquo;√©cran , √ßa masquera une petite partie de celui-ci mais si on n&rsquo;a rien √† manipuler en paral√®lle, √ßa peut le faire.</p>
<p style="text-align: justify;">Ensuite sous Skype, on s√©lectionne la webcam ¬´¬†DroidCam¬†¬ª et on constate le r√©sultat :</p>
<p style="text-align: justify;"><a href="https://blog.seboss666.info/wp-content/uploads/2020/06/droidcam_smartphone_webcam.jpg" rel="lightbox[6324]"><img class="aligncenter size-medium wp-image-6334" src="https://blog.seboss666.info/wp-content/uploads/2020/06/droidcam_smartphone_webcam-300x145.jpg" alt="" width="300" height="145" srcset="https://blog.seboss666.info/wp-content/uploads/2020/06/droidcam_smartphone_webcam-300x145.jpg 300w, https://blog.seboss666.info/wp-content/uploads/2020/06/droidcam_smartphone_webcam.jpg 666w" sizes="(max-width: 300px) 100vw, 300px" /></a>On a la m√™me r√©solution, mais on est √† des ann√©es lumi√®re en termes de qualit√© et de fluidit√©. Ma s≈ìur me l&rsquo;a fait remarquer quand on s&rsquo;est amus√© √† faire un comparatif entre les deux <img src="https://s.w.org/images/core/emoji/11/72x72/1f600.png" alt="üòÄ" class="wp-smiley" style="height: 1em; max-height: 1em;" /> En clair, solution valid√©e, m√™me pour ma maman quand elle se retrouvera autonome pour √ßa.</p>
<h3 style="text-align: justify;">Usage sous Linux, laptop pro et perso (c&rsquo;est pareil)</h3>
<p style="text-align: justify;">Pareil parce que les deux sont sous Manjaro, la seule diff√©rence c&rsquo;est que sur le PC du boulot je suis rest√© en noyau 4.19, alors que sur mon perso c&rsquo;est du noyau 5.4. Oui, que du LTS. Je vous expliquerai probablement pourquoi sur le laptop du boulot j&rsquo;ai du revenir au 4.19 en 2020, c&rsquo;est marrant aussi. Enfin dans les deux cas, j&rsquo;ai pu faire fonctionner le syst√®me sans trop de probl√®mes, mais √©videmment, √ßa n&rsquo;a pas √©t√© aussi fluide que sous Windows. L&rsquo;installation aucun souci, <a href="https://aur.archlinux.org/packages/droidcam" target="_blank" rel="noopener">via AUR</a> c&rsquo;est d&rsquo;une simplicit√© absolue. Mais la suite&#8230;</p>
<p style="text-align: justify;">D&rsquo;abord, le module noyau v4l2loopback-dc qui permet de cr√©er la webcam virtuelle n&rsquo;est pas charg√© par d√©faut, il faut manuellement ¬´¬†modprober¬†¬ª ce qui se fait en mode administrateur. On a vu plus souple, le point positif c&rsquo;est que le module est fourni via <a href="https://fr.wikipedia.org/wiki/Dynamic_Kernel_Module_Support" target="_blank" rel="noopener">DKMS</a> il est donc mis √† jour proprement en cas d&rsquo;update noyau. Et c&rsquo;est l√† en fait que j&rsquo;ai d√©couvert la limitation de la r√©solution, le module cr√©e par d√©faut une webcam en 640&#215;480, m√™me si le flux est en r√©solution sup√©rieure. Il faut aller modifier, toujours en mode administrateur, le fichier de configuration du module pour changer les param√®tres (pensez √† cr√©er le fichier chez vous s&rsquo;il n&rsquo;existe pas d√©j√†) :</p>
<p></p><pre class="crayon-plain-tag">#cat /etc/modprobe.d/v4l2loopback-dc.conf
options v4l2loopback_dc width=960 height=720</pre><p></p>
<p style="text-align: justify;">Ensuite d√©charger le module (modprobe -r), et le recharger, parce qu&rsquo;√©videmment les param√®tres ne sont pas pris √† chaud. Et attention, si on met une sortie qui n&rsquo;est pas dans le m√™me format que la source, l&rsquo;image est d√©form√©e. Dans mon cas j&rsquo;ai quand m√™me pouss√© jusqu&rsquo;√† 720p, √ßa √©tire un peu le flux d&rsquo;origine mais comme je garde le ratio, c&rsquo;est moins d√©gueulasse. On constate quand m√™me une l√©g√®re augmentation du bruit visible en faible luminosit√©.</p>
<p style="text-align: justify;">Ensuite, la gestion du son est encore √† part et vu les manipulations de la documentation j&rsquo;ai abandonn√© direct. On parle de module Alsa, qui reste semble-t-il toujours aux commandes alors qu&rsquo;on manipule pulseaudio au quotidien, donc j&rsquo;ai du mal √† comprendre comment √ßa fonctionne. 2020, et la gestion du son sous Linux a encore 20 ans de retard sur Windows, et on se demande pourquoi Linux ne s&rsquo;impose toujours pas&#8230;</p>
<p style="text-align: justify;">Enfin, une fois la partie ¬´¬†bas niveau¬†¬ª en place, on peut lancer l&rsquo;application qui a exactement la m√™me t√™te que sous Windows, donc adresse IP √† saisir, et ensuite, on s√©lectionne la cam√©ra dans Skype/Teams. La bonne surprise cependant, c&rsquo;est que l√† o√π dans l&rsquo;application Windows on me dit que les contr√¥les sont r√©serv√©s √† la version DroidCamX (donc payante), sous Linux je peux contr√¥ler le zoom, l&rsquo;autofocus et le flash¬† <img src="https://s.w.org/images/core/emoji/11/72x72/1f600.png" alt="üòÄ" class="wp-smiley" style="height: 1em; max-height: 1em;" /> Sur le laptop boulot on a donc une webcam avec la m√™me r√©solution, mais l&rsquo;ouverture est plus large, l&rsquo;image plus fine et lumineuse et la fluidit√© un peu meilleure. Sur le laptop perso, la webcam fait d√©j√† du 720p avec une gestion relativement propre de la lumi√®re, la fluidit√© n&rsquo;est pas parfaite mais √ßa peut suffire pour des petites visio-conf√©rences. Y&rsquo;a quand m√™me du bruit donc faut pas √™tre exigeant sur la qualit√© de l&rsquo;image.</p>
<h3 style="text-align: justify;">L&rsquo;alternative qui n&rsquo;a pas fonctionn√© pour moi</h3>
<p style="text-align: justify;">J&rsquo;ai cherch√© √† voir si une option permettant une meilleure qualit√© sans devoir balancer sa carte bancaire √† Google existait. Il semblerait, elle s&rsquo;appelle Iriun Webcam, dont le fonctionnement est siimilaire √† savoir appli mobile+appli desktop. Il permet d&rsquo;exploiter la 4K si le t√©l√©phone le permet, mais de mon c√¥t√©, j&rsquo;ai rencontr√© beaucoup de probl√®mes. D√©j√†, l&rsquo;installation avec <a href="https://aur.archlinux.org/packages/iriunwebcam-bin" target="_blank" rel="noopener">le paquet AUR</a> d√©conne parce que le md5 de l&rsquo;archive t√©l√©charg√©e par le script d&rsquo;installation n&rsquo;est pas le m√™me. Les d√©veloppeurs n&rsquo;ont pas sp√©cialement envie de penser qu&rsquo;on est sur PC et qu&rsquo;on a besoin de contr√¥les de versions, donc j&rsquo;ai tent√© l&rsquo;installation √† la main (on clone le d√©pot AUR, on modifie le PKGBUILD, et makepkg -si dans la foul√©e). Mais une fois v4l2loobpack manuellement charg√© au niveau du noyau (module officiel pour faire une webcam virtuelle) et le logiciel lanc√©, ben √©cran noir sur la capture, pourtant le smartphone indique bien que la connexion est √©tablie. Aussi, le flux semble coup√© tr√®s tr√®s r√©guli√®rement, du coup, au bout d&rsquo;un quart d&rsquo;heure de manipulations sans r√©sultat, j&rsquo;ai l√¢ch√© l&rsquo;affaire.</p>
<p style="text-align: justify;">Je ne l&rsquo;ai pas test√© non plus sous Windows, si vous avez exp√©riment√© avec h√©sitez pas √† partager, √† ce moment de l&rsquo;histoire j&rsquo;ai d√©cid√© que j&rsquo;avais autre chose √† faire que de d√©bugger des applis qui ne me donnent d√©j√† pas beaucoup d&rsquo;infos sur leur fonctionnement.</p>
<h3 style="text-align: justify;">√áa manque cruellement d&rsquo;open-source</h3>
<p style="text-align: justify;">Car oui, tous les √©l√©ments test√©s ici ne sont pas open-source. Et c&rsquo;est un vrai probl√®me des deux c√¥t√©s, aussi bien au niveau du smartphone o√π l&rsquo;on d√©pend du store ferm√© de Google ou d&rsquo;Apple, que du c√¥t√© du PC o√π l&rsquo;on ne peut pas forc√©ment s&rsquo;assurer que l&rsquo;application n&rsquo;en fait pas un peu trop, pour un logiciel qui a acc√®s √† la webcam. Sur Linux, comme √ßa d√©pend d&rsquo;un module noyau (modifi√© dans le cas de DroidCam), c&rsquo;est un peu tendu pour s&rsquo;assurer du suivi du bon support lors des mont√©es de version (m√™me si globalement l&rsquo;infrastructure v4l2 est assez stable).</p>
<p style="text-align: justify;">Il y a bien eu une application appel√©e <a href="https://sourceforge.net/projects/smartcam/files/" target="_blank" rel="noopener">SmartCam</a>, dont les fichiers sont toujours disponibles, mais elle n&rsquo;a pas √©t√© mise √† jour depuis 2013 voire plus vieux encore pour certains, et autant dire que √ßa commence √† faire vraiment trop dans le monde de l&rsquo;informatique.</p>
<p style="text-align: justify;">En attendant, et vu la qualit√© du r√©sultat m√™me avec une r√©solution d√©cevante avec la version gratuite, vous avez une solution de rechange pour les webcam int√©gr√©es aux laptop, ou pour votre PC de bureau. Y&rsquo;a juste un truc que j&rsquo;ai pas vraiment abord√© : le fait qu&rsquo;il faut poser le t√©l√©phone dans une position pas trop d√©savantageuse pour votre visage <img src="https://s.w.org/images/core/emoji/11/72x72/1f600.png" alt="üòÄ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<p style="text-align: justify;"><strong>PS</strong> : c&rsquo;est √©vident pour certains, mais je rappelle que si vous √™tes moche comme moi √† la base, une bonne webcam ou un bon smartphone n&rsquo;y changera rien. On verra juste mieux √† quel point vous √™tes moche <img src="https://s.w.org/images/core/emoji/11/72x72/1f600.png" alt="üòÄ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
]]></content:encoded>
            <wfw:commentRss>https://blog.seboss666.info/2020/06/droidcam-cest-cool-mais-ca-pourrait-etre-bien-mieux/feed/</wfw:commentRss>
            <slash:comments>0</slash:comments>
        </item>
        <item>
            <title>Un peu d&#8217;amour pour le blog (et la VM en g√©n√©ral)</title>
            <link>https://blog.seboss666.info/2020/06/un-peu-damour-pour-le-blog-et-la-vm-en-general/</link>
            <pubDate>Tue, 02 Jun 2020 16:30:09 +0000</pubDate>
            <dc:creator><![CDATA[Seboss666]]></dc:creator>
            <category><![CDATA[Editos]]></category>
            <category><![CDATA[conflit]]></category>
            <category><![CDATA[debian]]></category>
            <category><![CDATA[dette]]></category>
            <category><![CDATA[m√©nage]]></category>
            <category><![CDATA[php]]></category>
            <category><![CDATA[rationalisation]]></category>
            <category><![CDATA[sources]]></category>
            <category><![CDATA[versions]]></category>
            <category><![CDATA[wordpress]]></category>

            <guid isPermaLink="false">https://blog.seboss666.info/?p=6303</guid>
            <description><![CDATA[Vous connaissez l&#8217;adage qui dit que les cordonniers sont les plus mal chauss√©s ? Dans mon cas c&#8217;√©tait incroyablement vrai, ma procrastination sur la maintenance [...]]]></description>
            <content:encoded><![CDATA[<p style="text-align: justify;">Vous connaissez l&rsquo;adage qui dit que les cordonniers sont les plus mal chauss√©s ? Dans mon cas c&rsquo;√©tait incroyablement vrai, ma procrastination sur la maintenance de tout √ßa √©tant incroyablement puissante. J&rsquo;ai quand m√™me fini par me mettre √† la t√¢che, et j&rsquo;ai d√©cid√© de d√©tailler pour que l&rsquo;on comprenne bien le probl√®me afin d&rsquo;√©viter de le reproduire.</p>
<p style="text-align: justify;"><span id="more-6303"></span></p>
<h3 style="text-align: justify;">Le champ de bataille</h3>
<p style="text-align: justify;">Nous sommes donc sur une VM bloqu√©e en Debian 8, avec les installations notables suivantes :</p>
<ul style="text-align: justify;">
<li>PHP 5.6 des d√©pots Jessie pour les scripts legacy</li>
<li>PHP 7.0 des d√©pots <a href="https://www.dotdeb.org/instructions/" target="_blank" rel="noopener">Dotdeb</a> (la r√©f√©rence de l&rsquo;√©poque quand je l&rsquo;ai install√©)</li>
<li>PHP 7.3 des d√©pots <a href="https://deb.sury.org/" target="_blank" rel="noopener">Sury</a>, d&rsquo;abord pour Matomo dont les derni√®res versions commandaient un PHP support√©.</li>
<li>Redis de d√©pot Dotdeb</li>
<li>nginx-http2 du d√©pot d√©di√© Dotdeb</li>
</ul>
<p style="text-align: justify;">Et surtout, d&rsquo;anciennes traces d&rsquo;installation d&rsquo;<a href="https://www.ispconfig.org/" target="_blank" rel="noopener">ISPConfig</a>, qu&rsquo;on se tra√Æne encore comme un boulet parfois sans savoir pourquoi on a des soucis. On le voit, je ne suis pas vraiment mon propre conseil d&rsquo;essayer de limiter les sources externes de paquets, mais avec le temps et l&rsquo;√¢ge d&rsquo;une Debian, proposer des technos r√©centes (PHP7+ et HTTP2 entre autres), c&rsquo;est compliqu√©. Pareil pour les mont√©es de versions qui sont compliqu√©es par les op√©rations pass√©es et l&rsquo;activit√© des scripts.</p>
<div id="attachment_6308" style="width: 310px" class="wp-caption aligncenter"><a href="https://blog.seboss666.info/wp-content/uploads/2020/06/sac_de_noeuds.jpg" rel="lightbox[6303]"><img class="size-medium wp-image-6308" src="https://blog.seboss666.info/wp-content/uploads/2020/06/sac_de_noeuds-300x225.jpg" alt="" width="300" height="225" srcset="https://blog.seboss666.info/wp-content/uploads/2020/06/sac_de_noeuds-300x225.jpg 300w, https://blog.seboss666.info/wp-content/uploads/2020/06/sac_de_noeuds.jpg 500w" sizes="(max-width: 300px) 100vw, 300px" /></a><p class="wp-caption-text">Installation de la VM, all√©gorie</p></div>
<p style="text-align: justify;">De cette installation, j&rsquo;en ai tir√© notamment un conflit √† l&rsquo;installation du module Redis sur PHP 7.3 √† cause du nom du package qui bute avec les fichiers de celui de php 7.0 de Dotdeb. J&rsquo;avais pas fait attention quand j&rsquo;avais install√© PHP 7.3 en ce mois de Janvier, et j&rsquo;avais du coup perdu deux mois de visites sur Matomo (c&rsquo;est lui qui demandait PHP 7.3 pour ses mises √† jour), parce que le plugin Queued Tracking qui stocke les visites dans Redis avant enregistrement d√©finitif renvoyait une erreur 500 parce que les commandes Redis n&rsquo;existent pas. Et comme l&rsquo;interface fonctionnait au moment o√π j&rsquo;ai bascul√©, j&rsquo;ai pas percut√©. Oui, je suis un boulet.</p>
<h3 style="text-align: justify;">Travail pr√©paratoire</h3>
<p style="text-align: justify;">L&rsquo;intervention a donc d&rsquo;abord √©t√© l&rsquo;occasion d&rsquo;un gros gros inventaire et surtout d&rsquo;un nettoyage de scripts inutiles, de vhosts inexistants et non fonctionnels, de pools php qui vont avec ou orphelins (vhosts nettoy√©s mais php toujours l√†), bref, les confs PHP et Nginx sont beaucoup plus claires sur ce qui est r√©ellement en activit√© sur le serveur.</p>
<p style="text-align: justify;">J&rsquo;en ai √©galement profit√© pour proc√©der √† un d√©m√©nagement de certains vhosts annexes sur PHP 7.3, comme mon FreshRSS qui me remercie grandement. Au passage, au fur et √† mesure je rend agnostique le chemin du socket, √ßa permet de changer facilement de version sans avoir √† bidouiller plusieurs fichiers. L√†, je d√©place le fichier de conf du pool d&rsquo;une version de PHP √† l&rsquo;autre, je red√©marre celui qui ne sert plus, je red√©marre celui qui servira, je teste. Le retour arri√®re est √† peu pr√®s aussi rapide.</p>
<p style="text-align: justify;">√áa a aussi permis de virer quelques packages, et j&rsquo;ai √©t√© surpris, parce qu&rsquo;en fait, PHP 5.6 n&rsquo;√©tait plus utilis√© ni d√©marr√©, il a donc fini √† la poubelle. Autre d√©couverte, apache2 est √©galement toujours install√© !? Il a rejoint PHP 5.6. J&rsquo;ai potentiellement vir√© un ou deux autres trucs d√©couverts par hasard, mais pas forc√©ment en lien direct avec le bordel du jour.</p>
<h3 style="text-align: justify;">On attaque la butte</h3>
<p style="text-align: justify;">Ce coup-ci, on rendre dans le dur. Je commence par r√©activer les d√©p√¥ts Sury pour tenter de mettre √† jour les paquets PHP 7.0 de Dotdeb vers PHP 7.0 Sury. L&rsquo;op√©ration a pris du temps, mais s&rsquo;est bien termin√©e, modulo quelques paquets restants. En effet, ils n&rsquo;ont pas le m√™me nom chez Sury. Je les supprime donc (paquets li√©s au module redis) et je r√©installe la version Sury. Et √ßa s&rsquo;est super bien pass√© !</p>
<p style="text-align: justify;">Il restait quelques √©l√©ments √† supprimer pour √™tre d√©finitivement tranquille. Le m√©ta-paquet ¬´¬†php¬†¬ª va installer la derni√®re r√©vision de PHP en date, soit PHP 7.4. Et d√©sormais, je n&rsquo;ai plus de conflit √† l&rsquo;installation de paquets PHP 7.x. Au passage, il y a des diff√©rences entre PHP 7.0 et php 7.3, mais dans certains cas ils sont juste inutiles donc pas la peine de les installer. D&rsquo;autres n&rsquo;existent plus comme mcrypt, on va voir juste apr√®s la cons√©quence.</p>
<h3 style="text-align: justify;">Ce que le nettoyage a permis</h3>
<p style="text-align: justify;">J&rsquo;ai pu r√©installer le QueuedTracking de Matomo, qui permet un gain de temps substantiel dans le chargement de la page puisque la visite est enregistr√©e dans Redis avant d&rsquo;√™tre trait√©e et enregistr√©e dans la base de donn√©es en arri√®re-plan par Matomo. Moins d&rsquo;attente dans le chargement d&rsquo;une page de votre c√¥t√©, et comme de toute fa√ßon je suis pas √† la seconde pour la tra√ßabilit√©, √ßa peut prendre le temps que √ßa veut pour enregistrer (ou pas, en fonction des d√©tails envoy√©s comme le DNT).</p>
<p style="text-align: justify;">J&rsquo;ai aussi profit√© pour virer le d√©pot Dotdeb pour m&rsquo;assurer que je ne risquais pas d&rsquo;installer quelque chose qui provient de chez eux. Il ne reste que celui d√©di√© √† Nginx qui n&rsquo;a de toute fa√ßon pas √©t√© mis √† jour depuis un moment (oui je sais&#8230;), mais comme il ne contient pas de paquets PHP c&rsquo;est pas grave. J&rsquo;ai d&rsquo;ailleurs fait le m√©nage sur deux/trois autres d√©p√¥ts qui ne servent plus et qui pour certains √©taient d√©j√† d√©sactiv√©s. Moins de d√©p√¥ts activ√©s, veut dire mises √† jour et installations qui prennent moins de temps.</p>
<p style="text-align: justify;">Une seule source de PHP, plus de conflit (je crois que je l&rsquo;ai d√©j√† dit), veut dire aussi passage √† de futures versions facilit√©, ou presque. En effet, en fonction de l&rsquo;√¢ge des scripts/applications install√©es, √ßa peut se vautrer dans les grandes largeurs avec une version qui supprime une ou plusieurs fonctions qui servent √† ceux-ci. et dans mon cas, mon WordPress va encore avoir besoin d&rsquo;un peu d&rsquo;amour pour tenter une grosse mont√©e de version avant de pouvoir b√©n√©ficier d&rsquo;une mont√©e de version de PHP (et quand je vois le gain sur FreshRSS, √ßa fait plus qu&rsquo;envie). J&rsquo;ai quand m√™me tent√© l&rsquo;upgrade vers PHP 7.2, pour l&rsquo;instant je ne constate pas d&rsquo;erreur, malgr√© l&rsquo;√¢ge de certains √©l√©ments (plugins pas maintenus entre autres). Il faudra quand m√™me que je termine cette satan√©e migration vers WordPress 5 pour m&rsquo;assurer de ne plus avoir de probl√®me et pouvoir continuer les migrations.</p>
<div id="attachment_6309" style="width: 310px" class="wp-caption aligncenter"><a href="https://blog.seboss666.info/wp-content/uploads/2020/06/monsieur-propre.jpg" rel="lightbox[6303]"><img class="size-medium wp-image-6309" src="https://blog.seboss666.info/wp-content/uploads/2020/06/monsieur-propre-300x166.jpg" alt="" width="300" height="166" srcset="https://blog.seboss666.info/wp-content/uploads/2020/06/monsieur-propre-300x166.jpg 300w, https://blog.seboss666.info/wp-content/uploads/2020/06/monsieur-propre.jpg 500w" sizes="(max-width: 300px) 100vw, 300px" /></a><p class="wp-caption-text">moi √† la fin de l&rsquo;apr√®s-midi</p></div>
<p style="text-align: justify;">J&rsquo;√©tais chaud du coup j&rsquo;ai proc√©d√© un peu pareil sur le VPS qui porte l&rsquo;installation de LibreNMS. ce VPS avait d√©j√† subi une sale mont√©e de version de Debian √† l&rsquo;arrache, OVH avait eu la tr√®s mauvaise id√©e de juste laisser ¬´¬†stable¬†¬ª dans la configuration des d√©pots, mais comme je ne fais pas de dist-upgrade en auto, √ßa s&rsquo;√©tait fini en simili Debian 9 avec des d√©pendances et le noyau de Debian 8. L√† encore, j&rsquo;avais le PHP 5.6 de Debian 8 encore install√© sur Debian 9, alors qu&rsquo;il ne servait plus √† rien.</p>
<h3 style="text-align: justify;">Le n√©cessaire d√©m√©nagement</h3>
<p style="text-align: justify;">Je me suis concentr√© aujourd&rsquo;hui sur les probl√®mes li√©s √† PHP et au blog (tiens au passage, le r√©cent probl√®me li√© √† <a href="https://wordpress.org/support/topic/update-1-11-13-broke-the-site/" target="_blank" rel="noopener">Broken Link Checker</a> a √©t√© compliqu√© √† r√©gler, mais c&rsquo;est fait). Mais on l&rsquo;a vu, il reste des horreurs comme le nginx custom, et la VM, avec son √¢ge, a plusieurs autres tares, dont ces fameux relents d&rsquo;ISPConfig. Faire la mont√©e de version en place ne m&rsquo;int√©resse pas et causerait certainement plus de probl√®me qu&rsquo;elle n&rsquo;en r√©soudrait, il est temps de mettre l&rsquo;installation √† la retraite pour repartir sur du neuf, un peu comme un gros m√©nage de printemps ne remplace pas un d√©m√©nagement dans l&rsquo;efficacit√© √† virer les choses accumul√©es depuis des ann√©es.</p>
<p style="text-align: justify;">Et √ßa fait partie des choses que je pr√©parais pour le futur proche, mais c&rsquo;√©tait dans l&rsquo;optique d&rsquo;un certain budget allouable qui ne sera pas possible cette ann√©e (merci SARS-Cov-2). J&rsquo;ai donc des plans √† revoir pour quand m√™me avancer sur le sujet sans me faire trop mal au porte-monnaie, en attendant, je suis content du r√©sultat des travaux.</p>
<p style="text-align: justify;"><strong>PS</strong> : j&rsquo;avais pr√©venu sur Twitter que ¬´¬†<a href="https://twitter.com/Seboss666/status/1267389606330339329" target="_blank" rel="noopener">√ßa va couper ch√©rie</a>¬†¬ª le temps que je bosse dessus. On m&rsquo;a demand√© pourquoi j&rsquo;ai pas boss√© sur une seconde VM √† c√¥t√© et bascul√© une fois termin√©. D√©j√† parce qu&rsquo;il y a pas mal de choses sur cette VM, et pas seulement le blog : autres sites, serveurs de discussion vocales, etc. Ensuite, la configuration r√©seau n&rsquo;a jamais √©t√© pens√©e pour permettre ce genre de bascule simple, la machine est directement expos√©e avec son IP publique, sans pare-feu ni reverse-proxy devant, pas de Docker, pas de pare-feu autre que celui du noyal. Donc j&rsquo;ai boss√© ¬´¬†en live¬†¬ª, ce qui n&rsquo;√©tait pas plus mal pour permettre de d√©couvrir l&rsquo;√©tendue des d√©g√¢ts potentiels. Mais certains aspects pourraient changer dans la future infra.</p>
]]></content:encoded>
        </item>
        <item>
            <title>Analyse pouss√©e d&#8217;un code malveillant PHP, deuxi√®me round</title>
            <link>https://blog.seboss666.info/2020/05/analyse-poussee-dun-code-malveillant-php-deuxieme-round/</link>
            <comments>https://blog.seboss666.info/2020/05/analyse-poussee-dun-code-malveillant-php-deuxieme-round/#comments</comments>
            <pubDate>Fri, 08 May 2020 16:40:33 +0000</pubDate>
            <dc:creator><![CDATA[Seboss666]]></dc:creator>
            <category><![CDATA[Divers]]></category>
            <category><![CDATA[Sysadmin]]></category>
            <category><![CDATA[analyse]]></category>
            <category><![CDATA[cryptolocker]]></category>
            <category><![CDATA[infection]]></category>
            <category><![CDATA[javascript]]></category>
            <category><![CDATA[navigateur]]></category>
            <category><![CDATA[php]]></category>
            <category><![CDATA[redirection]]></category>
            <category><![CDATA[s√©curit√©]]></category>
            <category><![CDATA[SEO]]></category>

            <guid isPermaLink="false">https://blog.seboss666.info/?p=6263</guid>
            <description><![CDATA[Pour ceux que la s√©curit√© informatique int√©resse un peu, j&#8217;avais d√©j√† fait une sorte de pas √† pas d&#8217;analyse d&#8217;un code PHP masqu√© pour tenter [...]]]></description>
            <content:encoded><![CDATA[<p style="text-align: justify;">Pour ceux que la s√©curit√© informatique int√©resse un peu, j&rsquo;avais d√©j√† fait une sorte de pas √† pas <a href="https://blog.seboss666.info/2018/05/decoder-un-script-php-malveillant-comment-sen-proteger/" target="_blank" rel="noopener">d&rsquo;analyse d&rsquo;un code PHP masqu√©</a> pour tenter d&rsquo;en comprendre le fonctionnement. J&rsquo;ai pu mettre la main r√©cemment sur un nouveau morceau de choix, car mon analyse m&rsquo;a pouss√© beaucoup plus loin. Let&rsquo;s go ?</p>
<p style="text-align: justify;"><span id="more-6263"></span></p>
<p style="text-align: justify;">Le code qu&rsquo;on avait analys√© en substance n&rsquo;√©tait l√† que pour permettre de d√©poser d&rsquo;autres fichiers. Basique, mais toujours pratique √† garder sous la main. Ici, je suis tomb√© sur un morceau beaucoup plus int√©ressant, qui m&rsquo;a pris deux bonnes heures pour noter tout ce que je vous partage aujourd&rsquo;hui. Je vais volontairement masquer certains √©l√©ments comme l&rsquo;URL finale, histoire de pas trop diriger les gens vers des √©l√©ments qui peuvent potentiellement endommager leur appareil ou en tout cas ses donn√©es.</p>
<p style="text-align: justify;">Petit contexte rapide aussi, le minist√®re de la Culture remonte un probl√®me avec un lien vers un site (celui de mon client) qui redirigeait vers des sites louches. Alors que normalement je ne touche plus que tr√®s rarement √† ce genre de situation dans mon quotidien, le client avec qui je bosse en parall√®le sur une refonte de sa plateforme m&rsquo;a contact√© directement. Comme je suis quelqu&rsquo;un de faible qui aime ce genre de situation, j&rsquo;interviens √©videmment <img src="https://s.w.org/images/core/emoji/11/72x72/1f600.png" alt="üòÄ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<h3 style="text-align: justify;">L&rsquo;enqu√™te de surface</h3>
<p style="text-align: justify;">J&rsquo;attaque par une fouille rapide de l&rsquo;arborescence, en suivant la logique du code : un bout de JavaScript inject√© en bas de page via le fichier index.php, qui remonte √† plus de deux mois, et j&rsquo;identifie un code PHP inject√© dans une d√©pendance qui remonte √† plus de deux ans (un oubli de nettoyage d&rsquo;une pr√©c√©dente intervention, erf).</p>
<p style="text-align: justify;">J&rsquo;ai pris le r√©flexe de faire une copie de toutes mes trouvailles pour analyse √† froid avant de faire le m√©nage rapidement, et rassurer le minist√®re de la Culture que c&rsquo;√©tait bon, qu&rsquo;ils pouvaient remettre le lien en ligne. C&rsquo;est plusieurs jours plus tard que j&rsquo;ai attaqu√© la v√©ritable enqu√™te.</p>
<p style="text-align: justify;">Le JavaScript en substance proc√©dait √† du <a href="http://www.blackhat-seo.fr/" target="_blank" rel="noopener">Black Hat SEO</a>, il √©tait embarqu√© dans une div parlant de Louis Vuitton en anglais (sur un site fran√ßais), div qui √©tait accompagn√©e par le code JavaScript obfusqu√© :</p>
<p style="text-align: justify;"><a href="https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_indexjs.png" rel="lightbox[6263]"><img class="aligncenter size-medium wp-image-6276" src="https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_indexjs-300x118.png" alt="" width="300" height="118" srcset="https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_indexjs-300x118.png 300w, https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_indexjs-768x303.png 768w, https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_indexjs-1024x404.png 1024w, https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_indexjs.png 1296w" sizes="(max-width: 300px) 100vw, 300px" /></a>On remplace le deuxi√®me <code>eval()</code> par un <code>document.write()</code> et le tour est jou√© :</p>
<p style="text-align: justify;"><a href="https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_indexjs_showed.png" rel="lightbox[6263]"><img class="aligncenter size-medium wp-image-6273" src="https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_indexjs_showed-300x22.png" alt="" width="300" height="22" srcset="https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_indexjs_showed-300x22.png 300w, https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_indexjs_showed.png 526w" sizes="(max-width: 300px) 100vw, 300px" /></a>La div √©tait donc masqu√©e, mais sa pr√©sence dans le code source suffit √† faire son effet sur les robots d&rsquo;indexation. Et c&rsquo;est donc le PHP qui m&rsquo;a donn√© du fil √† retordre, on va voir pourquoi.</p>
<h3 style="text-align: justify;">¬´¬†-Scalpel ? -Scalpel.¬†¬ª</h3>
<p style="text-align: justify;">Voyons donc le petit saligaud :</p>
<p style="text-align: justify;"><a href="https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_raw.png" rel="lightbox[6263]"><img class="aligncenter size-medium wp-image-6277" src="https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_raw-300x122.png" alt="" width="300" height="122" srcset="https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_raw-300x122.png 300w, https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_raw-768x311.png 768w, https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_raw-1024x415.png 1024w, https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_raw.png 1292w" sizes="(max-width: 300px) 100vw, 300px" /></a></p>
<p style="text-align: justify;">C&rsquo;est pas beau hein ? Bon le fait est que la premi√®re √©tape va √™tre beaucoup plus facile √† analyser parce qu&rsquo;il n&rsquo;y aura pas cinquante √©tapes de traduction des fonctions, ici j&rsquo;√©pure et je remplace l&rsquo;eval par un echo. Voici le r√©sultat :</p>
<p style="text-align: justify;"><a href="https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_deciphered.png" rel="lightbox[6263]"><img class="aligncenter size-medium wp-image-6278" src="https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_deciphered-300x141.png" alt="" width="300" height="141" srcset="https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_deciphered-300x141.png 300w, https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_deciphered-768x361.png 768w, https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_deciphered-1024x481.png 1024w, https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_deciphered.png 1359w" sizes="(max-width: 300px) 100vw, 300px" /></a>Pas tr√®s beau √† lire, mais les barbouillis ne concernent que les noms des variables, √ßa va √™tre cool. On a donc plusieurs √©l√©ments ici qu&rsquo;on va d√©tailler bloc par bloc.</p>
<p style="text-align: justify;">La premi√®re ligne est une arme nucl√©aire ou presque : elle traite le contenu d&rsquo;une requ√™te POST, si elle trouve une cl√© &lsquo;pf&rsquo; dont le contenu moulin√© avec md5 correspond √† ce qui est demand√©, √ßa ex√©cute le code PHP encod√© en base64 qui doit se trouver dans une autre cl√© &lsquo;cookies_p&rsquo;. Vous avez l√† un petit moteur d&rsquo;ex√©cution de code distant, ce qu&rsquo;on appelle dans le m√©tier une RCE. En pratique √ßa fait partie des pires failles de s√©curit√© qu&rsquo;on remonte dans les programmes, ici, l&rsquo;attaquant s&rsquo;est donc laiss√© une porte grande ouverte. Dans la pratique il est pour l&rsquo;instant limit√© √† l&rsquo;utilisateur PHP, mais rien ne l&#8217;emp√™che de tenter des escalades de privil√®ges, c&rsquo;est m√™me possible de proc√©der √† des extractions de donn√©es sans m√™me plus de difficult√©s. Vous l&rsquo;aurez compris, il est d√©sormais compliqu√© de pouvoir continuer de faire confiance au serveur. Mais c&rsquo;est pas tout.</p>
<p style="text-align: justify;">√Ä partir de la ligne 9, on a un code que je n&rsquo;avais encore jamais eu l&rsquo;occasion de voir et qui m&rsquo;intrigue beaucoup. Il s&rsquo;av√®re que le code tente d&rsquo;identifier si la requ√™te a √©t√© faite par un humain, un robot d&rsquo;indexation de moteur de recherche, ou un humain mais en local (ce qui peut √™tre le site lui-m√™me). En gros, si c&rsquo;est un humain, on va parser tout le contenu de la variable $_SERVER pour en faire un flux qu&rsquo;on va envoyer via une requ√™te POST sur une URL distante. Je vous laisse avec <a href="https://www.php.net/manual/en/reserved.variables.server.php" target="_blank" rel="noopener">la documentation de PHP</a> pour voir tout ce que peut contenir cette variable $_SERVER, c&rsquo;est plut√¥t d√©taill√© et complet.</p>
<p style="text-align: justify;">Cette URL est toujours en ligne, le whois du domaine ne dit rien mais l&rsquo;adresse IP est h√©berg√©e en Ukraine. Le script appel√© sans param√®tre r√©pond vide mais un code 200, il semble donc toujours d&rsquo;actualit√©. J&rsquo;ai donc d√©cid√© de tenter de rejouer le code pour voir son comportement.</p>
<p style="text-align: justify;">J&rsquo;ai pris quelques minutes pour tenter de crafter moi-m√™me ce contenu de $_SERVER. Pour ce faire, j&rsquo;ai √©crit un micro code PHP :</p>
<p></p><pre class="crayon-plain-tag">&lt;?php

var_dump($_SERVER);</pre><p></p>
<p style="text-align: justify;">J&rsquo;ai ensuite d√©marr√© un micro serveur Apache avec module PHP embarqu√© via une image docker random trouv√©e sur le hub, flemmardise totale mais √ßa suffit pour l&rsquo;exercice :</p>
<p></p><pre class="crayon-plain-tag">docker run --rm -p 8000:80 --name "apache-php" -v "${PWD}/index.php":/var/www/html/index.php newdeveloper/apache-php</pre><p></p>
<p style="text-align: justify;">Et j&rsquo;ouvre ce fichier index.php via mon navigateur sur l&rsquo;adresse 127.0.0.1 et sur le port 8000. Voil√† le r√©sultat :</p>
<p style="text-align: justify;"><a href="https://blog.seboss666.info/wp-content/uploads/2020/04/php_mal_server_craft.png" rel="lightbox[6263]"><img class="aligncenter wp-image-6266 size-large" src="https://blog.seboss666.info/wp-content/uploads/2020/04/php_mal_server_craft-1024x76.png" alt="" width="860" height="64" srcset="https://blog.seboss666.info/wp-content/uploads/2020/04/php_mal_server_craft-1024x76.png 1024w, https://blog.seboss666.info/wp-content/uploads/2020/04/php_mal_server_craft-300x22.png 300w, https://blog.seboss666.info/wp-content/uploads/2020/04/php_mal_server_craft-768x57.png 768w" sizes="(max-width: 860px) 100vw, 860px" /></a>N&rsquo;√©tant pas un expert en regex de porc et feignant comme pas deux pour faire un parsing, j&rsquo;ai fait le gros sale √† base de copier/coller dans un fichier pour ensuite modifier ce contenu pour en faire une vraie affectation de tableau en PHP pour la variable $_SERVER. J&rsquo;ai ensuite fait une copie du code en question, pour voir ce que le file_get_contents() r√©cup√©rait, mais une fois encore on fait un echo √† la place du eval.</p>
<p style="text-align: justify;"><a href="https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_url_response.png" rel="lightbox[6263]"><img class="aligncenter wp-image-6279 size-large" src="https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_url_response-1024x25.png" alt="" width="860" height="21" srcset="https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_url_response-1024x25.png 1024w, https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_url_response-300x7.png 300w, https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_url_response-768x19.png 768w" sizes="(max-width: 860px) 100vw, 860px" /></a>Oh ben tiens dis donc, le code PHP r√©cup√©r√© et ex√©cut√© injecte un header Location avec une URL bizarre, ce qui a pour effet de rediriger le visiteur vers cette URL. Je m&rsquo;attarde pas sur le base64, il fait la m√™me chose mais via du code HTML si pour une raison ou pour une autre le code PHP a d√©j√† envoy√© ses headers avant l&rsquo;ex√©cution de cette portion (ce qui se traduit par une erreur fatale en PHP&#8230;).</p>
<p style="text-align: justify;">A ce moment-l√†, je vous conseille de vous pr√©parer avant de faire les cons. Soit vous tentez l&rsquo;URL via curl, mais il ne vous retournera que le html brut. Soit vous tentez dans un navigateur, et l√† vous avez int√©r√™t √† √™tre blind√©, √† jour, voir √† d√©sactiver dans un premier temps l&rsquo;ex√©cution de Javascript et l&rsquo;analyser/le charger manuellement si vous le sentez.</p>
<p style="text-align: justify;">Pourquoi ? Oh, trois fois rien. Apr√®s deux/trois redirections, le navigateur s&rsquo;est bloqu√© sur une page qui affiche un b√™te ¬´¬†Loading&#8230;¬†¬ª, et n&rsquo;a rien fait de plus chez moi. Mais en analysant la r√©ponse, c&rsquo;est assez impressionnant :</p>
<p style="text-align: justify;"><a href="https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_js_raw.png" rel="lightbox[6263]"><img class="aligncenter size-medium wp-image-6280" src="https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_js_raw-300x167.png" alt="" width="300" height="167" srcset="https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_js_raw-300x167.png 300w, https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_js_raw-768x427.png 768w, https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_js_raw-1024x570.png 1024w, https://blog.seboss666.info/wp-content/uploads/2020/05/php_mal_js_raw.png 1461w" sizes="(max-width: 300px) 100vw, 300px" /></a>Oui, ce n&rsquo;est que du code JavaScript. Je suis pas expert, et c&rsquo;est √† mon avis fait expr√®s qu&rsquo;il soit aussi tordu, mais malgr√© tout, en le parcourant en diagonale, on finit par comprendre qu&rsquo;on vient de charger un outil soit de minage de cryptomonnaie, soit plus plausible un <a href="https://fr.wikipedia.org/wiki/CryptoLocker" target="_blank" rel="noopener">CryptoLocker</a>, ce qui est d√©j√† beaucoup plus p√©nible si √ßa passe les protections du navigateur. Et ce que vous voyez √† droite est la taille du code, vu de ¬´¬†tr√®s haut¬†¬ª. C&rsquo;est donc tr√®s long, et tr√®s dense. J&rsquo;ai pas insist√© sur la lecture, j&rsquo;ai envie de garder un semblant de sant√© mentale.</p>
<h3 style="text-align: justify;">Verdict : on √©vite le code zombie</h3>
<p style="text-align: justify;">Le reste de l&rsquo;analyse n&rsquo;a pas permis d&rsquo;identifier de truc cach√©, y compris des fichiers ¬´¬†images¬†¬ª qui sont en fait des scripts PHP. En posant la question j&rsquo;apprends que le code concern√© a √©t√© r√©alis√© il y a plus de dix ans par des stagiaires, et qu&rsquo;il n&rsquo;a √©t√© ni corrig√©, ni mis √† jour depuis cette date. J&rsquo;avais d√©j√† eu un indice avec le fait que le code √©tait ¬´¬†full fran√ßais¬†¬ª : nom des variables et des fonctions, commentaires, noms des fichiers et des dossiers, tout y √©tait. L&rsquo;autre indice √©tait l&rsquo;organisation m√™me du code qui ressemblait bizarrement √† mes tous premiers projets persos, ceux avant le peu glorieux Collect pour ceux qui voudraient rigoler de mon niveau en d√©veloppement PHP.</p>
<p style="text-align: justify;">Il tourne de plus sur une machine dont la gestion des mises √† jour et des mont√©es de version d&rsquo;environnements d&rsquo;ex√©cutions est inexistante : OS en fin de vie, PHP non support√©, la totale. N&rsquo;importe qui vous le dira : la s√©curit√© informatique, c&rsquo;est une cha√Æne, aussi forte que le maillon le plus faible. Mettez vos serveurs et vos logiciels √† jour, mais laissez un code zombie comme celui-l√† mal con√ßu et c&rsquo;est grand ouvert pour se faire infecter et faire joujou avec toutes sortes de saloperies, et tous les autres efforts fournis n&rsquo;auront servi √† rien. Je sais, c&rsquo;est plus facile √† dire qu&rsquo;√† faire, et j&rsquo;en suis le premier exemple, actuellement il ne faut pas trop regarder sous le capot du blog, l&rsquo;installation tient plus du bidonville que du Palace. le chantier est au programme, mais sans date pr√©cise pour le moment.</p>
<p style="text-align: justify;">Il y a tout de m√™me quelques techniques pour limiter les d√©g√¢ts, la plupart d√©j√† partag√©es dans <a href="https://blog.seboss666.info/category/series/securisation-serveur/" target="_blank" rel="noopener">ma s√©rie sur la s√©curisation d&rsquo;un serveur</a>, mais au d√©tour d&rsquo;une question Twitter on m&rsquo;a rappel√© qu&rsquo;ils dataient un peu, il n&rsquo;est pas impossible dans un futur proche que je rafra√Æchisse un peu le contenu. Je ne sais pas encore quelle forme √ßa va prendre, on va d√©j√† commencer par se relire hein, on sait comment fonctionne ma m√©moire <img src="https://s.w.org/images/core/emoji/11/72x72/1f600.png" alt="üòÄ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
]]></content:encoded>
            <wfw:commentRss>https://blog.seboss666.info/2020/05/analyse-poussee-dun-code-malveillant-php-deuxieme-round/feed/</wfw:commentRss>
            <slash:comments>4</slash:comments>
        </item>
        <item>
            <title>Programmation d√©fensive en bash</title>
            <link>https://blog.seboss666.info/2020/04/programmation-defensive-en-bash/</link>
            <comments>https://blog.seboss666.info/2020/04/programmation-defensive-en-bash/#comments</comments>
            <pubDate>Mon, 27 Apr 2020 16:30:26 +0000</pubDate>
            <dc:creator><![CDATA[Seboss666]]></dc:creator>
            <category><![CDATA[Astuces]]></category>
            <category><![CDATA[bash]]></category>
            <category><![CDATA[clart√©]]></category>
            <category><![CDATA[d√©fensive]]></category>
            <category><![CDATA[pratique]]></category>
            <category><![CDATA[programmation]]></category>
            <category><![CDATA[qualit√©]]></category>
            <category><![CDATA[s√©curit√©]]></category>

            <guid isPermaLink="false">https://blog.seboss666.info/?p=2935</guid>
            <description><![CDATA[Nouvelle traduction aujourd&#8217;hui, d&#8217;un article qui risque sans pr√©venir de dispara√Ætre. La programmation d√©fensive consiste √† structurer son code pour limiter au strict minimum les [...]]]></description>
            <content:encoded><![CDATA[<p style="text-align: justify;">Nouvelle traduction aujourd&rsquo;hui, d&rsquo;un article qui risque sans pr√©venir de dispara√Ætre. La <a href="http://kfirlavi.herokuapp.com/blog/2012/11/14/defensive-bash-programming/" target="_blank" rel="noopener">programmation d√©fensive</a> consiste √† structurer son code pour limiter au strict minimum les surfaces d&rsquo;attaques. Le JDN a un article <a href="http://www.journaldunet.com/developpeur/tutoriel/theo/070831-programmation-defensive.shtml" target="_blank" rel="noopener">qui r√©sume bien</a> des concepts, mais ici, on va s&rsquo;attarder sur les scripts Bash. En effet, comme avec PHP on peut vite faire de la merde, et il est pr√©f√©rable de suivre certaines pratiques pour que leur qualit√© ne soit pas trop catastrophique quand il seront r√©utilis√©s ailleurs. Je ne les suis pas toutes, mais j&rsquo;ai trouv√© utile de les partager avec vous.</p>
<p style="text-align: justify;"><span id="more-2935"></span></p>
<h3 style="text-align: justify;">Variables globales immutables</h3>
<ul style="text-align: justify;">
<li>Essayez de limiter le nombre de variables globales</li>
<li>Nommage en majuscules</li>
<li>d√©clarations en lecture seule</li>
<li>Utilisez des variables globales pour remplacer les cryptiques $1, $0, etc</li>
<li>Les globales que j‚Äôutilise pratiquement syst√©matiquement dans mes scripts :</li>
</ul>
<p></p><pre class="crayon-plain-tag">readonly PROGNAME=$(basename $0)
readonly PROGDIR=$(readlink -m $(dirname $0))
readonly ARGS="$@"</pre><p></p>
<h3 style="text-align: justify;">Tout est local</h3>
<p style="text-align: justify;">Toutes les variables devraient √™tre locales.</p>
<p></p><pre class="crayon-plain-tag">change_owner_of_file() {
  local filename=$1
  local user=$2
  local group=$3

  chown $user:$group $filename
}


change_owner_of_files() {
  local user=$1; shift
  local group=$1; shift
  local files=$@
  local i

  for i in $files
  do
    chown $user:$group $i
  done
}</pre><p></p>
<ul style="text-align: justify;">
<li>des param√®tres ¬´¬†auto-document√©s¬†¬ª</li>
<li>Habituellement pour les boucles ont utilise ¬´¬†i¬†¬ª, il est vital de la d√©clarer comme locale</li>
<li>les variables locales ne fonctionnent pas dans un contexte global :</li>
</ul>
<p></p><pre class="crayon-plain-tag">kfir@goofy ~ $ local a
bash: local: can only be used in a function</pre><p></p>
<h3 style="text-align: justify;">main()</h3>
<ul style="text-align: justify;">
<li>Permet de conserver toutes les variables comme locales</li>
<li>Intuitif pour la programmation fonctionnelle</li>
<li>La seule commande globale dans le code est : main</li>
</ul>
<p></p><pre class="crayon-plain-tag">main() {
  local files="/tmp/a /tmp/b"
  local i

  for i in $files
    do
      change_owner_of_file kfir users $i
    done
}
main</pre><p></p>
<h3 style="text-align: justify;">Tout est une fonction</h3>
<ul style="text-align: justify;">
<li>Le seul code qui tourne globalement est
<ul>
<li>Les d√©clarations globales qui sont immutables</li>
<li>main</li>
</ul>
</li>
<li>Permet de garder un code propre</li>
<li>Les proc√©dures sont plus descriptives</li>
</ul>
<p></p><pre class="crayon-plain-tag">main() {
local files=$(ls /tmp | grep pid | grep -v daemon)
}</pre><p></p><pre class="crayon-plain-tag">temporary_files() {
  local dir=$1

  ls $dir \
    | grep pid \
    | grep -v daemon
}

main() {
  local files=$(temporary_files /tmp)
}</pre><p></p>
<ul style="text-align: justify;">
<li><em>Le deuxi√®me exemple est bien meilleur</em>. Rechercher des fichiers est le probl√®me de temporary_files() et pas celui de main(). Le code est √©galement mieux ¬´¬†testable¬†¬ª, via un test unitaire sur temporary_files().</li>
<li>Si vous testez la premi√®re version, vous m√©langez la logique de recherche du reste de main.</li>
</ul>
<p></p><pre class="crayon-plain-tag">test_temporary_files() {
  local dir=/tmp

  touch $dir/a-pid1232.tmp
  touch $dir/a-pid1232-daemon.tmp

  returns "$dir/a-pid1232.tmp" temporary_files $dir

  touch $dir/b-pid1534.tmp

  returns "$dir/a-pid1232.tmp $dir/b-pid1534.tmp" temporary_files $dir
}</pre><p></p>
<p style="text-align: justify;">Comme vous le voyez, ce test ne concerne pas main().</p>
<h3 style="text-align: justify;">Des fonctions de debug</h3>
<ul style="text-align: justify;">
<li>Lancez le programme avec le drapeau -x :</li>
</ul>
<p></p><pre class="crayon-plain-tag">bash -x my_prog.sh</pre><p></p>
<ul style="text-align: justify;">
<li>D√©buggez une portion du code en utilisant set -x et set +x, ce qui va afficher les messages de d√©bug pour le code entour√© des commandes.</li>
</ul>
<p></p><pre class="crayon-plain-tag">temporary_files() {
  local dir=$1

  set -x
  ls $dir \
    | grep pid \
    | grep -v daemon
  set +x
}</pre><p></p>
<ul style="text-align: justify;">
<li>Affichez le nom de la fonction et ses arguments :</li>
</ul>
<p></p><pre class="crayon-plain-tag">temporary_files() {
  echo $FUNCNAME $@
  local dir=$1

  ls $dir \
    | grep pid \
    | grep -v daemon
}</pre><p></p>
<p style="text-align: justify;">Donc, en appelant la fonction :</p>
<p></p><pre class="crayon-plain-tag">temporary_files /tmp</pre><p></p>
<p style="text-align: justify;">affichera sur la sortie standard :</p>
<p></p><pre class="crayon-plain-tag">temporary_files /tmp</pre><p></p>
<h3 style="text-align: justify;">Clart√© du code</h3>
<p style="text-align: justify;">Qu&rsquo;est-ce que fait ce code ?</p>
<p></p><pre class="crayon-plain-tag">main() {
  local dir=/tmp

  [[ -z $dir ]] \
    &amp;&amp; do_something...

  [[ -n $dir ]] \
    &amp;&amp; do_something...

  [[ -f $dir ]] \
    &amp;&amp; do_something...

  [[ -d $dir ]] \
    &amp;&amp; do_something...
}
main</pre><p></p>
<p style="text-align: justify;">Laissez votre code parler :</p>
<p></p><pre class="crayon-plain-tag">is_empty() {
  local var=$1

  [[ -z $var ]]
}

is_not_empty() {
  local var=$1

  [[ -n $var ]]
}

is_file() {
  local file=$1

  [[ -f $file ]]
}

is_dir() {
  local dir=$1

  [[ -d $dir ]]
}

main() {
  local dir=/tmp

  is_empty $dir \
    &amp;&amp; do_something...

  is_not_empty $dir \
    &amp;&amp; do_something...

  is_file $dir \
    &amp;&amp; do_something...

  is_dir $dir \
    &amp;&amp; do_something...
}
main</pre><p></p>
<h3 style="text-align: justify;">Chaque ligne fait une seule chose</h3>
<ul style="text-align: justify;">
<li>Sectionnez vos commandes avec des antislash <code></code>. Par exemple :</li>
</ul>
<p></p><pre class="crayon-plain-tag">temporary_files() {
  local dir=$1

  ls $dir | grep pid | grep -v daemon
}</pre><p></p>
<p style="text-align: justify;">Peut √™tre √©crit plus clairement :</p>
<p></p><pre class="crayon-plain-tag">temporary_files() {
  local dir=$1

  ls $dir \
    | grep pid \
    | grep -v daemon
}</pre><p></p>
<ul style="text-align: justify;">
<li>Les symboles doivent √™tre en d√©but de ligne. Mauvais exemple de symboles √† la fin :</li>
</ul>
<p></p><pre class="crayon-plain-tag">temporary_files() {
  local dir=$1

  ls $dir | \
    grep pid | \
    grep -v daemon
}</pre><p></p>
<p style="text-align: justify;">Bon exemple o√π l&rsquo;on voit clairement la connexion entre les les lignes et les symboles :</p>
<p></p><pre class="crayon-plain-tag">print_dir_if_not_empty() {
  local dir=$1

  is_empty $dir \
    &amp;&amp; echo "dir is empty" \
    || echo "dir=$dir"
}</pre><p></p>
<h3 style="text-align: justify;">Afficher l&rsquo;usage</h3>
<p style="text-align: justify;">Ne faites pas √ßa :</p>
<p></p><pre class="crayon-plain-tag">echo "this prog does:..."
echo "flags:"
echo "-h print help"</pre><p></p>
<p style="text-align: justify;">√áa devrait √™tre une fonction :</p>
<p></p><pre class="crayon-plain-tag">usage() {
  echo "this prog does:..."
  echo "flags:"
  echo "-h print help"
}</pre><p></p>
<p style="text-align: justify;">echo est r√©p√©t√© √† chaque ligne. A la place on a &lsquo;Here Document&rsquo; :</p>
<p></p><pre class="crayon-plain-tag">usage() {
	cat &lt;&lt;- EOF
	usage: $PROGNAME options

	Program deletes files from filesystems to release space.
	It gets config file that define fileystem paths to work on, and whitelist rules to
	keep certain files.

	OPTIONS:
		-c --config configuration file containing the rules. use --help-config to see the syntax.
		-n --pretend do not really delete, just how what you are going to do.
		-t --test run unit test to check the program
		-v --verbose Verbose. You can specify more then one -v to have more verbose
		-x --debug debug
		-h --help show this help
		   --help-config configuration help

	Examples:
		Run all tests:
		$PROGNAME --test all

		Run specific test:
		$PROGNAME --test test_string.sh

		Run:
		$PROGNAME --config /path/to/config/$PROGNAME.conf

		Just show what you are going to do:
		$PROGNAME -vn -c /path/to/config/$PROGNAME.conf
	EOF
}</pre><p></p>
<p style="text-align: justify;">Attention √† bien utiliser des tabulations &lsquo;\t&rsquo; pour le d√©but de chaque ligne. Dans vim vous pouvez utiliser cette astuce si votre tabulation consiste en 4 espaces :</p>
<p></p><pre class="crayon-plain-tag">:s/^    /\t/</pre><p></p>
<h3 style="text-align: justify;">Arguments de ligne de commande</h3>
<p style="text-align: justify;">Voici un exemple de compl√©ment √† la fonction usage d&rsquo;au-dessus. Ce code est tir√© de l&rsquo;article <a href="http://kirk.webfinish.com/2009/10/bash-shell-script-to-use-getopts-with-gnu-style-long-positional-parameters/" target="_blank" rel="noopener">bash shell script to use getopts with gnu style long positional parameters</a> sur le blog de Kirk :</p>
<p></p><pre class="crayon-plain-tag">cmdline() {
  # got this idea from here:
  # http://kirk.webfinish.com/2009/10/bash-shell-script-to-use-getopts-with-gnu-style-long-positional-parameters/
  local arg=
  for arg
  do
    local delim=""
    case "$arg" in
      #translate --gnu-long-options to -g (short options)
      --config) args="${args}-c ";;
      --pretend) args="${args}-n ";;
      --test) args="${args}-t ";;
      --help-config) usage_config &amp;&amp; exit 0;;
      --help) args="${args}-h ";;
      --verbose) args="${args}-v ";;
      --debug) args="${args}-x ";;
      #pass through anything else
      *) [[ "${arg:0:1}" == "-" ]] || delim="\""
         args="${args}${delim}${arg}${delim} ";;
    esac
  done

  #Reset the positional parameters to the short options
  eval set -- $args

  while getopts "nvhxt:c:" OPTION
  do
    case $OPTION in
      v)
          readonly VERBOSE=1
          ;;
      h)
          usage
          exit 0
          ;;
      x)
          readonly DEBUG='-x'
          set -x
          ;;
      t)
          RUN_TESTS=$OPTARG
          verbose VINFO "Running tests"
          ;;
      c)
          readonly CONFIG_FILE=$OPTARG
          ;;
      n)
          readonly PRETEND=1
          ;;
    esac
  done

  if [[ $recursive_testing || -z $RUN_TESTS ]]; then
    [[ ! -f $CONFIG_FILE ]] \
      &amp;&amp; eexit "You must provide --config file"
  fi
  return 0
}</pre><p></p>
<p style="text-align: justify;">On l&rsquo;utilise ensuite de cette fa√ßon en utilisant la variable immutable ARGS qu&rsquo;on a d√©fini au d√©but du script :</p>
<p></p><pre class="crayon-plain-tag">main() {
cmdline $ARGS
}
main</pre><p></p>
<h3 style="text-align: justify;">Tests unitaires</h3>
<ul style="text-align: justify;">
<li>Tr√®s important dans les langages de haut niveau</li>
<li>Utilisez shunit2 pour vos tests unitaires</li>
</ul>
<p></p><pre class="crayon-plain-tag">test_config_line_paths() {
  local s='partition cpm-all, 80-90,'

  returns "/a" "config_line_paths '$s /a, '"
  returns "/a /b/c" "config_line_paths '$s /a:/b/c, '"
  returns "/a /b /c" "config_line_paths '$s /a : /b : /c, '"
}

config_line_paths() {
  local partition_line="$@"

  echo $partition_line \
    | csv_column 3 \
    | delete_spaces \
    | column 1 \
    | colons_to_spaces
}

source /usr/bin/shunit2</pre><p></p>
<p style="text-align: justify;">Voici un autre exemple sur la commande df :</p>
<p></p><pre class="crayon-plain-tag">DF=df

mock_df_with_eols() {
    cat &lt;&lt;- EOF
    Filesystem           1K-blocks      Used Available Use% Mounted on
    /very/long/device/path
                         124628916  23063572 100299192  19% /
    EOF
}

test_disk_size() {
  returns 1000 "disk_size /dev/sda1"

  DF=mock_df_with_eols
  returns 124628916 "disk_size /very/long/device/path"
}

df_column() {
  local disk_device=$1
  local column=$2

  $DF $disk_device \
    | grep -v 'Use%' \
    | tr '\n' ' ' \
    | awk "{print \$$column}"
}

disk_size() {
  local disk_device=$1

  df_column $disk_device 2
}</pre><p></p>
<p style="text-align: justify;">Ici il y a une exception, pour les tests je d√©clare DF au niveau global et pas en lecture seule. C&rsquo;est parce que shunit2 n&rsquo;autorise pas les changements de fonctions au niveau global.</p>
<hr />
<p style="text-align: justify;">Les plus aguerris au d√©veloppement logiciel trouveront peut-√™tre √©vidents ces constructions de scripts, pour ma part j&rsquo;avais d√©j√† lu certains de ces conseils, notamment pour Python. C&rsquo;est sympa de voir qu&rsquo;on peut r√©utiliser les m√™mes concepts pour Bash, par d√©faut c&rsquo;est un langage particuli√®rement permissif, √† l&rsquo;image de PHP. Il n&rsquo;en faut pas plus pour que les deux se trainent une r√©putation d√©sastreuse.</p>
<p style="text-align: justify;">
]]></content:encoded>
            <wfw:commentRss>https://blog.seboss666.info/2020/04/programmation-defensive-en-bash/feed/</wfw:commentRss>
            <slash:comments>10</slash:comments>
        </item>
        <item>
            <title>D√©ployer un service Consul, mais surtout le s√©curiser !</title>
            <link>https://blog.seboss666.info/2020/04/deployer-un-service-consul-mais-surtout-le-securiser/</link>
            <comments>https://blog.seboss666.info/2020/04/deployer-un-service-consul-mais-surtout-le-securiser/#comments</comments>
            <pubDate>Mon, 20 Apr 2020 16:30:28 +0000</pubDate>
            <dc:creator><![CDATA[Seboss666]]></dc:creator>
            <category><![CDATA[Sysadmin]]></category>
            <category><![CDATA[acl]]></category>
            <category><![CDATA[consul]]></category>
            <category><![CDATA[docker]]></category>
            <category><![CDATA[protection]]></category>
            <category><![CDATA[stockage]]></category>
            <category><![CDATA[terraform]]></category>

            <guid isPermaLink="false">https://blog.seboss666.info/?p=6241</guid>
            <description><![CDATA[Maintenant que j&#8217;ai r√©cup√©r√© la main compl√®te sur le destin de l&#8217;infrastructure publique dont fait partie le serveur qui h√©berge le blog, je pr√©pare le [...]]]></description>
            <content:encoded><![CDATA[<p style="text-align: justify;">Maintenant que j&rsquo;ai r√©cup√©r√© la main compl√®te sur le destin de l&rsquo;infrastructure publique dont fait partie le serveur qui h√©berge le blog, je pr√©pare le futur, et ce futur passe par de l&rsquo;infrastructure as code, notamment avec Terraform et Ansible. Pour le premier, un √©l√©ment important du r√©sultat est le fichier d&rsquo;√©tat de l&rsquo;infrastructure, le fameux ¬´¬†tfstate¬†¬ª. Et pour le garder au chaud, j&rsquo;ai voulu utiliser, plut√¥t qu&rsquo;un fichier texte sur le pc, un service Consul. Mais il ne faut pas faire n&rsquo;importe quoi avec.</p>
<p style="text-align: justify;"><span id="more-6241"></span></p>
<h3 style="text-align: justify;">Le parfait compagnon de Terraform</h3>
<p style="text-align: justify;">Consul fait partie d&rsquo;une famille qu&rsquo;on appelle service de stockage dit cl√©-valeur, comme Redis, m√™me si ce dernier a une forte orientation ¬´¬†temporaire¬†¬ª car il sert souvent de m√©moire cache. Il est d√©velopp√© par Hashicorp, la m√™me boite qui s&rsquo;occupe aussi de Terraform. Il est donc nativement inclus comme backend de stockage pour y conserver son pr√©cieux fichier tfstate.</p>
<p style="text-align: justify;">Vous pourrez √©galement y stocker quantit√© de donn√©es qui pourront √™tre r√©utilis√©es par la suite. Un de nos clients chez Linkbynet l&rsquo;utilise par exemple pour y enregistrer ses besoins en termes de projets et d&rsquo;infrastructures li√©es (nom du projet, nombre de machines, dimensionnements, nommages des ressources), et on n&rsquo;a plus qu&rsquo;√† lancer un pipeline qui va lire les valeurs et d√©ployer l&rsquo;infrastructure en fonction de ces donn√©es. Les usages sont donc multiples.</p>
<p style="text-align: justify;">√âvidemment, disposer d&rsquo;un ¬´¬†serveur¬†¬ª consul n&rsquo;a de sens que si on doit acc√©der √† plusieurs machines √† ces donn√©es, l&rsquo;avoir en local est pratique pour faire des tests, mais superflu par rapport √† un fichier plat local, notamment dans le cadre de Terraform.</p>
<h3 style="text-align: justify;">Un d√©ploiement sur Docker Swarm tr√®s rapide</h3>
<p style="text-align: justify;">Le service n&rsquo;a pas besoin d&rsquo;√™tre r√©pliqu√© vu l&rsquo;usage basique, les volumes persistants ont √©t√© cr√©√©s sur le NAS, et la stack est presque basique, je la partage quand m√™me :</p>
<p></p><pre class="crayon-plain-tag">version: "3.2"
networks:
  consul:
    driver: overlay

volumes:
  consul_data:
    driver_opts:
      type: nfs
      o: "addr=192.168.1.200,rw,nfsvers=3,nolock,soft,exec"
      device: ":/volume1/Docker/consul/data"
  consul_config:
    driver_opts:
      type: nfs
      o: "addr=192.168.1.200,rw,nfsvers=3,nolock,soft,exec"
      device: ":/volume1/Docker/consul/config"
services:
  consul:
    image: consul:1.7.2
    environment:
      - "CONSUL_BIND_INTERFACE=eth0"
      - "CONSUL_HTTP_ADDR=0.0.0.0"
    entrypoint:
      - consul
      - agent
      - -server
      - -bootstrap-expect=1
      - -config-format
      - json
      - -config-file
      - /consul/config/consul-acl.json
      - -data-dir=/consul/data
      - -bind={{ GetInterfaceIP "eth0" }}
      - -client=0.0.0.0
      - -ui

    networks:
      - consul
    ports:
      - "8500:8500"
      - "8600:8600/udp"
    volumes:
      - type: volume
        source: consul_data
        target: /consul/data
      - type: volume
        source: consul_config
        target: /consul/config
    deploy:
      replicas: 1
      restart_policy:
        condition: any</pre><p></p>
<p style="text-align: justify;">La partie importante pour un d√©ploiement ¬´¬†docker prod ready¬†¬ª, c&rsquo;est l&rsquo;entrypoint qui contient les commandes permettant de bien faire prendre en compte l&rsquo;initialisation des ACL et l&rsquo;activation du mode ¬´¬†bootstrap¬†¬ª qui sinon laisse le serveur en mode ¬´¬†dev¬†¬ª, avec moults messages de debug pratique, mais surtout un mode ¬´¬†in-memory¬†¬ª qui va un peu √† l&rsquo;envers de ce qu&rsquo;on cherche √† faire √† savoir disposer d&rsquo;un stockage persistant.</p>
<h3 style="text-align: justify;">Donn√©es pr√©cieuses, s√©curit√© adapt√©e</h3>
<p style="text-align: justify;">En effet, par d√©faut, c&rsquo;est grand ouvert. Quelque soit le mode de d√©ploiement, vous lancez, deux secondes apr√®s vous pouvez enregistrer votre premi√®re cl√©. On va pas se mentir, c&rsquo;est pas dingue. Si quelqu&rsquo;un vient foutre le bordel, notamment sur votre fichier d&rsquo;√©tat, vous serez bon pour tout reprendre √† la main. Pour un ou deux serveurs, c&rsquo;est pas grave, quand vous d√©ployez plusieurs dizaines de ressources diff√©rentes d&rsquo;un coup, √ßa fait bien mal au cul. Il est donc n√©cessaire de mettre en place un certain niveau de protection.</p>
<h4 style="text-align: justify;">Le transport</h4>
<p style="text-align: justify;">Tout d&rsquo;abord, il faut garder √† l&rsquo;esprit que les communications se font en HTTP. C&rsquo;est donc un minimum que de chiffrer le transport. Plusieurs options sont possibles en fonction du contexte.</p>
<p style="text-align: justify;">Pour un serveur qui restera dans un r√©seau un peu priv√© et un acc√®s semi-manuel (ex√©cution d&rsquo;outils sur son poste), on pourra utiliser un tunnel SSH avec transfert de port. On utilisera la forme suivante :</p>
<p></p><pre class="crayon-plain-tag">$ ssh -L 8500:&lt;consul_ip&gt;:8500 &lt;consul_ip|consul_host&gt;</pre><p></p>
<p style="text-align: justify;">Ensuite, si vous interrogez le port local 8500, la connexion sera renvoy√©e √† travers la connexion SSH pour interroger le port 8500 en face.</p>
<p style="text-align: justify;">Dans mon cas, comme j&rsquo;ai d√©ploy√© le consul dans mon cluster Docker swarm, j&rsquo;ai voulu passer par le reverse-proxy plut√¥t que le SSH. J&rsquo;ai donc d√©ploy√© du HTTPS avec un sous-domaine d√©di√© et du Let&rsquo;s Encrypt. C&rsquo;est plus pratique dans ce dernier cas car consul peut √™tre acc√©d√© par des outils tiers, comme un runner gitlab, et aussi, je peux utiliser n&rsquo;importe quel PC sans forc√©ment avoir mes cl√©s SSH sur moi. Notez que dans un cas comme dans l&rsquo;autre (SSH ou TLS), on est g√©n√©ralement sur des hauts niveaux de protection donc √ßa va.</p>
<h4 style="text-align: justify;">L&rsquo;authentification</h4>
<p style="text-align: justify;">Bien, le transport est chiffr√©, mais dans le cas d&rsquo;HTTPS par exemple, √ßa ne r√©sout pas un probl√®me fondamental : si on conna√Æt l&rsquo;adresse, on fait ce qu&rsquo;on veut du serveur. Fort heureusement, il est possible de mettre plusieurs choses en place.</p>
<p style="text-align: justify;">La premi√®re qui est presque syst√©matique sur les services que j&rsquo;expose sur mon cluster Swarm, je met en place une authentification HTTP basique, qui repose sur un couple user/password que je g√©n√®re quand je d√©ploie le vhost sur le reverse-proxy. Sans ce couple, vous prenez une erreur 401 de la part d&rsquo;Nginx. Les r√®gles classiques se posent alors, entre longueur de mots de passe et complexit√©. Dans le cas pr√©sent o√π c&rsquo;est con√ßu d&rsquo;abord pour √™tre exploit√© via des outils, la saisie manuelle n&rsquo;√©tant pas n√©cessaire tout le temps je conseille de ne pas l√©siner sur la longueur, pas de probl√®me √† disposer de couples de 32 caract√®res chacun, le tout bien al√©atoire avec une palette √©tendue (alphanum√©rique, majuscule/minuscules, ponctuation). On √©vite quand m√™me les emoji dans les login ou mots de passe qu&rsquo;on commence √† voir appara√Ætre, d√©j√† c&rsquo;est p√©nible √† taper sans clavier adapt√©, et croyez-le ou non √ßa a tendance √† bien faire bugger les programmes, malgr√© les promesses d&rsquo;UTF-8.</p>
<p style="text-align: justify;">Consul de son c√¥t√© dispose d&rsquo;un syst√®me d&rsquo;ACL qui semble bien fourni, mais que j&rsquo;ai pour l&rsquo;instant bien du mal √† mettre en place. La faute √† <a href="https://www.consul.io/api/acl/acl.html" target="_blank" rel="noopener">une documentation</a> bien moins fournie et claire que peut l&rsquo;√™tre celle de Terraform, ou mieux celle d&rsquo;Ansible qui regorge d&rsquo;exemple pour tous les modules support√©s permettant de mieux comprendre leur fonctionnement. L√† si l&rsquo;activation du moteur ACL est assez facile, la mise en place des r√®gles de contr√¥le d&rsquo;acc√®s, et la cr√©ation du token, semblent plus compliqu√©s, sans parler de tester manuellement derri√®re, avec curl entre autres. Mais ceci dit, les ACL vous permettront notamment de limiter les actions d&rsquo;une cl√© √† certaines portions du serveur consul, ce qui permet d&rsquo;√©viter d&rsquo;aller polluer les voisins.</p>
<p style="text-align: justify;">√Ä retenir, vous pouvez tout √† fait activer les deux m√©thodes en m√™me temps, Terraform permet de renseigner les informations pour les deux types de protection, il suffit d&rsquo;initialiser le backend avec les options suivantes :</p>
<p></p><pre class="crayon-plain-tag">$ terraform init -backend=true \
    -backend-config="address=${CONSUL_ADDRESS}" \
    -backend-config="scheme=${CONSUL_SCHEME}" \
    -backend-config="http_auth=${CONSUL_USERNAME}:${CONSUL_PASSWORD}" \
    -backend-config="access_token=${CONSUL_TOKEN}" \
    -backend-config="path=${CONSUL_PATH}" \
    -backend-config="lock=${CONSUL_LOCK}"</pre><p></p>
<h3 style="text-align: justify;">Un outil versatile</h3>
<p style="text-align: justify;">Ici vous n&rsquo;avez entrevu qu&rsquo;un usage de Consul, mais il a plusieurs autres qualit√©s que je vous laisse d√©couvrir avec <a href="https://www.consul.io/" target="_blank" rel="noopener">le site officiel</a>. Je l√¢che pas l&rsquo;affaire sur les ACL, j&rsquo;ai beau reconna√Ætre l&rsquo;avantage de ce syst√®me de gestion de permissions, j&rsquo;ai toujours du mal avec les diff√©rentes impl√©mentations, j&rsquo;ai pleur√© avec celles de Mumble par exemple, pareil pour Teamspeak 3, donc autant dire que √ßa va mettre un peu de temps. Mais je d√©sesp√®re pas <img src="https://s.w.org/images/core/emoji/11/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
]]></content:encoded>
            <wfw:commentRss>https://blog.seboss666.info/2020/04/deployer-un-service-consul-mais-surtout-le-securiser/feed/</wfw:commentRss>
            <slash:comments>2</slash:comments>
        </item>
        <item>
            <title>Haproxy : OpenVPN ou SSH ?</title>
            <link>https://blog.seboss666.info/2020/04/haproxy-openvpn-ou-ssh/</link>
            <comments>https://blog.seboss666.info/2020/04/haproxy-openvpn-ou-ssh/#comments</comments>
            <pubDate>Fri, 17 Apr 2020 16:30:27 +0000</pubDate>
            <dc:creator><![CDATA[Seboss666]]></dc:creator>
            <category><![CDATA[Astuces]]></category>
            <category><![CDATA[Sysadmin]]></category>
            <category><![CDATA[bastion]]></category>
            <category><![CDATA[filtrage]]></category>
            <category><![CDATA[haproxy]]></category>
            <category><![CDATA[https]]></category>
            <category><![CDATA[openvpn]]></category>
            <category><![CDATA[protocole]]></category>
            <category><![CDATA[routage]]></category>
            <category><![CDATA[ssh]]></category>
            <category><![CDATA[tls]]></category>

            <guid isPermaLink="false">https://blog.seboss666.info/?p=6153</guid>
            <description><![CDATA[Je n&#8217;utilise pas du tout Haproxy √† titre personnel, mes contacts n&#8217;ont √©t√© que professionnels, et principalement pour du load-balancing HTTP/HTTPS. Mais il est tout [...]]]></description>
            <content:encoded><![CDATA[<p style="text-align: justify;">Je n&rsquo;utilise pas du tout Haproxy √† titre personnel, mes contacts n&rsquo;ont √©t√© que professionnels, et principalement pour du load-balancing HTTP/HTTPS. Mais il est tout √† fait possible de s&rsquo;en servir pour d&rsquo;autres usages, en mode TCP, c&rsquo;est √† dire en mode ¬´¬†brut¬†¬ª. Et l√†, √ßa permet de faire des choses de tar√©s, et l&rsquo;astuce d&rsquo;aujourd&rsquo;hui en est une, partager le port 443 pour faire soit du SSH, soit de l&rsquo;OpenVPN. Z&rsquo;√™tes pr√™ts ?</p>
<p style="text-align: justify;"><span id="more-6153"></span></p>
<h3 style="text-align: justify;">Le concept</h3>
<p style="text-align: justify;">Oui parce que l&rsquo;id√©e ne sort pas de nulle part non plus. Sur le papier d√©j√†, il faut savoir que n&rsquo;importe quel port peut √™tre utilis√© pour n&rsquo;importe quel protocole. √áa n&#8217;emp√™che pas les RFC de d√©finir des ports par d√©faut, qui sont la plupart du temps respect√©s, et qu&rsquo;on doit laisser passer pour faire un peu de Web et d&rsquo;Internet, sinon √ßa n&rsquo;aurait pas grand int√©r√™t : 53 pour le DNS, 80 et 443 pour HTTP et HTTPS, 22 pour SSH, vous en connaissez surement plusieurs dans ce cas.</p>
<p style="text-align: justify;">Mais dans la pratique, et dans beaucoup de r√©seaux publics notamment, mais aussi des r√©seaux d&rsquo;entreprise, avoir droit √† autre chose que du 80 et du 443, c&rsquo;est pas toujours √©vident (oui parfois m√™me le DNS public est bloqu√©, et on doit passer par le point d&rsquo;acc√®s pour √ßa &#8211;quelle horreur&#8230;). Et il n&rsquo;y a rien de plus frustrant de se retrouver coinc√© sur un r√©seau qui n&rsquo;autorise pas √† faire de l&rsquo;Internet, seulement du Web. Et pour ceux qui ont du mal, prenez quelques instants pour me <a href="https://blog.seboss666.info/2014/04/le-web-cest-comme-la-biere/" target="_blank" rel="noopener">relire ce billet</a>, et reviendez apr√®s.</p>
<p style="text-align: justify;">Donc, pour faire de l&rsquo;internet sur les r√©seaux qui ne veulent pas, il est int√©ressant de faire croire qu&rsquo;on va faire du Web, soit port 443 en mode TCP, mais d&rsquo;y h√©berger notre service qui n&rsquo;est pas du Web. Le probl√®me qui survient tr√®s vite dans ce cas, c&rsquo;est qu&rsquo;en th√©orie, on ne peut exposer qu&rsquo;un seul service √† la fois sur un port donn√©. C&rsquo;est l√† qu&rsquo;Haproxy va nous aider.</p>
<h3 style="text-align: justify;">La trousse √† outils du load-balancing, et bien plus</h3>
<p style="text-align: justify;">J&rsquo;ai d√©j√† eu l&rsquo;occasion de parler d&rsquo;Haproxy <a href="https://blog.seboss666.info/?s=haproxy" target="_blank" rel="noopener">par le pass√©</a>, mais c&rsquo;√©tait √† chaque fois pour √©voquer des usages Web. Et il le fait tr√®s bien, c&rsquo;est ce qu&rsquo;on utilise en g√©n√©ral sur les pare-feux ¬´¬†netfilter¬†¬ª qu&rsquo;on d√©ploie sur des plateformes VMware entre autres, mais c&rsquo;est aussi le moteur qui est exploit√© au sein d&rsquo;NSX Edge, la passerelle virtuelle de VMware pour ses solutions de clustering. √Ä part que dans ce cas, on vous colle devant une interface aussi merdique que possible, o√π appliquer une configuration rel√®ve du miracle tellement tout est contre-intuitif. √Ä tel point que l&rsquo;astuce que je vous pr√©sente aujourd&rsquo;hui n&rsquo;est peut-√™tre pas applicable sur NSX, alors que la technologie sous-jacente le permet, c&rsquo;est dire.</p>
<p style="text-align: justify;">Tout √ßa pour dire que l&rsquo;application de load-balancing sait en faire beaucoup plus, notamment gr√¢ce au mode TCP, qui permet de traiter les paquets de mani√®re un peu moins sp√©cifique. Encore que l√†, on va le voir, il est possible d&rsquo;appliquer des r√®gles en fonction de l&rsquo;analyse du contenus des paquets. C&rsquo;est pas du <a href="https://fr.wikipedia.org/wiki/Deep_packet_inspection" target="_blank" rel="noopener">DPI</a> encore √† ce niveau, on cherche pas √† d√©chiffrer le contenu, juste les ent√™tes pour agir en cons√©quence.</p>
<h3 style="text-align: justify;">Architecture</h3>
<p style="text-align: justify;">L&rsquo;exemple d&rsquo;aujourd&rsquo;hui se base sur une configuration qui peut √™tre simple, √† savoir que tout tient sur le m√™me serveur, mais ce n&rsquo;est pas obligatoire. On a donc trois services, param√©tr√©s de cette mani√®re :</p>
<ul style="text-align: justify;">
<li>HAProxy, sur le port 443</li>
<li>OpenVPN, sur le port 1914 (parce que j&rsquo;ai envie, mais vous pouvez garder 1194)</li>
<li>SSH, sur le port 22</li>
</ul>
<p style="text-align: justify;">Sur la machine, seul le port 443 est ouvert au monde √©videmment, ce qui permet de brouiller les pistes. Celui qui va vouloir scanner les ports pensera tomber sur un serveur web, et aura quelques difficult√©s. Et le comportement sera un peu bizarre s&rsquo;il tente une connexion HTTPS classique, au mieux la session TLS va quand m√™me d√©marrer (sauf si la connexion VPN repose sur un certificat client), au pire il aura une r√©ponse √©trange voire une simple d√©connexion (RST).</p>
<p style="text-align: justify;">Comme j&rsquo;ai dit, c&rsquo;est pour l&rsquo;exemple, les services en question peuvent tout √† fait se trouver sur d&rsquo;autres machines sur un r√©seau priv√© par exemple. Et je ne vais pas plus que √ßa d√©tailler la configuration de ces services, c&rsquo;est tr√®s facile de trouver des ressources m√™me en fran√ßais.</p>
<p style="text-align: justify;">Alors oui, je pr√©viens, je d√©conseille du coup d&rsquo;utiliser cette configuration pour ajouter aussi le support d&rsquo;un serveur web. D√©j√† parce que la connexion TLS est d√©j√† filtr√©e pour la partie OpenVPN, donc il faudrait encore creuser pour qualifier la diff√©rence entre les deux, mais surtout parce qu&rsquo;en mode TCP, haproxy va certes renvoyer les paquets vers le serveur web, mais du coup ce dernier verra l&rsquo;adresse IP d&rsquo;haproxy en tant que source, et plus l&rsquo;ip du client. Et comme haproxy ne fait pas la terminaison, il n&rsquo;y a pas d&rsquo;ajout d&rsquo;ent√™te HTTP X-Forwarded-For puisque le protocole est toujours chiffr√© √† ce moment-l√†. Il y a potentiellement moyen de s&rsquo;en sortir avec le <a href="https://www.loadbalancer.org/blog/configure-haproxy-with-tproxy-kernel-for-full-transparent-proxy/" target="_blank" rel="noopener">TPROXY</a>, mais √ßa sort du cadre de l&rsquo;exp√©rimentation. Vous √™tes pr√©venu, attaquons les choses s√©rieuses.</p>
<h3 style="text-align: justify;">La configuration</h3>
<p style="text-align: justify;">Pour la mise en place, √ßa va ¬´¬†simplement¬†¬ª reposer sur un frontend, celui qui √©coutera sur le port 443, et deux backends, un pour ssh, un pour openvpn. L√† encore, pas la peine de s&rsquo;attarder sur la configuration des backends, car toute la beaut√© du fonctionnement r√©side dans le frontend, et de plusieurs concepts, dont les acl et l&rsquo;analyse de contenus des paquets. On va y aller √©tape par √©tape avec une explication √† chaque fois.</p>
<p style="text-align: justify;">On commence par une d√©tection d&rsquo;une connexion TLS :</p>
<p></p><pre class="crayon-plain-tag">frontend 443
  tcp-request inspect-delay 15s
  tcp-request content accept if { req.ssl_hello_type 1 }</pre><p></p>
<p style="text-align: justify;">tcp-request permet de sp√©cifier dans quel mode on bosse, et surtout comment on analyse les paquets (TCP et pas HTTPS directement), ici on laisse passer les paquets TLS de type ¬´¬†client hello¬†¬ª (type 1, si vous voulez laisser passer un paquet entrant de type ¬´¬†server hello¬†¬ª &#8212; c&rsquo;est bizarre mais passons &#8211;, c&rsquo;est type 2), et de ce que j&rsquo;ai compris le d√©lai permet d&rsquo;√©viter de confondre OpenVPN et HTTPS. Cette premi√®re √©tape est n√©cessaire pour pouvoir ensuite filter les paquets OpenVPN sp√©cifiquement :</p>
<p></p><pre class="crayon-plain-tag">acl acl_proto_openvpn payload(0,2) -m bin 003c
  tcp-request content accept if acl_proto_openvpn</pre><p></p>
<p style="text-align: justify;">On retrouve ici la d√©claration d&rsquo;une ACL, comme on l&rsquo;a fait par le pass√©, mais cette fois, le crit√®re est assez velu. On analyse le contenu brut d&rsquo;un paquet pour faire correspondre une s√©quence binaire au d√©but du paquet. En effet, la charge d&rsquo;un paquet TCP commence par un code qui correspond au type de protocole, 003c correspondant donc ici √† OpenVPN.</p>
<p style="text-align: justify;">Je vous l&rsquo;ai dit, c&rsquo;est velu. Fort heureusement, la d√©tection d&rsquo;OpenSSH est plus simple. Si vous avez d√©j√† fait un coup de telnet sur un serveur OpenSSH, vous avez d√©j√† vu que l&rsquo;annonce du serveur est en clair, et il y a un √©l√©ment facilement identifiable, qui est la version du protocole SSH. On peut d√®s lors non pas taper sur de la reconnaissance binaire, mais du plus humain avec une chaine de caract√®res :</p>
<p></p><pre class="crayon-plain-tag">acl acl_proto_ssh payload(0,7) -m str SSH-2.0
  tcp-request content accept if acl_proto_ssh</pre><p></p>
<p style="text-align: justify;">Et c&rsquo;est tout. Pour chaque protocole on a d√©fini un filtre avec l&rsquo;ACL sur le contenu du paquet, et on force Haproxy √† n&rsquo;accepter que ce type de paquet avec <code>tcp-request content accept</code>. Ne reste plus qu&rsquo;√† ¬´¬†router¬†¬ª vers le service concern√© :</p>
<p></p><pre class="crayon-plain-tag">use_backend host_ssh if acl_proto_ssh
  use_backend openvpn if acl_proto_openvpn</pre><p></p>
<p style="text-align: justify;">Et voil√†, vous avez votre routeur maison de protocole pour contourner les limitations un peu p√©nibles de certains r√©seaux.</p>
<p style="text-align: justify;">Je vous remet la configuration compl√®te ici, pour que ce soit plus digeste si vous voulez copier/coller :</p>
<p></p><pre class="crayon-plain-tag">frontend 443
  #ssl client hello
  tcp-request inspect-delay 15s
  tcp-request content accept if { req.ssl_hello_type 1 }
  #OpenVPN
  acl acl_proto_openvpn payload(0,2) -m bin 003c
  tcp-request content accept if acl_proto_openvpn
  #OpenSSH
  acl acl_proto_ssh payload(0,7) -m str SSH-2.0
  tcp-request content accept if acl_proto_ssh</pre><p></p>
<h3 style="text-align: justify;">L&rsquo;alternative SSLH</h3>
<p style="text-align: justify;">J&rsquo;ai pr√©sent√© haproxy parce que je le connais bien, et que j&rsquo;ai kiff√© quand un coll√®gue m&rsquo;a expliqu√© qu&rsquo;il faisait √ßa sur son serveur. Alors √©videmment avec mon organisation, j&rsquo;ai mis plus de trois mois pour vous r√©diger tout √ßa, mais voil√†, c&rsquo;est fait. Mais Haproxy n&rsquo;est pas seul √† permettre ce multiplexage de protocole.</p>
<p style="text-align: justify;">Pour faire du SSH et du HTTPS, il y a <a href="https://github.com/yrutschle/sslh" target="_blank" rel="noopener">SSLH</a>, contraction d&rsquo;SSL (nom original d&rsquo;un protocole qui s&rsquo;appelle d√©sormais TLS, √† la base du chiffrement d&rsquo;HTTPS et d&rsquo;OpenVPN) et d&rsquo;SSH, pour l&rsquo;ouverture s√©curis√©e d&rsquo;un shell. Et cerise sur le g√¢teau, chose que je ne savais pas avant d&rsquo;avoir pratiquement fini d&rsquo;√©crire cet article, il semble qu&rsquo;il supporte d√©sormais aussi OpenVPN et m√™me plusieurs autres protocoles. J&rsquo;ai pas creus√©, du coup, je vous laisse d√©couvrir, mais pour des acc√®s √† une infra derri√®re une livebox, √ßa pourrait √™tre plus int√©ressant que de multiplier les ouvertures de ports et les solutions type rebond/bastion. Reste qu&rsquo;avec le HTTPS il y a toujours ces questions d&rsquo;adresses IP source dans les logs, et de ce que j&rsquo;ai lu, SSLH traite le probl√®me de la m√™me fa√ßon qu&rsquo;Haproxy, √† savoir TPROXY.</p>
<p style="text-align: justify;">Vous l&rsquo;avez peut-√™tre d√©j√† utilis√©, ou alors, si vous le mettez en place, n&rsquo;h√©sitez pas √† partager vos retours, que ce soit ici en commentaire ou votre propre espace d&rsquo;expression, c&rsquo;est toujours sympa √† voir en fran√ßais <img src="https://s.w.org/images/core/emoji/11/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
]]></content:encoded>
            <wfw:commentRss>https://blog.seboss666.info/2020/04/haproxy-openvpn-ou-ssh/feed/</wfw:commentRss>
            <slash:comments>4</slash:comments>
        </item>
        <item>
            <title>G√©rer plusieurs versions de certains outils en ligne de commande</title>
            <link>https://blog.seboss666.info/2020/04/gerer-plusieurs-versions-de-certains-outils-en-ligne-de-commande/</link>
            <comments>https://blog.seboss666.info/2020/04/gerer-plusieurs-versions-de-certains-outils-en-ligne-de-commande/#comments</comments>
            <pubDate>Wed, 15 Apr 2020 16:30:42 +0000</pubDate>
            <dc:creator><![CDATA[Seboss666]]></dc:creator>
            <category><![CDATA[Astuces]]></category>
            <category><![CDATA[Sysadmin]]></category>
            <category><![CDATA[Ansible]]></category>
            <category><![CDATA[asdf-vm]]></category>
            <category><![CDATA[cli]]></category>
            <category><![CDATA[gestion]]></category>
            <category><![CDATA[helm]]></category>
            <category><![CDATA[kubernetes]]></category>
            <category><![CDATA[switch]]></category>
            <category><![CDATA[terraform]]></category>
            <category><![CDATA[tfenv]]></category>
            <category><![CDATA[utilitaires]]></category>
            <category><![CDATA[version]]></category>

            <guid isPermaLink="false">https://blog.seboss666.info/?p=6214</guid>
            <description><![CDATA[C&#8217;est un probl√®me qu&#8217;on rencontre pas forc√©ment quand on g√®re que du perso, mais quand on bosse sur une quantit√© importante de projets clients, il [...]]]></description>
            <content:encoded><![CDATA[<p style="text-align: justify;">C&rsquo;est un probl√®me qu&rsquo;on rencontre pas forc√©ment quand on g√®re que du perso, mais quand on bosse sur une quantit√© importante de projets clients, il arrive qu&rsquo;on doive jongler, pour diff√©rentes raisons, avec plusieurs versions diff√©rentes d&rsquo;outils divers et vari√©s. Et souvent les ¬´¬†proc√©dures d&rsquo;installation¬†¬ª (t√©l√©charger, copier dans /usr/local/bin, j&rsquo;appelle pas √ßa une proc√©dure), ne prennent pas ce cas d&rsquo;usage en compte. je vais donc faire un inventaire de ce que j&rsquo;ai pu faire et que je fais encore aujourd&rsquo;hui pour g√©rer √ßa.</p>
<p style="text-align: justify;"><span id="more-6214"></span></p>
<p style="text-align: justify;">Les utilitaires que je manipule ces derniers mois ne sont pas obscurs : terraform, ansible, git, kubernetes, helm, pour ne citer qu&rsquo;eux, √©voluent constamment, et apportent toujours plus de nouvelles possibilit√©s. Sauf que ces outils ne servent qu&rsquo;√† ex√©cuter du code qui a √©t√© √©crit √† un instant T, donc avec la version disponible alors. Ou pas, j&rsquo;ai eu √† bosser sur un projet terraform dont certains modules √©taient encore fig√©s √† la syntaxe 0.11, donc pas le choix, sauf qu&rsquo;en parall√®le, un projet interne utilisait la syntaxe 0.12. Il a donc fallu trouver une solution simple.</p>
<p style="text-align: justify;">Vous avez donc maintenant une meilleure id√©e, et quand le probl√®me s&rsquo;est reproduit pour d&rsquo;autres outils, j&rsquo;ai cherch√© et trouv√© d&rsquo;autres solutions.</p>
<h3 style="text-align: justify;">Terraform : tfenv</h3>
<p style="text-align: justify;">C&rsquo;est en effet probablement le premier pour lequel j&rsquo;ai eu √† chercher une solution qui n&rsquo;√©tait pas utilisable nativement, comme on le verra avec Ansible plus tard. Quand vous regardez la doc, c&rsquo;est ¬´¬†t√©l√©chargez, copiez dans un dossier du PATH, enjoy¬†¬ª. Et d√©merdez vous avec √ßa. Remarquez qu&rsquo;on trouve beaucoup trop cette solution basique avec les outils d√©velopp√©s en Go, qui effectivement ne s&#8217;embarrassent pas trop de biblioth√®ques partag√©es car ils sont majoritairement compil√©s en statique, donc avec tout ce dont ils ont besoin. √áa vous fait un fichier binaire de plus de 100Mo, mais on va dire que c&rsquo;est un d√©tail (regardez pas de trop pr√®s les providers terraform, vous allez vite vous pendre).</p>
<p style="text-align: justify;">Donc, pour pouvoir facilement switcher entre les versions de Terraform, et m√™me g√©rer facilement les versions install√©es sur mon poste, j&rsquo;ai d√©couvert un petit utilitaire tr√®s pratique : <a href="https://github.com/tfutils/tfenv" target="_blank" rel="noopener">tfenv</a>. Il est utilisable sous Linux et Mac (et apparemment sous Windows, dans git-bash), et permet d&rsquo;installer et de switcher facilement entre les versions de terraform. Le genre d&rsquo;outil qu&rsquo;on aurait aim√© avoir en natif plut√¥t que du b√™te download de binaire, mais bon, on peut pas tout avoir.</p>
<p style="text-align: justify;">Pour l&rsquo;installation j&rsquo;ai fait le feignant et je suis pass√© par yay sur Manjaro, mais les instructions disponibles sur le README sont faciles √† suivre.</p>
<h3 style="text-align: justify;"><a href="https://blog.seboss666.info/wp-content/uploads/2020/04/tfenv.png" rel="lightbox[6214]"><img class="aligncenter size-medium wp-image-6228" src="https://blog.seboss666.info/wp-content/uploads/2020/04/tfenv-300x59.png" alt="" width="300" height="59" srcset="https://blog.seboss666.info/wp-content/uploads/2020/04/tfenv-300x59.png 300w, https://blog.seboss666.info/wp-content/uploads/2020/04/tfenv-768x151.png 768w, https://blog.seboss666.info/wp-content/uploads/2020/04/tfenv-1024x201.png 1024w" sizes="(max-width: 300px) 100vw, 300px" /></a>Ansible : les virtualenv √† la rescousse !</h3>
<p style="text-align: justify;">Eh oui, Ansible est un outil √©crit en Python, et j&rsquo;avais parl√© de comment utiliser les virtualenv tr√®s r√©cemment pour utiliser <a href="https://blog.seboss666.info/2020/03/youtube-dl-sur-un-nas-synology-cest-possible/" target="_blank" rel="noopener">youtube-dl sur le NAS</a> de ma m√¥man. Dans le cas d&rsquo;Ansible, j&rsquo;ai eu √† jouer avec plus que la version, car l√† c&rsquo;√©tait en fonction de la version de Python directement que j&rsquo;avais √† switcher entre les virtualenv, certains modules utilis√©s n&rsquo;√©tant compatibles qu&rsquo;avec Python 2 (le mainteneur sait qu&rsquo;il doit repasser dessus pour les passer en python 3, mais √ßa demande du temps qu&rsquo;on facture pas au client, donc personne le fait &#8211; une sacr√©e connerie contre laquelle on se bat de plus en plus souvent&#8230;).</p>
<p style="text-align: justify;">Sur une machine o√π vous avez les deux versions de Python d&rsquo;install√©s, il faut donc v√©rifier si vous avez python2-virtualenv (souvent seulement appel√© python-virtualenv) et python3-virtualenv, ou alors pour Python 3, reprendre la m√©thode avec le module int√©gr√© <code>python3 -m venv</code>.</p>
<p></p><pre class="crayon-plain-tag">~ ÓÇ∞ .venv ÓÇ∞ ansible ÓÇ∞
$ python --version
Python 3.8.2
 ~ ÓÇ∞ .venv ÓÇ∞ ansible ÓÇ∞
$ ansible --version
ansible 2.8.10
  config file = None
  configured module search path = ['/home/seboss666/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /home/seboss666/.venv/ansible/lib/python3.8/site-packages/ansible
  executable location = /home/seboss666/.venv/ansible/bin/ansible
  python version = 3.8.2 (default, Feb 26 2020, 22:21:03) [GCC 9.2.1 20200130]
 ~ ÓÇ∞ .venv ÓÇ∞ ansible ÓÇ∞
$ deactivate
 ~ ÓÇ∞ .venv ÓÇ∞
$ python -m venv ansible29
 ~ ÓÇ∞ .venv ÓÇ∞
$ source ansible29/bin/activate
 ~ ÓÇ∞ .venv ÓÇ∞ ansible29 ÓÇ∞
$ pip install --upgrade pip
Collecting pip
  Using cached https://files.pythonhosted.org/packages/54/0c/d01aa759fdc501a58f431eb594a17495f15b88da142ce14b5845662c13f3/pip-20.0.2-py2.py3-none-any.whl
Installing collected packages: pip
  Found existing installation: pip 19.2.3
    Uninstalling pip-19.2.3:
      Successfully uninstalled pip-19.2.3
Successfully installed pip-20.0.2
 ~ ÓÇ∞ .venv ÓÇ∞ ansible29 ÓÇ∞
$ pip install ansible
Collecting ansible
  Downloading ansible-2.9.6.tar.gz (14.2 MB)
     |‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 14.2 MB 9.1 MB/s
Collecting jinja2
  Using cached Jinja2-2.11.1-py2.py3-none-any.whl (126 kB)
Collecting PyYAML
  Using cached PyYAML-5.3.1.tar.gz (269 kB)
Collecting cryptography
  Downloading cryptography-2.9-cp35-abi3-manylinux2010_x86_64.whl (2.7 MB)
     |‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 2.7 MB 9.3 MB/s
Collecting MarkupSafe&gt;=0.23
  Using cached MarkupSafe-1.1.1-cp38-cp38-manylinux1_x86_64.whl (32 kB)
Collecting six&gt;=1.4.1
  Using cached six-1.14.0-py2.py3-none-any.whl (10 kB)
Collecting cffi!=1.11.3,&gt;=1.8
  Using cached cffi-1.14.0-cp38-cp38-manylinux1_x86_64.whl (409 kB)
Collecting pycparser
  Using cached pycparser-2.20-py2.py3-none-any.whl (112 kB)
Installing collected packages: MarkupSafe, jinja2, PyYAML, six, pycparser, cffi, cryptography, ansible
    Running setup.py install for PyYAML ... done
    Running setup.py install for ansible ... done
Successfully installed MarkupSafe-1.1.1 PyYAML-5.3.1 ansible-2.9.6 cffi-1.14.0 cryptography-2.9 jinja2-2.11.1 pycparser-2.20 six-1.14.0
 ~ ÓÇ∞ .venv ÓÇ∞ ansible29 ÓÇ∞
$ ansible --version
ansible 2.9.6
  config file = None
  configured module search path = ['/home/seboss666/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /home/seboss666/.venv/ansible29/lib/python3.8/site-packages/ansible
  executable location = /home/seboss666/.venv/ansible29/bin/ansible
  python version = 3.8.2 (default, Feb 26 2020, 22:21:03) [GCC 9.2.1 20200130]</pre><p></p>
<p style="text-align: justify;">Pour certains projets, comme le code repose aussi sur des sdk de cloud provider, je cr√©e un venv d√©di√© qui embarque √† la fois ansible et le sdk/cli concern√©, aws et azure majoritairement pour l&rsquo;instant (j&rsquo;ai commenc√© √† d√©couvrir Google Cloud Platform tr√®s r√©cemment, rien de transcendant). L&rsquo;aspect paradoxal de tout √ßa c&rsquo;est que je peux avoir plusieurs fois la m√™me version d&rsquo;Ansible d&rsquo;install√©e, pour diff√©rentes versions de Python et des d√©pendances associ√©es. √áa consomme plus de disque, mais bon, j&rsquo;ai plus de Windows pour m&#8217;emmerder avec √ßa et le SSD est loin d&rsquo;√™tre satur√©, le co√ªt est donc plus que supportable.</p>
<h3 style="text-align: justify;">Kubernetes/helm, j&rsquo;ai sorti l&rsquo;artillerie lourde</h3>
<p style="text-align: justify;">Pour Kubernetes et Helm, je n&rsquo;ai pas trouv√© de m√©thode maison ou un outil l√©ger adapat√© comme pour Terraform. Par contre, je suis tomb√© sur la rolls, de celles qui pourraient au final remplacer aussi tfenv pour terraform, car elle repose sur un syst√®me de plugins.</p>
<p style="text-align: justify;">asdf Version Manager est cette rolls. Je vous laisse regarder <a href="https://asdf-vm.com/#/plugins-all" target="_blank" rel="noopener">la liste des plugins</a> pour comprendre la palette de possibilit√©s de gestion d&rsquo;outils, j&rsquo;ai donc pour ma part pour l&rsquo;instant utilis√© ceux de kubectl et d&rsquo;helm. kubectl parce que l&rsquo;utilitaire pour manipuler ses cluster Kubernetes a une palette certes large de compatibilit√© entre versions serveur et client, mais y&rsquo;a des limites, et si vous avez un kubectl en 1.16.x, et que vous avez le malheur de devoir manipuler un cluster qui est encore install√© en 1.12.x, vous vous engagez sur une pente plus que glissante, car la version 1.16 a mis √† la retraite bon nombre d&rsquo;API qui √©taient en service sur l&rsquo;ancien. Helm parce qu&rsquo;entre la version 2 et la version 3 c&rsquo;est le jour et la nuit sur le fonctionnement, et que des packages install√©s avec la version 2 ne peuvent pas √™tre g√©r√©s simplement de mani√®re transparente du jour au lendemain avec la version 3. D&rsquo;autant plus quand vous utilisez le provider pour terraform.</p>
<p></p><pre class="crayon-plain-tag">~ ÓÇ∞
$ asdf plugin-add kubectl
initializing plugin repository...
Clonage dans '/home/seboss666/.asdf/repository'...
remote: Enumerating objects: 96, done.
remote: Counting objects: 100% (96/96), done.
remote: Compressing objects: 100% (84/84), done.
remote: Total 1743 (delta 41), reused 38 (delta 12), pack-reused 1647
R√©ception d'objets: 100% (1743/1743), 393.01 Kio | 1.36 Mio/s, fait.
R√©solution des deltas: 100% (760/760), fait.
 ~ ÓÇ∞
$ asdf list-all
No plugin given
 ~ ÓÇ∞ ‚úò 1 ÓÇ∞
$ asdf list-all kubectl
1.14.10
1.15.7
1.15.8
1.15.9
1.15.10
1.15.11
1.16.3
1.16.4
1.16.5
1.16.6
1.16.7
1.16.8
1.17.0-rc.1
1.17.0-beta.2
1.17.0-rc.2
1.17.0
1.17.1
1.17.2
1.17.3
1.17.4
1.18.0-alpha.1
1.18.0-beta.1
1.18.0-rc.1
1.18.0-alpha.2
1.18.0-beta.2
1.18.0-alpha.3
1.18.0-alpha.5
1.18.0
1.18.1
1.19.0-alpha.1
 ~ ÓÇ∞
$ asdf install kubectl 1.16.8
Downloading kubectl from https://storage.googleapis.com/kubernetes-release/release/v1.16.8/bin/linux/amd64/kubectl
 ~ ÓÇ∞
$ asdf global kubectl 1.16.8
 ~ ÓÇ∞
$ kubectl version
Client Version: version.Info{Major:"1", Minor:"16", GitVersion:"v1.16.8", GitCommit:"ec6eb119b81be488b030e849b9e64fda4caaf33c", GitTreeState:"clean", BuildDate:"2020-03-12T21:00:06Z", GoVersion:"go1.13.8", Compiler:"gc", Platform:"linux/amd64"}
The connection to the server localhost:8080 was refused - did you specify the right host or port?</pre><p></p>
<p style="text-align: justify;">Et √ßa ce ne sont que les utilitaires, mais dans les plugins vous pouvez aussi bosser carr√©ment avec des versions diff√©rentes de langages de programmation, comme nodejs, ruby, et j&rsquo;en passe, c&rsquo;est donc tr√®s pratique dans un environnement de d√©veloppement, et pour se passer de docker qui a ses propres contraintes. Attention toutefois, asdf est vraiment pens√© pour un usage sur poste local, ce n&rsquo;est pas un outil de d√©ploiement en production, je recommande vivement soit de passer par Docker, soit d&rsquo;adapter l&rsquo;environnement pour votre application en installant plus proprement (id√©alement via package manager pour g√©rer les mises √† jour auto). Je pense par exemple aux software collections sur Redhat/CentOS qui permettent de multiplier les versions de certains langages (coucou PHP).</p>
<p style="text-align: justify;">Bref, s&rsquo;il ne devait en rester qu&rsquo;un, √ßa serait probablement celui-l√†. Surtout que si le plugin dont vous auriez besoin n&rsquo;existe pas encore, vous avez tout √† fait la possibilit√© de l&rsquo;√©crire vous-m√™me <img src="https://s.w.org/images/core/emoji/11/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<h3 style="text-align: justify;">Et vous, vous faites comment ?</h3>
<p style="text-align: justify;">Mon manager repose d√©sormais exclusivement sur Docker pour ce genre de besoins. Il garde soigneusement quantit√© de containers et d&rsquo;images qu&rsquo;il red√©marre √† la vol√©e quand il en a besoin, mais je trouve la solution plus lourde et moins naturelle par rapport au reste de l&rsquo;usage du syst√®me.</p>
<p style="text-align: justify;">Mais vous avez probablement vos propres routines pour ce genre de situation, je suis curieux de les d√©couvrir, alors, comment √ßa jongle ?</p>
<p style="text-align: justify;"><strong>PS</strong> : le tr√®s partageur Cascador, qui a fait un petit namedrop sur systemd-nspawn, sans pr√©ciser qu&rsquo;il a carr√©ment fait <a href="https://www.blog-libre.org/2020/04/17/une-presentation-de-systemd-nspawn/" target="_blank" rel="noopener">un article dessus</a> <img src="https://s.w.org/images/core/emoji/11/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
]]></content:encoded>
            <wfw:commentRss>https://blog.seboss666.info/2020/04/gerer-plusieurs-versions-de-certains-outils-en-ligne-de-commande/feed/</wfw:commentRss>
            <slash:comments>4</slash:comments>
        </item>
        <item>
            <title>Quelques astuces diverses, dix-huiti√®me</title>
            <link>https://blog.seboss666.info/2020/04/quelques-astuces-diverses-dix-huitieme/</link>
            <pubDate>Sun, 12 Apr 2020 08:30:06 +0000</pubDate>
            <dc:creator><![CDATA[Seboss666]]></dc:creator>
            <category><![CDATA[Astuces diverses]]></category>
            <category><![CDATA[alias]]></category>
            <category><![CDATA[bash]]></category>
            <category><![CDATA[d√©codage]]></category>
            <category><![CDATA[git]]></category>
            <category><![CDATA[kubernetes]]></category>
            <category><![CDATA[Manjaro]]></category>
            <category><![CDATA[nmap]]></category>
            <category><![CDATA[ssh]]></category>
            <category><![CDATA[steam]]></category>
            <category><![CDATA[sublime text]]></category>
            <category><![CDATA[vlc]]></category>
            <category><![CDATA[worms]]></category>
            <category><![CDATA[WSL]]></category>

            <guid isPermaLink="false">https://blog.seboss666.info/?p=6107</guid>
            <description><![CDATA[Cela fait beaucoup trop longtemps que je n&#8217;ai pas sorti de nouvel √©pisode de ces astuces en tout genre (Novembre 2019 !). Mais elles existent [...]]]></description>
            <content:encoded><![CDATA[<p style="text-align: justify;">Cela fait beaucoup trop longtemps que je n&rsquo;ai pas sorti de nouvel √©pisode de ces astuces en tout genre (Novembre 2019 !). Mais elles existent toujours, et voil√† enfin un nouvel √©pisode.</p>
<p style="text-align: justify;"><span id="more-6107"></span></p>
<h3 style="text-align: justify;">Un nmap fonctionnel sur WSL</h3>
<p style="text-align: justify;">J&rsquo;en ai parl√©, j&rsquo;ai pas mal exp√©riment√© avec <a href="https://blog.seboss666.info/?s=wsl" target="_blank" rel="noopener">le WSL 1</a> sur mon installation de Windows √† destination du PC de jeu, pour limiter mon recours √† une machine virtuelle Linux. Parmi les probl√®mes/limitations que j&rsquo;ai pu rencontrer, il y a l&rsquo;utilisation d&rsquo;nmap. En effet, le binaire Linux m&rsquo;a gratifi√© d&rsquo;une palanqu√©e de messages d&rsquo;erreur bien salaces. Pas √©tonnant, il cherche √† demander des infos bas niveau au noyau Linux, qui n&rsquo;existe pas&#8230;</p>
<p style="text-align: justify;">J&rsquo;ai du coup d√©couvert qu&rsquo;on pouvait lancer des binaires Windows depuis le WSL, et donc, la solution recommand√©e dans ce cas est d&rsquo;installer la version Windows d&rsquo;nmap <a href="https://nmap.org/download.html" target="_blank" rel="noopener">depuis le site officiel</a> et seulement lui, qui elle va utiliser les sous-syst√®mes du noyal Windows pour faire son job, sans erreur donc. Pour l&rsquo;appeler ensuite de mani√®re transparente, un alias suffit dans votre environnement :</p>
<p></p><pre class="crayon-plain-tag">alias nmap='"/mnt/c/Program Files (x86)/Nmap/nmap.exe"'</pre><p></p>
<p style="text-align: justify;">Je vous laisse adapter le chemin si vous avez modifi√© les points de montages pour une <a href="https://blog.seboss666.info/2019/11/windows-wsl-et-docker-mode-demploi/" target="_blank" rel="noopener">utilisation de Docker</a>.</p>
<h3 style="text-align: justify;">Fermer la fen√™tre principale de Steam sous Manjaro Linux</h3>
<p style="text-align: justify;">Si vous √™tes aussi sous Manjaro et que vous utilisez Steam, vous aurez certainement remarqu√© un comportement par d√©faut plut√¥t p√©nible par rapport √† Windows : malgr√© la pr√©sence de l&rsquo;ic√¥ne de notifications, fermer la fen√™tre principale ne fait que la r√©duire.</p>
<p style="text-align: justify;">C&rsquo;est une mesure prise √† cause de certains bureaux o√π l&rsquo;ic√¥ne d√©conne et laisse tra√Æner un process zombie √† la fin, ce qui emp√™che de relancer correctement le client derri√®re. Mais on peut modifier ce comportement avec une variable d&rsquo;environnement, et je vous recommande de la mettre justement dans <span style="font-family: couriernew,courier,monospace;">/etc/environment</span> :</p>
<p></p><pre class="crayon-plain-tag">STEAM_FRAME_FORCE_CLOSE=1</pre><p></p>
<p style="text-align: justify;">Normalement ce comportement est sp√©cifique √† Manjaro, mais si d&rsquo;aventure vous le rencontrez ailleurs, vous savez par o√π commencer.</p>
<h3 style="text-align: justify;">Correctement utiliser l&rsquo;acc√©l√©ration du d√©codage vid√©o Intel avec VLC</h3>
<p style="text-align: justify;">J&rsquo;ai pass√© un peu de temps √† pester contre √ßa, d&rsquo;autant que c&rsquo;est beaucoup mieux g√©r√© sous Windows. En effet, je pensais avoir suivi les recommandations du <a href="https://wiki.archlinux.org/index.php/Hardware_video_acceleration#Intel" target="_blank" rel="noopener">Wiki Archlinux</a>, j&rsquo;avais, droit √† √ßa :</p>
<ul style="text-align: justify;">
<li>intel-media-driver =&gt; ok</li>
<li>libva =&gt; ok</li>
<li>vainfo =&gt; ko :</li>
</ul>
<p></p><pre class="crayon-plain-tag">$ vainfo
vaInitialize failed with error code -1 (unknown libva error),exit</pre><p></p>
<p style="text-align: justify;">Et quand on lance VLC, dans les messages on peut voir √ßa :</p>
<p></p><pre class="crayon-plain-tag">[00007f6c9c001f70] glconv_vaapi_x11 gl error: vaInitialize: unknown libva error
[00007f6c9c001f70] glconv_vaapi_drm gl error: vaInitialize: unknown libva error
libva error: va_getDriverName() failed with operation failed,driver_name=i965</pre><p></p>
<p style="text-align: justify;">Moralit√© la conso CPU est bien v√©n√®re avec un VLC qui mange facile les trois quarts du CPU au global pour la lecture d&rsquo;une vid√©o full HD.</p>
<p style="text-align: justify;">La solution : la variable d&rsquo;environnement. Il suffit d&rsquo;ajouter le bon nom √† la variable <span style="font-family: couriernew,courier,monospace;">LIBVA_DRIVER_NAME</span>, et le tour est jou√© :</p>
<p></p><pre class="crayon-plain-tag">$ LIBVA_DRIVER_NAME=iHD vainfo
vainfo: VA-API version: 1.5 (libva 2.5.0)
vainfo: Driver version: Intel iHD driver - 1.0.0
vainfo: Supported profile and entrypoints
(...)</pre><p></p>
<p style="text-align: justify;">Et quand on lance VLC avec :</p>
<p></p><pre class="crayon-plain-tag">[00007fe6e590ee90] avcodec decoder: Using Intel iHD driver - 1.0.0 for hardware decoding</pre><p></p>
<p style="text-align: justify;">Je recommande de la coller dans <span style="font-family: couriernew,courier,monospace;">/etc/environment</span>, √ßa permet d&rsquo;√™tre le plus large possible dans sa prise en compte. Voil√†, personne est foutu de se parler correctement pour s&rsquo;identifier afin d&rsquo;√™tre exploit√© comme il faut. C&rsquo;est la magie du libre. Ah et non, √ßa suffit pas pour que √ßa fonctionne sous Firefox, l√† c&rsquo;est encore pire en terme de conso CPU, et j&rsquo;ai pas encore r√©ussi malgr√© une fois encore la pr√©sence des paquets.</p>
<h3 style="text-align: justify;">Git : cloner une seule branche (pour un test)</h3>
<p style="text-align: justify;">Quand on veut gagner un peu de temps sur un simple test rapide autour d&rsquo;un code d&rsquo;un d√©p√¥t git, et que ce code se trouve dans une branche sp√©cifique, on peut directement cloner cette branche-l√† uniquement :</p>
<p></p><pre class="crayon-plain-tag">git clone -b my-dev-branch --single-branch https://gitforge.domain/user/my_super_repo</pre><p></p>
<p style="text-align: justify;">En l&rsquo;occurrence, je testais la branche d&rsquo;un mec qui cherchait √† dockeriser son appli et qui rencontrait des probl√®mes au build sous Manjaro <img src="https://s.w.org/images/core/emoji/11/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;" /> (et moi une appli JS, en temps normal je m&rsquo;en approche pas, donc pas besoin de r√©cup√©rer tout le d√©p√¥t pour un simple test, surtout sur la petite connexion de ma petite s≈ìur).</p>
<h3 style="text-align: justify;">Une d√©connexion automatique sur vos sessions SSH inactives</h3>
<p style="text-align: justify;">D√©couvert chez un client y&rsquo;a pas longtemps, si vous laissez une connexion SSH ouverte sans rien en faire, elle est d√©connect√©e automatiquement au bout d&rsquo;un certain temps. J&rsquo;ai cherch√© comment ils faisaient, c&rsquo;est via une variable d&rsquo;environnement, soit dans le /etc/profile pour l&rsquo;appliquer de mani√®re globale, soit dans votre bashrc, pour que √ßa ne concerne que l&rsquo;utilisateur :</p>
<p></p><pre class="crayon-plain-tag">export readonly TMOUT=900</pre><p></p>
<p style="text-align: justify;">Le temps est en secondes. Au passage, double astuce puisqu&rsquo;on voit ici qu&rsquo;on d√©finit la variable en lecture seule.</p>
<h3 style="text-align: justify;">Mise √† jour du paquet AUR ttf-sil-fonts sur ArchLinux/Manjaro</h3>
<p style="text-align: justify;">Ce paquet, qui avait √©t√© laiss√© √† l&rsquo;abandon, a √©t√© repris r√©cemment par un autre mainteneur. Mais le format a chang√©, avant il se chargeait directement de l&rsquo;installation, maintenant c&rsquo;est un meta-paquet qui installe chaque police qui se trouve dans un paquet ind√©pendant. Ce qui cause des conflits avec des polices d√©j√† install√©es. La solution la plus simple c&rsquo;est de d√©sinstaller le paquet, et de le r√©installer dans la foul√©e :</p>
<p></p><pre class="crayon-plain-tag">yay -R ttf-sil-fonts
yay -S ttf-sil-fonts</pre><p></p>
<p style="text-align: justify;">√áa vous √©vitera comme moi de faire des trucs sales √† base de d√©placement des fichiers qui existent d√©j√† dans les dossiers cible <img src="https://s.w.org/images/core/emoji/11/72x72/1f600.png" alt="üòÄ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<h3 style="text-align: justify;">Worms WMD et ArchLinux/Manjaro, c&rsquo;est compliqu√© (mais √ßa se soigne)</h3>
<p style="text-align: justify;">Le jeu est disponible nativement sous Linux mais la maintenance par Team17 n&rsquo;est pas vraiment au beau fixe. En particulier, avec les √©volutions permanentes d&rsquo;ArchLinux, c&rsquo;est simple, par d√©faut le jeu ne d√©marre pas. Pour corriger, il faut modifier le script de lancement, pour qu&rsquo;il ressemble √† √ßa :</p>
<p></p><pre class="crayon-plain-tag">#!/bin/bash

GAMEPATH="$(dirname "$(realpath $0)")"
export LC_ALL=C
export LD_LIBRARY_PATH="${GAMEPATH}/lib:${LD_LIBRARY_PATH}"
export DBUS_FATAL_WARNINGS=0

chmod a+x ./Worms\ W.M.Dx64
./Worms\ W.M.Dx64</pre><p></p>
<p style="text-align: justify;">C&rsquo;est plus fourni et surtout √ßa permet d&rsquo;utiliser les biblioth√®ques Steam plut√¥t que les biblioth√®ques natives. Dans tous les cas, n&rsquo;esp√©rez pas faire des parties class√©es en ligne, la connexion aux serveurs Team17 ne fonctionne pas. Heureusement le multijoueur avec des amis fonctionne quand m√™me, ouf.</p>
<h3 style="text-align: justify;">Franciser Sublime Text ? C&rsquo;est possible</h3>
<p style="text-align: justify;">Bon personnellement, √ßa ne m&#8217;emp√™che pas de continuer √† bosser en anglais, mais en effet, pour ceux qui s&rsquo;en servent, un reproche qui lui est souvent fait est d&rsquo;√™tre ¬´¬†english centric¬†¬ª. Par chance, avec la fa√ßon dont est construite l&rsquo;interface, elle est hautement personnalisable. Et pour √ßa, il suffit d&rsquo;installer le paquet LocalizedMenu avec Package Manager, et s√©lectionner la langue via le menu Preferences, et voil√† :</p>
<p style="text-align: justify;"><a href="https://blog.seboss666.info/wp-content/uploads/2019/12/sublime_localized.png" rel="lightbox[6107]"><img class="aligncenter size-medium wp-image-6220" src="https://blog.seboss666.info/wp-content/uploads/2019/12/sublime_localized-300x82.png" alt="" width="300" height="82" srcset="https://blog.seboss666.info/wp-content/uploads/2019/12/sublime_localized-300x82.png 300w, https://blog.seboss666.info/wp-content/uploads/2019/12/sublime_localized-768x209.png 768w, https://blog.seboss666.info/wp-content/uploads/2019/12/sublime_localized-1024x279.png 1024w, https://blog.seboss666.info/wp-content/uploads/2019/12/sublime_localized.png 1121w" sizes="(max-width: 300px) 100vw, 300px" /></a></p>
<p style="text-align: justify;">Pour le reste, je vous laisse regarder <a href="https://github.com/zam1024t/LocalizedMenu" target="_blank" rel="noopener">le d√©p√¥t Git</a>.</p>
<h3 style="text-align: justify;">Lancer une commande originale et pas son alias</h3>
<p style="text-align: justify;">Vous le savez j&rsquo;adore les alias de bash, j&rsquo;en utilise pas mal. Le probl√®me c&rsquo;est que parfois on aurait besoin de comparer avec la commande ¬´¬†brute¬†¬ª, fort heureusement, il n&rsquo;y a pas besoin de d√©truire l&rsquo;alias, il suffit de pr√©fixer la commande avec un antislash :</p>
<p style="text-align: justify;"><a href="https://blog.seboss666.info/wp-content/uploads/2020/03/original_command.png" rel="lightbox[6107]"><img class="aligncenter size-medium wp-image-6225" src="https://blog.seboss666.info/wp-content/uploads/2020/03/original_command-300x26.png" alt="" width="300" height="26" srcset="https://blog.seboss666.info/wp-content/uploads/2020/03/original_command-300x26.png 300w, https://blog.seboss666.info/wp-content/uploads/2020/03/original_command-768x65.png 768w, https://blog.seboss666.info/wp-content/uploads/2020/03/original_command-1024x87.png 1024w" sizes="(max-width: 300px) 100vw, 300px" /></a>√áa permet de voir parfois les probl√®mes visuels que les personnalisations engendrent <img src="https://s.w.org/images/core/emoji/11/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<h3 style="text-align: justify;">Kubernetes, communications r√©seau inter-containers dans un m√™me pod</h3>
<p style="text-align: justify;">Un coll√®gue m&rsquo;a pos√© la question r√©cemment, et j&rsquo;avais pas la r√©ponse, alors j&rsquo;ai cherch√©. Il exp√©rimentait k3s, et voulait d√©ployer un ethercalc, qui utilise une appli nodejs et un serveur redis pour le stockage des classeurs. Hors il a mis les deux containers dans le m√™me pod, donc pas de service pour le redis :</p>
<p></p><pre class="crayon-plain-tag">apiVersion: apps/v1
kind: Deployment
metadata:
  name: calc
spec:
  replicas: 1
  selector:
    matchLabels:
      app: calc
  template:
    metadata:
      labels:
        app: calc
    spec:
      containers:
        - name: ethercalc
          image: audreyt/ethercalc:latest
          ports:
            - containerPort: 8000
          env:
            - name: REDIS_PORT_6379_TCP_ADDR
              value: redis
            - name: REDIS_PORT_6379_TCP_PORT
              value: "6379"
          imagePullPolicy: Always
        - name: redis
          image: redis:latest
          volumeMounts:
            - name: redis-data
              mountPath: /data
          imagePullPolicy: Always</pre><p></p>
<p style="text-align: justify;">On voit qu&rsquo;il tente de mettre le nom du container dans la variable <span style="font-family: courier new, courier, monospace;">REDIS_PORT_6379_TCP_ADDR</span>, et √ßa ne fonctionne pas. Et bien j&rsquo;ai appris que dans ce cas, Kubernetes place les deux containers dans le m√™me r√©seau, ce qui veut dire qu&rsquo;on peut contacter le container voisin sur son port en utilisant ¬´¬†localhost¬†¬ª directement !</p>
<hr />
<p style="text-align: justify;">Voil√†, c&rsquo;est tout pour aujourd&rsquo;hui, vous l&rsquo;aurez compris, j&rsquo;abandonne pas la s√©rie mais faut pas s&rsquo;attendre √† voir un nouvel √©pisode dans moins d&rsquo;un mois <img src="https://s.w.org/images/core/emoji/11/72x72/1f600.png" alt="üòÄ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
]]></content:encoded>
        </item>
        <item>
            <title>Powerline.bash, le retour !</title>
            <link>https://blog.seboss666.info/2020/03/powerline-bash-le-retour/</link>
            <comments>https://blog.seboss666.info/2020/03/powerline-bash-le-retour/#comments</comments>
            <pubDate>Mon, 30 Mar 2020 16:30:23 +0000</pubDate>
            <dc:creator><![CDATA[Seboss666]]></dc:creator>
            <category><![CDATA[Astuces]]></category>
            <category><![CDATA[Sysadmin]]></category>
            <category><![CDATA[bash]]></category>
            <category><![CDATA[lourdeur]]></category>
            <category><![CDATA[portabilit√©]]></category>
            <category><![CDATA[powerline]]></category>
            <category><![CDATA[python]]></category>
            <category><![CDATA[shell]]></category>

            <guid isPermaLink="false">https://blog.seboss666.info/?p=6217</guid>
            <description><![CDATA[Pour ceux qui lisent le blog depuis un moment, vous savez que j&#8217;utilise Powerline pour d√©corer mon shell, ainsi que celui de mes machines virtuelles [...]]]></description>
            <content:encoded><![CDATA[<p style="text-align: justify;">Pour ceux qui lisent le blog depuis un moment, vous savez que j&rsquo;utilise Powerline <a href="https://blog.seboss666.info/2018/08/je-suis-passe-a-powerline-pour-mon-bash/" target="_blank" rel="noopener">pour d√©corer mon shell</a>, ainsi que celui de mes machines virtuelles √† la maison. Dans l&rsquo;ensemble j&rsquo;en suis tr√®s content, mais le projet qui m&rsquo;avait lanc√© sur la personnalisation de mon shell, powerline.bash, est revenu sous mes yeux, et oui, j&rsquo;ai craqu√©, j&rsquo;ai d√©cid√© de basculer dessus. Voyons donc pourquoi.</p>
<p style="text-align: justify;"><span id="more-6217"></span></p>
<p style="text-align: justify;">Si vous avez relu mon billet d&rsquo;origine, l&rsquo;installation de Powerline, notamment pour avoir un statut git assez visuel est assez lourde, en gros, en plus des paquets powerline et powerline-fonts, il me faut en plus <a href="https://pypi.org/project/powerline-gitstatus/" target="_blank" rel="noopener">un paquet pip</a> et une configuration maison plut√¥t charg√©e √† pousser. Autant dire que le contenu du playbook ansible pour d√©ployer tout √ßa est assez fat, mais bon, c&rsquo;est pas non plus la mort.</p>
<p style="text-align: justify;">Powerline a ses propres probl√®mes, et certains m&rsquo;avaient d&rsquo;ailleurs √©t√© relev√©s. Le principal, c&rsquo;est la latence. Il arrive parfois qu&rsquo;il mette un temps visible √† rendre la main, ouvrir un nouveau shell, et le probl√®me empire quand votre CPU est d√©j√† particuli√®rement charg√© comme c&rsquo;est souvent le cas derni√®rement sur mon laptop du boulot. J&rsquo;ai en plus eu des soucis √† l&rsquo;√©poque de la bascule Python 3.7 &gt; 3.8 sous Manjaro, ce qui m&rsquo;avait pouss√© √† devoir tout refaire (en gros j&rsquo;avais plus de prompt le temps que je corrige). Je n&rsquo;ai jamais r√©ussi non plus √† l&rsquo;avoir sur deux lignes, et plusieurs tentatives pour personnaliser plus avant se sont toujours sold√©es par des √©checs. Je ne pense pas √™tre plus b√™te qu&rsquo;un autre, mais l√† quand m√™me&#8230; Il y a certainement d&rsquo;autres contrari√©t√©s qui ne me reviennent pas en t√™te l√† tout de suite, mais voil√†, j&rsquo;ai √©t√© donc frustr√© plus d&rsquo;une fois avec son utilisation.</p>
<h3 style="text-align: justify;">¬´¬†Ha, ha, ha, ha, staying alive&#8230;¬†¬ª</h3>
<p style="text-align: justify;">Et au gr√© de mes flux RSS, Etienne Bersac, le d√©veloppeur de powerline.bash, a fait un <a href="https://linuxfr.org/users/bersace/journaux/actualite-de-powerline-bash-optimisations-icones-nouveaux-segments-et-plus" target="_blank" rel="noopener">journal sur linuxfr</a> pour discuter des mises √† jour. C&rsquo;√©tait l&rsquo;occasion de d√©couvrir que contrairement √† ce que je pensais, je n&rsquo;avais pas activ√© les notifications sur le d√©p√¥t, √ßa m&rsquo;apprendra √† √™tre plus vigilant. Donc, depuis le temps, il y a eu pas mal de petits raffinements et de corrections, de nouveaux segments, via des contributions externes, et celui sur git a bien √©volu√©. C&rsquo;est beaucoup plus int√©ressant d√©sormais.</p>
<p style="text-align: justify;">J&rsquo;ai donc retest√© le bousin, l&rsquo;installation et la configuration sont toujours aussi simples, √ßa tient √† un git clone et l&rsquo;ajout de deux lignes dans le bash_aliases. Dans mon cas √©videmment, √ßa demande aussi de virer/commenter les lignes n√©cessaires √† Powerline.</p>
<p style="text-align: justify;">Je vais la faire courte, j&rsquo;ai tout de suite √©t√© conquis. Certes, les d√©tails concernant le statut du d√©p√¥t git sont un peu moins fournies (j&rsquo;avais le nombre de fichiers avec leur statut quand le d√©p√¥t n&rsquo;√©tait pas √† jour, ainsi que le nombre de commits √† pousser), mais c&rsquo;est d√©sormais plus parlant, les couleurs sont mieux choisies, on voit qu&rsquo;on a des trucs √† pousser, il y a le support de plus d‚Äôic√¥nes. Et c&rsquo;est finalement largement suffisant pour √©viter de lancer des commandes sans avoir bien v√©rifi√© le statut du d√©p√¥t auparavant, √ßa √©conomise pas mal de commandes git status, toujours bon √† prendre.</p>
<div id="attachment_6218" style="width: 310px" class="wp-caption aligncenter"><a href="https://blog.seboss666.info/wp-content/uploads/2020/03/powerline_updated.png" rel="lightbox[6217]"><img class="wp-image-6218 size-medium" src="https://blog.seboss666.info/wp-content/uploads/2020/03/powerline_updated-300x45.png" alt="" width="300" height="45" srcset="https://blog.seboss666.info/wp-content/uploads/2020/03/powerline_updated-300x45.png 300w, https://blog.seboss666.info/wp-content/uploads/2020/03/powerline_updated-768x116.png 768w, https://blog.seboss666.info/wp-content/uploads/2020/03/powerline_updated-900x139.png 900w, https://blog.seboss666.info/wp-content/uploads/2020/03/powerline_updated.png 923w" sizes="(max-width: 300px) 100vw, 300px" /></a><p class="wp-caption-text">Dossier, venv python, statut git, tout ce qu&rsquo;il faut quoi <img src="https://s.w.org/images/core/emoji/11/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p></div>
<p style="text-align: justify;">Quant √† la vitesse de chargement et de r√©ponse, c&rsquo;est √©videmment le jour et la nuit. J&rsquo;ai donc entrepris de rebasculer mon profil dessus sur tous mes serveurs. l&rsquo;occasion de reprendre mes playbooks pour les remettre au gout du jour, cela faisait un moment qu&rsquo;ils n&rsquo;avaient pas √©t√© lanc√©s, et j&rsquo;ai √©galement d√©couvert plusieurs manques ou faiblesses (genre le playbook qui supprime la ligne pour charger acme.sh sur le bastion&#8230;). Petite particularit√© par rapport √† la doc, j&rsquo;ai opt√© pour un d√©ploiement du d√©p√¥t dans /opt, comme √ßa il n&rsquo;est clon√© qu&rsquo;une fois pour tous les utilisateurs que je modifie. Le module git d&rsquo;ansible se chargera des pull la prochaine fois, et voil√†.</p>
<p style="text-align: justify;">Et je pense que je vais envisager de le pousser aussi sur mes serveurs ¬´¬†publics¬†¬ª, comme celui que j&rsquo;utilise pour ce blog (qui va vraiment avoir besoin qu&rsquo;on lui refasse une beaut√©, √ßa devient intenable).</p>
<p style="text-align: justify;">En tout cas, c&rsquo;est du beau boulot, encore merci √† Etienne, ainsi qu&rsquo;aux contributeurs qui sont mentionn√©s dans le README. Je ne dis pas que j&rsquo;en ferai partie dans un futur proche, mais j&rsquo;avais d√©j√† particip√© √† l&rsquo;√©poque en terme de <a href="https://gitlab.com/bersace/powerline.bash/-/issues/3" target="_blank" rel="noopener">remont√©e de bug sur Ubuntu 16.04</a> &#8211; eh oui, tant qu&rsquo;il est support√©, on doit le prendre en compte, m√™me s&rsquo;il sent vraiment la naphtaline maintenant-, et j&rsquo;ai le segment Kubernetes √† tester sur le pc du boulot (pas encore √† la maison, je pense qu&rsquo;en termes de priorit√© la VM du blog est prioritaire). Donc y&rsquo;a peut‚Åª√™tre encore des trucs √† remonter ou contribuer <img src="https://s.w.org/images/core/emoji/11/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
]]></content:encoded>
            <wfw:commentRss>https://blog.seboss666.info/2020/03/powerline-bash-le-retour/feed/</wfw:commentRss>
            <slash:comments>2</slash:comments>
        </item>
        <item>
            <title>Youtube-dl sur un NAS Synology, c&#8217;est possible !</title>
            <link>https://blog.seboss666.info/2020/03/youtube-dl-sur-un-nas-synology-cest-possible/</link>
            <comments>https://blog.seboss666.info/2020/03/youtube-dl-sur-un-nas-synology-cest-possible/#comments</comments>
            <pubDate>Wed, 25 Mar 2020 17:30:01 +0000</pubDate>
            <dc:creator><![CDATA[Seboss666]]></dc:creator>
            <category><![CDATA[Astuces]]></category>
            <category><![CDATA[nas]]></category>
            <category><![CDATA[performances]]></category>
            <category><![CDATA[python]]></category>
            <category><![CDATA[ssh]]></category>
            <category><![CDATA[synology]]></category>
            <category><![CDATA[vid√©o]]></category>
            <category><![CDATA[virtualenv]]></category>
            <category><![CDATA[youtube]]></category>

            <guid isPermaLink="false">https://blog.seboss666.info/?p=6211</guid>
            <description><![CDATA[En partant chez ma m√®re pour mieux vivre le confinement prolong√© qui se profile devant nous, j&#8217;ai embarqu√© son NAS trop longtemps en maintenance avec [...]]]></description>
            <content:encoded><![CDATA[<p style="text-align: justify;">En partant chez ma m√®re pour mieux vivre le confinement prolong√© qui se profile devant nous, j&rsquo;ai embarqu√© son NAS trop longtemps en maintenance avec un disque dur neuf pour le remettre en service. Et parmi ce que j&rsquo;ai pr√©vu de lui faire faire, il y a la m√™me chose que chez moi, sauf que le Download Station embarqu√© ne sait plus r√©cup√©rer les vid√©os sur YouTube. Qu&rsquo;√† cela ne tienne il y a une solution !</p>
<p style="text-align: justify;"><span id="more-6211"></span></p>
<h3 style="text-align: justify;">Le NAS</h3>
<p style="text-align: justify;">Le NAS est un ancien Synology DS215j. C&rsquo;est un mod√®le pouvant accueillir deux disques, avec un processeur Armada 375 plus que poussif, et un syst√®me d&rsquo;exploitation bas√© sur Linux mais avec une interface web de gestion qui est d&rsquo;une lenteur hallucinante. Je l&rsquo;avais achet√© apr√®s la mort de mon serveur perso mont√© avec des composants d&rsquo;occasion qui est en fait toujours en vie, seulement un des disques √©tait mort, mais je n&rsquo;avais pas eu suffisamment confiance pour relancer cette machine dont la consommation ne me convenait plus.</p>
<p style="text-align: justify;">Ce NAS √©tait √©quip√© de deux disques de 2To, configur√©s en SHR, parce que Synology ne pose pas la question √† l&rsquo;installation et utilise son RAID maison. D√©j√† √ßa m&rsquo;avait gonfl√©, et √† l&rsquo;√©poque je n&rsquo;avais pas plus creus√© que √ßa et je l&rsquo;avais laiss√© en l&rsquo;√©tat. Mais avec la saturation des disques, et leur √¢ge grandissant coupl√© au bruit plus important de leur m√©canique, je l&rsquo;avais embarqu√© pour lui refaire une sant√© et une upgrade de disque.</p>
<p style="text-align: justify;">Cette p√©riode de maintenance s&rsquo;est donc termin√©e avec la remise en service sur un unique disque dur de 4To, le seul en √©tat de marche √† disposition, qui √©tait destin√© √† mon propre NAS, qui pourra attendre pendant mon absence.</p>
<h3 style="text-align: justify;">DSM 6 sur ce NAS, c&rsquo;est l&rsquo;enfer</h3>
<p style="text-align: justify;">Et c&rsquo;est peu de le dire. Si visuellement peu de choses ont chang√© dans l&rsquo;interface du syst√®me d&rsquo;exploitation de Synology, la gourmandise en performance est l√† : la moindre action fait grimper le CPU dans les tours, un simple listing des trois pauvres dossiers partag√©s cr√©√©s suffit, c&rsquo;est bien simple, chaque action prend plusieurs secondes pour voir son r√©sultat. Et ce n&rsquo;est pas que c√¥t√© serveur, le navigateur en prend aussi pour son grade, je ne sais pas avec quels pieds de l√©preux l&rsquo;interface a √©t√© cod√©e, mais c&rsquo;est une catastrophe.</p>
<p style="text-align: justify;">Malgr√© tout, les fonctionnalit√©s sont l√†, √† part que le Download Station ne sait plus r√©cup√©rer les vid√©os YouTube. Apparemment il ne repose pas sur youtube-dl comme Takeasy sur Asustor (mais qui n&rsquo;a pas √©t√© mis √† jour depuis plus d&rsquo;un mois, ce qui fait que certains sites auparavant support√©s ne fonctionnent plus).</p>
<h3 style="text-align: justify;">¬´¬†Oh mais y&rsquo;a Python 3 !¬†¬ª</h3>
<p style="text-align: justify;">La lumi√®re au bout du tunnel <img src="https://s.w.org/images/core/emoji/11/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;" /> En effet, dans le gestionnaire de paquets de DSM, il est possible d&rsquo;installer Python 3, en pus de Python 2 qui est d√©j√† install√©. L&rsquo;installation via l&rsquo;interface est simple, comme n&rsquo;importe quel paquet. Reste ensuite √† activer SSH et les home directory, pour ensuite se connecter √† son compte en ligne de commande.</p>
<p style="text-align: justify;">Youtube-dl s&rsquo;installe via pip. Mais par d√©faut, pip ne semble pas disponible. Arf. Mais c&rsquo;est partiellement faux. De toute fa√ßon, pour tout projet qui n√©cessite d&rsquo;utiliser pip, il est recommand√© de passer par un virtualenv, un environnement virtuel adapt√© √† un projet en particulier. Et √ßa tombe bien, python 3 permet d&rsquo;en cr√©er d&rsquo;une mani√®re particuli√®rement simple :</p>
<p></p><pre class="crayon-plain-tag">seboss666@Mariz_NAS:~$ python3 -m venv yt</pre><p></p>
<p style="text-align: justify;">Et hop, quelques longues secondes apr√®s, on a un dossier yt qui contient notre virtualenv :</p>
<p></p><pre class="crayon-plain-tag">seboss666@Mariz_NAS:~/yt$ ll
total 36
drwxr-xr-x 7 seboss666 users 4096 Mar 22 22:53 .
drwxr-xr-x 5 seboss666 users 4096 Mar 22 22:51 ..
drwxr-xr-x 2 seboss666 users 4096 Mar 22 22:53 bin
drwxr-xr-x 4 seboss666 users 4096 Mar 22 22:53 etc
drwxr-xr-x 2 seboss666 users 4096 Mar 22 22:51 include
drwxr-xr-x 3 seboss666 users 4096 Mar 22 22:51 lib
-rw-r--r-- 1 seboss666 users   61 Mar 22 22:52 pip-selfcheck.json
-rw-r--r-- 1 seboss666 users   75 Mar 22 22:51 pyvenv.cfg
drwxr-xr-x 4 seboss666 users 4096 Mar 22 22:53 share</pre><p></p>
<p style="text-align: justify;">Ensuite on l&rsquo;active comme n&rsquo;importe quel venv :</p>
<p></p><pre class="crayon-plain-tag">seboss666@Mariz_NAS:~/yt$ source bin/activate
(yt) seboss666@Mariz_NAS:~$ pip --version
pip 7.1.2 from /volume1/homes/seboss666/yt/lib/python3.5/site-packages (python 3.5)</pre><p></p>
<p style="text-align: justify;">Notez le petit (yt) qui permet de visualiser qu&rsquo;on est dans un virtualenv python. Et surprise, pip est bien pr√©sent ! Par contre il sent fort la napthaline. On va donc en profiter pour le mettre √† jour, et tenter d&rsquo;installer youtube-dl :</p>
<p></p><pre class="crayon-plain-tag">(yt) seboss666@Mariz_NAS:~$ pip install --upgrade pip
Collecting pip
  Downloading https://files.pythonhosted.org/packages/54/0c/d01aa759fdc501a58f431eb594a17495f15b88da142ce14b5845662c13f3/pip-20.0.2-py2.py3-none-any.whl (1.4MB)
    100% |‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 1.4MB 45kB/s
Installing collected packages: pip
  Found existing installation: pip 7.1.2
    Uninstalling pip-7.1.2:
      Successfully uninstalled pip-7.1.2
Successfully installed pip-20.0.2
(yt) seboss666@Mariz_NAS:~$ pip install youtube-dl
Collecting youtube-dl
  Downloading youtube_dl-2020.3.8-py2.py3-none-any.whl (1.8 MB)
     |‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 1.8 MB 3.7 MB/s
Installing collected packages: youtube-dl
Successfully installed youtube-dl-2020.3.8</pre><p></p>
<p style="text-align: justify;">Eh ben, √ßa semble parfait ! Il faut juste s&rsquo;assurer d&rsquo;un dernier d√©tail. En effet, sur plusieurs sites pratiquant le HLS ou le DASH, la vid√©o et l&rsquo;audio sont s√©par√©s en flux distincts, et youtube-dl a l&rsquo;habitude d&rsquo;utiliser ffmpeg pour recoller les morceaux :</p>
<p></p><pre class="crayon-plain-tag">(yt) seboss666@Mariz_NAS:~/yt$ which ffmpeg
/bin/ffmpeg</pre><p></p>
<p style="text-align: justify;">Cool <img src="https://s.w.org/images/core/emoji/11/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;" /> Je ne sais par contre pas si c&rsquo;est install√© de base sur le NAS, ou si √ßa provient d&rsquo;un autre paquet comme le serveur multim√©dia, install√© afin de fournir du DLNA au lecteur Bluray, et qui a une option de transcodage vid√©o, d&rsquo;o√π le recours potentiel √† ffmpeg. Dans le doute, vous pourrez v√©rifier par vous-m√™me, moi c&rsquo;est d√©j√† install√© et configur√© je touche plus √† rien.</p>
<h3 style="text-align: justify;">Le probl√®me de l&rsquo;indexation multim√©dia</h3>
<p style="text-align: justify;">Eh oui, si ce n&rsquo;est pas une astuce en vrac, c&rsquo;est pas juste pour pouvoir vous faire l&rsquo;historique du NAS et une critique de ses performances, vous le voyez √† la simplicit√© √ßa aurait pu tenir en un seul paragraphe ou presque. Quand on t√©l√©charge un fichier avec Download Station, ou qu&rsquo;on pousse un fichier par SMB (le partage r√©seau), le fichier est presque imm√©diatement disponible pour le lecteur Bluray. Malheureusement, pour une raison que j&rsquo;ignore, ce n&rsquo;est pas le cas pour les vid√©os r√©cup√©r√©es par youtube-dl, et de m√©moire les vid√©os pouss√©es via rsync/ssh non plus.</p>
<p style="text-align: justify;">Il faut donc, dans ce cas, forcer une r√©indexation qui va prendre plus ou moins de temps en fonction de la taille de la biblioth√®que, et qui se d√©clenche avec la commande suivante :</p>
<p></p><pre class="crayon-plain-tag">(yt) seboss666@Mariz_NAS:/volume1/Download$ sudo synoindex -R all</pre><p></p>
<p style="text-align: justify;">Bon apr√®s, l&rsquo;interface du lecteur Bluray LG est une honte et le rafra√Æchissement provoque une erreur qui demande de retourner √† l&rsquo;accueil pour refaire tout le chemin vers le dossier voulu. Mais √ßa fonctionne <img src="https://s.w.org/images/core/emoji/11/72x72/1f642.png" alt="üôÇ" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<h3 style="text-align: justify;">Les NAS maison me manquent (et les vrais lecteurs multimedia aussi)</h3>
<p style="text-align: justify;">J&rsquo;avoue, entre la puissance fam√©lique, l&rsquo;indexation s√©lective, et l&rsquo;interface p√©nible du bluray, je regrette vraiment OpenMediaVault, minidlna et Kodi. Disposer d&rsquo;un lecteur Bluray disposant d&rsquo;une interface aussi propre que Kodi est illusoire, ne serait-ce que parce que ce dernier ne dispose pas de toutes les technologies pour lire des bluray pourris par des DRM qui imposent de payer des licences √† sept chiffres, dont on devrait pourtant avoir les cl√©s pour des raisons d&rsquo;interop√©rabilit√©. <a href="https://www.nextinpact.com/news/78893-vlc-hadopi-na-pas-clef-pour-ouvrir-porte-blu-ray.htm" target="_blank" rel="noopener">VLC s&rsquo;y est cass√© les dents</a>, notamment gr√¢ce aux <a href="https://www.nextinpact.com/news/93861-wikileaks-l-intervention-geants-blu-ray-dans-dossier-hadopi-vlc.htm" target="_blank" rel="noopener">pressions de Sony</a> qui se gave en licences, et rien n&rsquo;a boug√© depuis (il faut dire que le march√© stagne, voire baisse quand la VOD en streaming explose, donc sont pas press√©s de filer les cl√©s de la bagnole). Mon raspberry Pi <a href="https://blog.seboss666.info/2016/12/openelec-libreelec-osmc-mais-cest-devenu-le-bordel-ma-pauvre-dame/" target="_blank" rel="noopener">sous LibreELEC</a> me donne toujours enti√®re satisfaction, sauf pour le plugin YouTube qui m&rsquo;a pouss√© √† me tourner vers d&rsquo;autres solutions.</p>
<p style="text-align: justify;">Quant √† <a href="https://www.openmediavault.org/" target="_blank" rel="noopener">Openmediavault</a>, le projet est toujours maintenu et toujours aussi int√©ressant, le probl√®me, c&rsquo;est que le mat√©riel pour le faire tourner sera forc√©ment plus volumineux, consommateur de ressources, et potentiellement beaucoup plus cher. M√™me si en termes de consommation on sera proche avec <a href="https://blog.seboss666.info/2017/01/le-futur-de-mon-infrastructure-personnelle/" target="_blank" rel="noopener">mon microserveur</a>, atteindre un tarif de 180‚Ç¨ pour la base sans les disques rel√®ve du miracle, puisque c&rsquo;est juste le prix de la carte m√®re avec CPU soud√© sans la RAM, sans le boitier, sans l&rsquo;alimentation, autant d&rsquo;√©l√©ments inclus pour le prix. Avec un CPU x86 toutefois, on aurait acc√®s √† beaucoup plus de puissance et d&rsquo;usages, ce que j&rsquo;avais fini par faire √† l&rsquo;√©poque sur mon NAS maison, avec l&rsquo;ajout d&rsquo;une machine virtuelle en plus du reste.La probl√©matique du CPU dans les NAS a parfaitement √©t√© analys√©e par David, je vous laisse <a href="https://www.inpact-hardware.com/article/1129/atom-c-ou-pentium-d-quelles-differences-sur-performances-dun-nas" target="_blank" rel="noopener">lire son dossier</a> si vous souhaitez creuser le sujet. Minidlna fonctionne quelque soit la m√©thode pour ajouter un fichier, puisque c&rsquo;est le noyau et uniquement lui qui pr√©venait de l&rsquo;arriv√©e d&rsquo;un fichier, peu importe qu&rsquo;il soit d√©pos√© via une application, un partage r√©seau, un transfert SSH.</p>
<p style="text-align: justify;">Bref, comme trop souvent avec l&rsquo;informatique, la libert√© et le confort ont un prix, et pour les usages de ma m√®re, la libert√© et la performance ne sont pas des priorit√©s absolues, donc on va s&rsquo;en contenter. Par contre, son lecteur Bluray/home cinema donne quelques signes de fatigue, et √ßa co√ªte cher √† remplacer, j&rsquo;esp√®re que √ßa tiendra encore quelques ann√©es.</p>
]]></content:encoded>
            <wfw:commentRss>https://blog.seboss666.info/2020/03/youtube-dl-sur-un-nas-synology-cest-possible/feed/</wfw:commentRss>
            <slash:comments>6</slash:comments>
        </item>
        <item>
            <title>Brider les services vid√©o sur le Web, une tr√®s mauvaise id√©e !</title>
            <link>https://blog.seboss666.info/2020/03/brider-les-services-video-sur-le-web-une-tres-mauvaise-idee/</link>
            <comments>https://blog.seboss666.info/2020/03/brider-les-services-video-sur-le-web-une-tres-mauvaise-idee/#comments</comments>
            <pubDate>Sun, 22 Mar 2020 09:30:31 +0000</pubDate>
            <dc:creator><![CDATA[Seboss666]]></dc:creator>
            <category><![CDATA[Humeur]]></category>
            <category><![CDATA[bridage]]></category>
            <category><![CDATA[conflit]]></category>
            <category><![CDATA[lobbying]]></category>
            <category><![CDATA[neutralit√©]]></category>
            <category><![CDATA[piratage]]></category>
            <category><![CDATA[r√©alit√©]]></category>

            <guid isPermaLink="false">https://blog.seboss666.info/?p=6205</guid>
            <description><![CDATA[J&#8217;ai √©t√© particuli√®rement √©nerv√© par tous les discours alarmistes sur la possible ¬´¬†saturation d&#8217;Internet¬†¬ª, et des demandes d√©biles de nos dirigeants aupr√®s de certains acteurs [...]]]></description>
            <content:encoded><![CDATA[<p style="text-align: justify;">J&rsquo;ai √©t√© particuli√®rement √©nerv√© par tous les discours alarmistes sur la possible ¬´¬†saturation d&rsquo;Internet¬†¬ª, et des demandes d√©biles de nos dirigeants aupr√®s de certains acteurs de se brider volontairement pour l&rsquo;√©viter. D&rsquo;une part parce que c&rsquo;est faux, et d&rsquo;autre part parce que nos dirigeant profitent une fois de plus d&rsquo;un contexte exceptionnel pour mettre √† mal notre outil pr√©f√©r√©. Et √ßa commence √† √™tre p√©nible.</p>
<p style="text-align: justify;"><span id="more-6205"></span></p>
<p style="text-align: justify;">√áa n&rsquo;aura √©chapp√© √† personne : impossible de d√©passer le 480p sur YouTube, Netflix ¬´¬†n&rsquo;existe plus¬†¬ª en 4K, ni m√™me voire en FullHD (les r√©solutions sont certainement toujours l√†, mais vu la gueule de la compression √ßa fait pas envie). Et l√†, derni√®re connerie demand√©e par Thierry Breton, <a href="https://www.nextinpact.com/news/108820-le-lancement-disney-repousse-au-7-avril-a-demande-gouvernement-et-dorange.htm" target="_blank" rel="noopener">le report du lancement de Disney+</a>, service de streaming vid√©o √† la demande par abonnement du g√©ant de la production audiovisuelle am√©ricain, lancement qui se faire le 24 mars et qui est repouss√© de deux semaines.</p>
<p style="text-align: justify;">C&rsquo;est une √©norme connerie pour plusieurs raisons. D√©j√†, parce que comme l&rsquo;a d√©j√† <a href="https://framablog.org/2020/03/21/linternet-pendant-le-confinement/" target="_blank" rel="noopener">tr√®s bien √©crit St√©phane Bortzmeyer</a> (cet homme √©crit d√©cid√©ment tr√®s peu d&rsquo;√¢neries compar√© √† moi, donc vous g√™nez pas pour le lire), la raison invoqu√©e est le risque de saturation des r√©seaux, ce qui est compl√®tement faux actuellement, m√™me si certains sympt√¥mes pourront le laisser penser. Comme un nez qui coule ou une l√©g√®re toux, en ces temps de parano√Øa li√©e au virus, ne signifie pas qu&rsquo;on l&rsquo;a chop√©, les autres maladies n&rsquo;ont pas d√©cid√© de prendre des vacances. Une sensation de ¬´¬†lenteur¬†¬ª du r√©seau √† un niveau local pourra se produire sans que le r√©seau dans sa globalit√© soit souffrant. D&rsquo;ailleurs dire LE r√©seau n&rsquo;a pas de sens, Internet est un assemblage de nombreux r√©seaux, actuellement entre 40 000 et 50 000, l√† o√π √ßa peut p√™cher par moments c&rsquo;est dans les points d&rsquo;interconnexion de ces r√©seaux. Mais d&rsquo;une part chaque r√©seau √† plusieurs interconnexions, et d&rsquo;autre part, augmenter ces capacit√©s est beaucoup plus facile que ne le croient nos dirigeants. Vraiment, lisez le billet de St√©phane, vous comprendrez.</p>
<p style="text-align: justify;">√Ä la limite, si vraiment on pense que les services de vid√©o √† la demande font chier, ce ne sont pas juste Netflix et YouTube qu&rsquo;il faut coincer, mais tout le monde, et √† tous les niveaux. Normalement dans un monde neutre, si on veut dire qu&rsquo;un type de service n&rsquo;est pas prioritaire, ce sont tous les acteurs qui doivent √™tre touch√©s, pour la bonne et simple raison qu&rsquo;il ne faut pas cr√©er de distorsion de concurrence. Hors, aucune annonce aupr√®s de Dailymotion, de Whatsapp, TikTok, Snap, des services de replays des cha√Ænes fran√ßaises (qui passent tous par le Web), et en gros, tous les services de communications ou de diffusion vid√©o (Twitch, Mixer, etc). Tous ces acteurs sont soit non essentiels (et encore une fous de plus, quand ont voit les initiatives des profs qui partagent ou commencent √† cr√©er du contenu pour les gamins, on comprend qu&rsquo;il y a un probl√®me √† demander √† brider youtube), soit peuvent brider la qualit√© de leur service sans que √ßa ne change fondamentalement la fonction. Un live snap en SD, vu l&rsquo;int√©r√™t de base du service, √ßa tuera personne, et √ßa n&#8217;emp√™che pas de comprendre ce qui se dit. Idem pour les outils de visio-conf√©rence, de toute fa√ßon vu la qualit√© d√©plorable des webcams y compris dans les laptops les plus chers du march√©, je pense qu&rsquo;on peut dire qu&rsquo;il n&rsquo;est pas grave que la d√©finition soit un peu r√©duite pour la vid√©o. C&rsquo;est un peu plus chiant sur les partages d&rsquo;√©cran par contre parce que la compression tue la lisibilit√© des textes.</p>
<p style="text-align: justify;">Pareil, on n&rsquo;y pense pas mais avec les live Facebook qui se multiplient de la part des artistes qui ne peuvent plus se produire sur sc√®ne mais qui veulent quand m√™me partager (comme quoi il n&rsquo;est pas seulement question d&rsquo;argent et de droit d&rsquo;auteur, n&rsquo;est-ce pas Pascal Rogard ?), vu le trafic drain√© par Facebook, √ßa fait un peu mal au cul en th√©orie aussi, alors pourquoi ne pas avoir √©galement demand√© √† Marky Mark de brider son service ? Enfin bref, vous avez l&rsquo;id√©e, pour moi si on doit brider un type de service, c&rsquo;est pour tout le monde pareil, quel que soit la taille de l&rsquo;acteur, aucune discrimination. C&rsquo;est ce qu&rsquo;on appelle la neutralit√©.</p>
<p style="text-align: justify;">Retarder Disney+ est aussi une √©norme connerie √† l&rsquo;heure du confinement des gamins chez eux. Alors que certains parents commencent d√©j√† √† aff√ªter leur pelle, et que Disney a consciencieusement retir√© ses contenus, dont tous ceux qu&rsquo;il poss√®de gr√¢ce aux multiples rachats de ces derni√®res ann√©es : Marvel, Fox, etc, de tous les services concurrents, Netflix en t√™te (ce qui a provoqu√© d&rsquo;ailleurs la fin des productions conjointes au niveau des s√©ries TV, dommage pour Punisher et Daredevil), des services concurrents, ceux qui attendent de pied ferme de pouvoir enfin redonner des doses de Reine des neiges aux gamins pendant qu&rsquo;ils essaient de bosser vont devoir ronger leur frein. Ou alors relancer le t√©l√©chargement ill√©gal via Bittorrent, ce qui est donc l&rsquo;inverse de l&rsquo;objectif vis√© par ces services qui est que d&rsquo;une mani√®re ou d&rsquo;une autre, les utilisateurs paient pour visionner le contenu, ce que ce cher Pascal souhaite.</p>
<p style="text-align: justify;">Aucun journaliste ne s&rsquo;est interrog√© sur la possibilit√© que ce ne soit que du pur lobbying, ou du pur protectionnisme √©conomique, voire pire du copinage √† la limite du conflit d&rsquo;int√©r√™t. Tous les services touch√©s par la demande de bridage sont am√©ricains et pas europ√©ens, et on sait √† quel point les dirigeants europ√©ens sont emb√™t√©s de voir ces entreprises respecter les r√®gles d&rsquo;optimisation fiscales qu&rsquo;ils ont vot√©s pendant plus de vingt ans. Et on sait aussi que les op√©rateurs europ√©ens aimeraient grandement faire payer aussi les services am√©ricains pour que le trafic passe par eux, en mode ¬´¬†Canalsat¬†¬ª o√π les abonn√©s paient pour le visionnage, mais de l&rsquo;autre c√¥t√© les cha√Ænes paient aussi pour √™tre diffus√©es. Le probl√®me c&rsquo;est que ce n&rsquo;est pas le m√™me type de r√©seau, mais passons. Personne ne semble aussi s&rsquo;√©mouvoir du pass√© de <a href="https://fr.wikipedia.org/wiki/Thierry_Breton" target="_blank" rel="noopener">Thierry Breton</a>, qui a pass√© quelques ann√©es √† la t√™te d&rsquo;un certain France T√©l√©com, qui s&rsquo;est depuis d√©finitivement renomm√© en Orange. Je n&rsquo;ai aucun doute sur la comp√©tence du personnage au poste qu&rsquo;il occupe actuellement et qui lui a permis de lancer ses demandes, vu le profil c&rsquo;est d&rsquo;ailleurs probablement un tr√®s bon choix. Mais √ßa me g√®ne un peu quand m√™me du coup dans ce contexte, un ancien copain chez l&rsquo;op√©rateur aurait pu lui souffler l&rsquo;id√©e que √ßa ne m&rsquo;√©tonnerait pas plus que √ßa.</p>
<p style="text-align: justify;">Surtout que techniquement, les op√©rateurs savent eux-m√™me brider les flux, ils savent m√™me brider des protocoles depuis tr√®s longtemps. Qui n&rsquo;a pas √©t√© surpris √† une √©poque, chez Free en non-d√©group√©, de ne plus pouvoir faire de bittorrent ou d&rsquo;e-mule du jour au lendemain ? protocoles qui se sont mis √† refonctionner soit via vpn ou via des fonctions d&rsquo;obfuscation des protocoles ? Une fois de plus, c&rsquo;est √©conomique. √Ä l&rsquo;image du confinement physique que personne ne semble vouloir respecter en r√©gion parisienne, haut lieu du nombrilisme √† la fran√ßaise qui commence √† provoquer des sueurs dans les h√¥pitaux proches des r√©gions o√π ces connards ont fui, pourquoi on ne ¬´¬†confinerait pas¬†¬ª les connexions internet dans leur ensemble ? Il n&rsquo;est absolument pas n√©cessaire actuellement que chaque foyer dispose d&rsquo;un Gigabit voire plus de bande passante, la moiti√© voire le tiers suffit amplement pour plusieurs personnes en parall√®le. Mais si les op√©rateurs le font d&rsquo;eux-m√™me, les utilisateurs vont se tourner alors massivement vers les services clients, qui ne savent d√©j√† pas g√©rer les demandes habituelles des utilisateurs, et donc co√ªter cher.</p>
<p style="text-align: justify;">En termes d&rsquo;images c&rsquo;est g√©nial aussi, ¬´¬†regardez, on peut faire plier les ricains¬†¬ª, qui √©videmment n&rsquo;ont pas envie de passer pour les m√©chants dans le contexte, m√™me si c&rsquo;est enti√®rement faux. Apr√®s tout ils mettent le service √† disposition, ils ne forcent pas les utilisateurs √† s&rsquo;en servir, ni l&rsquo;appareil ou le r√©seau depuis lequel ils y acc√®dent. Le probl√®me, c&rsquo;est que les op√©rateurs ne veulent pas non plus qu&rsquo;on sache √† quel point ils sont mauvais en gestion de r√©seau, enfin surtout en gestion d&rsquo;interconnexion. Ce sont tous des services am√©ricains, et les interconnexions avec les USA passent par l&rsquo;Atlantique, ce qui co√ªte cher. Historiquement les op√©rateurs fran√ßais paient le minimum syndical, et on a un historique de probl√®mes notamment le soir qui est long comme le bras. Moi-m√™me pendant plus d&rsquo;un an et demi, j&rsquo;ai exp√©riment√© ces probl√®mes d&rsquo;acc√®s √† des services Hors France chez Free. Quand la signature et le d√©ploiement d&rsquo;une interconnexion directe du r√©seau de Free avec Google a eu lieu, le lien qui √©tait utilis√© pour tous les services US semble-t-il a eu du mieux, et l√† o√π Twitter avait pas mal de probl√®mes le soir, miracle tout allait mieux. Mais √ßa n&rsquo;allait pas toujours parfaitement, et Netflix avait r√©guli√®rement des soucis le soir, √ßa pixellisait pas mal, le lecteur r√©duisant la qualit√© pour tenter d&rsquo;√©viter la coupure dans la lecture. Mais √ßa ne suffisait pas. Quand Netflix a annonc√© des signatures de partenariat avec plusieurs op√©rateurs Fran√ßais, dont Free, comme c&rsquo;est surprenant les probl√®mes ont disparu. C&rsquo;est con √ßa fait plus d&rsquo;un an j&rsquo;ai pas les graphes smokeping pour vous montrer les niveaux monstrueux de pertes de paquets que j&rsquo;avais √† l&rsquo;√©poque.</p>
<div id="attachment_6209" style="width: 310px" class="wp-caption aligncenter"><a href="https://blog.seboss666.info/wp-content/uploads/2020/03/smokeping_neflix.png" rel="lightbox[6205]"><img class="size-medium wp-image-6209" src="https://blog.seboss666.info/wp-content/uploads/2020/03/smokeping_neflix-300x201.png" alt="" width="300" height="201" srcset="https://blog.seboss666.info/wp-content/uploads/2020/03/smokeping_neflix-300x201.png 300w, https://blog.seboss666.info/wp-content/uploads/2020/03/smokeping_neflix.png 760w" sizes="(max-width: 300px) 100vw, 300px" /></a><p class="wp-caption-text">L&rsquo;augmentation de la latence de Netflix sur ma connexion ADSL hier, alors que je suis pas chez moi. Et c&rsquo;est normal, y&rsquo;a pas de probl√®me.</p></div>
<p style="text-align: justify;">Les op√©rateurs savent donc s&rsquo;adapter sans avoir besoin de demander √† un encostard√© de gesticuler pour demander aux am√©ricains de se brider d&rsquo;eux-m√™me. Le probl√®me n&rsquo;est donc pas technique, et ces gesticulations sont √† la limite de la honte. Mais de la m√™me fa√ßon qu&rsquo;on voit bien que la gestion de la crise sanitaire a toujours eu une priorit√© √©conomique (pas tr√®s surprenant de la part d&rsquo;un pr√©sident ancien banquier et copains des grands patrons), ces gesticulations ne sont qu&rsquo;un indice de plus qui montre bien √† quel point la population est bien le dernier cadet des soucis que veulent traiter les dirigeants.</p>
<p style="text-align: justify;">En attendant, les utilisateurs, eux, vont subir ces d√©cisions, et s&rsquo;adapter, tr√®s souvent de la pire des mani√®res, comme c&rsquo;est le cas actuellement pour les gamins et profs qui s&rsquo;organisent autour de Youtube, whatsapp, Google apps plut√¥t que les ENT de leurs √©coles qui ne fonctionnent d√©j√† pas bien en temps normal, et plus du tout en cette p√©riode de crise. Et il faudra que nos dirigeants expliquent √† Disney pourquoi il n&rsquo;engrange pas les utilisateurs qu&rsquo;il pensait avoir apr√®s les avoir affam√©, quand ils auront repris go√ªt au t√©l√©chargement ill√©gal, go√ªt qui avait pris des ann√©es pour leur faire en partie oublier, car ce sera le seul moyen de retrouver √† la fois les titre et la qualit√© qu&rsquo;on s&rsquo;attend √† avoir, y compris en temps de crise ?</p>
<p style="text-align: justify;">Bref √ßa me gonfle. En attendant, je vais remettre en place le NAS chez ma maman, elle aussi n&rsquo;a pas tous ses contenus et y&rsquo;a du taf. Bon dimanche, bon courage, et <strong>RESTEZ CHEZ VOUS BORDEL !!!</strong></p>
]]></content:encoded>
            <wfw:commentRss>https://blog.seboss666.info/2020/03/brider-les-services-video-sur-le-web-une-tres-mauvaise-idee/feed/</wfw:commentRss>
            <slash:comments>3</slash:comments>
        </item>
        <item>
            <title>Zstd : c&#8217;est quoi ce format de compression ?</title>
            <link>https://blog.seboss666.info/2020/03/zstd-cest-quoi-ce-format-de-compression/</link>
            <comments>https://blog.seboss666.info/2020/03/zstd-cest-quoi-ce-format-de-compression/#comments</comments>
            <pubDate>Fri, 06 Mar 2020 17:30:07 +0000</pubDate>
            <dc:creator><![CDATA[Seboss666]]></dc:creator>
            <category><![CDATA[Applications]]></category>
            <category><![CDATA[Sysadmin]]></category>
            <category><![CDATA[algorithme]]></category>
            <category><![CDATA[compression]]></category>
            <category><![CDATA[performance]]></category>
            <category><![CDATA[test]]></category>
            <category><![CDATA[zstd]]></category>

            <guid isPermaLink="false">https://blog.seboss666.info/?p=6169</guid>
            <description><![CDATA[Certains diront que je d√©barque, mais le fait est qu&#8217;il y a eu une r√©cente actualit√© autour de ce format relativement r√©cent de compression sans [...]]]></description>
            <content:encoded><![CDATA[<p style="text-align: justify;">Certains diront que je d√©barque, mais le fait est qu&rsquo;il y a eu une r√©cente actualit√© autour de ce format relativement r√©cent de compression sans perte, car il commence √† √™tre utilis√© par d√©faut sur Arch Linux, et par cons√©quent, Manjaro. On s&rsquo;est d√©j√† int√©ress√© √† la compression sous plusieurs formes <a href="https://blog.seboss666.info/2018/02/nous-vivons-dans-un-monde-compresse/" target="_blank" rel="noopener">par le pass√©</a>, √ßa fait longtemps, voyons pourquoi ce format gagne en popularit√©.</p>
<p style="text-align: justify;"><span id="more-6169"></span></p>
<p style="text-align: justify;">C&rsquo;est en effet suite √† une note de mise √† jour du 20 janvier dernier que j&rsquo;ai entendu r√©ellement parler de zstd :</p>
<blockquote><p>Upstream notice</p>
<p>:</p>
<p>&nbsp;</p>
<p>Arch updated their default compression to zstd 18. We adopted to the same standard. More and more packages will have the zst extension from now on.</p></blockquote>
<p style="text-align: justify;">Bon, OK, un nouveau format que je ne connaissais pas. C&rsquo;est pas si choquant, ma veille n&rsquo;est pas sp√©cialement orient√©e sur ces sujets, donc on va un peu s&rsquo;int√©resser √† ce nouveau venu qui semble avoir beaucoup de succ√®s aupr√®s de diff√©rentes distributions Linux comme on va le voir.</p>
<h3 style="text-align: justify;">Here comes a new challenger</h3>
<p style="text-align: justify;">Zstandard, parce que c&rsquo;est son vrai nom, est tout r√©cent dans l&rsquo;univers des algorithmes de compression sans perte, car il n&rsquo;est d√©velopp√© que depuis 2015. Enfin presque, car un de ses principes fondamentaux remonte √†&#8230; 1977. L&rsquo;utilisation d&rsquo;un dictionnaire n&rsquo;est donc pas nouveau pour la compression, il est m√™me d&rsquo;ailleurs au c≈ìur du format LZMA qui a gagn√© en popularit√© gr√¢ce √† un outil que vous devez conna√Ætre, 7-zip. Autant dire qu&rsquo;on conna√Æt bien les maths derri√®re √ßa; pas moi personnellement hein, je suis pas encore assez bon, mais y&rsquo;a des furieux qui ma√Ætrisent bien le sujet, et si vous voulez en savoir plus, <a href="https://fr.wikipedia.org/wiki/LZ77_et_LZ78" target="_blank" rel="noopener">Wikipedia est votre ami</a>.</p>
<p style="text-align: justify;">Mais alors quel est l&rsquo;attrait de ce petit nouveau pas si nouveau d&rsquo;un point de vue conceptuel ? Pourquoi est-il soutenu par Facebook ? Eh bien, sa grande promesse n&rsquo;est pas li√© √† sa performance de compression, mais sa rapidit√©. Rapidit√© √† la fois pour la compression mais aussi la d√©compression, peut-√™tre encore plus pour la d√©compression d&rsquo;ailleurs, car ses performances varient peu quelque soit le niveau de compression choisi au d√©part. Quant au niveau de compression, il est cens√© √™tre comparable √† gzip, tout en √©tant plus rapide que celui-ci.</p>
<h3 style="text-align: justify;">Et si on testait nous-m√™me ?</h3>
<p style="text-align: justify;">Pour v√©rifier √ßa, j&rsquo;ai fait deux petits tests afin de mesurer cette promesse. Le premier est sur un unique fichier WAV, qui ne devrait pas donner de tr√®s bons r√©sultats sur le taux de compression, l&rsquo;autre sur un dossier composite √† savoir une copie du blog, donc un mix entre fichiers textes et images, plus int√©ressant. Ce dossier sera ¬´¬†concat√©n√©¬†¬ª dans un fichier tar, m√™me si zstd est capable d&rsquo;it√©rer sur un dossier en mode r√©cursif, ce que ne savent pas n√©cessairement faire ses cousins.</p>
<p style="text-align: justify;">Pour chaque test, j&rsquo;ai fait une copie distincte du fichier d&rsquo;origine pour limiter les impacts du cache noyau par une lecture r√©p√©t√©e. J&rsquo;utilise time pour mesurer le temps de traitement, compression et d√©compression, et les param√®tres par d√©faut pour chaque commande. Voil√†, les conditions sont pos√©es, passons aux r√©sultats.</p>
<p style="text-align: justify;"><strong>Fichier WAV</strong></p>
<p></p><pre class="crayon-plain-tag">$ time gzip Alestorm\ -\ Sunset\ On\ The\ Golden\ Age.gz.wav

real	0m22,659s
user	0m22,001s
sys	0m0,566s
$ time xz Alestorm\ -\ Sunset\ On\ The\ Golden\ Age.xz.wav

real	1m16,755s
user	4m40,875s
sys	0m1,676s
$ time zstd Alestorm\ -\ Sunset\ On\ The\ Golden\ Age.zst.wav
Alestorm - Sunset On The Golden Age.zst.wav : 97.96%   (514968188 =&gt; 504438852 bytes, Alestorm - Sunset On The Golden Age.zst.wav.zst)

real	0m1,096s
user	0m1,169s
sys	0m0,550s</pre><p></p>
<p style="text-align: justify;">Eh bien le moins qu&rsquo;on puisse dire, c&rsquo;est que c&rsquo;est effectivement tr√®s rapide. Et quid de la taille ?</p>
<p></p><pre class="crayon-plain-tag">$&amp;nbsp;l
total 2,8G
drwxr-xr-x 2 seboss666 seboss666 4,0K 02.03.2020 17:34  ./
drwxr-xr-x 8 seboss666 seboss666 4,0K 02.03.2020 17:22  ../
-rw-r--r-- 1 seboss666 seboss666 477M 02.03.2020 17:28 'Alestorm - Sunset On The Golden Age.gz.wav.gz'
-rw-r--r-- 1 seboss666 seboss666 492M 02.03.2020 17:27 'Alestorm - Sunset On The Golden Age.wav'
-rw-r--r-- 1 seboss666 seboss666 472M 02.03.2020 17:28 'Alestorm - Sunset On The Golden Age.xz.wav.xz'
-rw-r--r-- 1 seboss666 seboss666 492M 02.03.2020 17:28 'Alestorm - Sunset On The Golden Age.zst.wav'
-rw-r--r-- 1 seboss666 seboss666 482M 02.03.2020 17:28 'Alestorm - Sunset On The Golden Age.zst.wav.zst'</pre><p></p>
<p style="text-align: justify;">On voit que le xz est largement au dessus des deux autres concurrents, mais le prix en temps de compression est tr√®s √©lev√©. Ici, on voit que le zstd est moins performant par d√©faut que gzip, mais comme je l&rsquo;ai dit, ce n&rsquo;est pas n√©cessairement repr√©sentatif car le format de fichier ne se pr√™te pas vraiment √† l&rsquo;objectif, de ce c√¥t√© les formats li√©s √† <a href="https://blog.seboss666.info/2017/08/petites-differences-entre-wav-flac-mp3/" target="_blank" rel="noopener">la compression audio</a> ont de meilleurs r√©sultats. Et le temps de compression est vingt fois plus court, donc facile d&rsquo;√™tre s√©duit par le petit dernier de la bande.</p>
<p style="text-align: justify;">√áa, c&rsquo;est pour la compression, voyons donc les r√©sultats de d√©compression :</p>
<p></p><pre class="crayon-plain-tag">$ time gzip -d Alestorm\ -\ Sunset\ On\ The\ Golden\ Age.gz.wav.gz

real	0m5,306s
user	0m4,822s
sys	0m0,445s
$¬†time xz -d Alestorm\ -\ Sunset\ On\ The\ Golden\ Age.xz.wav.xz

real	0m43,681s
user	0m42,892s
sys	0m0,659s

$¬†time zstd -d Alestorm\ -\ Sunset\ On\ The\ Golden\ Age.zst.wav.zst
Alestorm - Sunset On The Golden Age.zst.wav.zst: 514968188 bytes

real	0m0,797s
user	0m0,339s
sys	0m0,435s</pre><p></p>
<p style="text-align: justify;">Une fois encore, on voit que xz est loin derri√®re en termes de rapidit√©, alors que zstd caracole en t√™te.¬† Il semble donc tenir une grande partie de ses promesses.</p>
<p style="text-align: justify;"><strong>Dossier du blog</strong></p>
<p style="text-align: justify;">Passons √† quelque chose de plus repr√©sentatif des pratiques d&rsquo;archivage. D√©j√† ce qui est marrant, c&rsquo;est la diff√©rence entre le dossier d&rsquo;origine, et le fichier tar utilis√© pour le test :</p>
<p></p><pre class="crayon-plain-tag">$ du -shc blog*
822M	blog
799M	blog.tar</pre><p></p>
<p style="text-align: justify;">Il y a donc pr√®s de 30Mo de perdus en petits fichiers qui prennent plus de place dans le syst√®me de fichiers que leur taille r√©elle. Mais on est pas l√† pour en faire l&rsquo;analyse, revenons √† nos moutons. M√™me motif que pr√©c√©demment, copie du fichier tar pour chaque algorithme, voil√† le r√©sultat de compression :</p>
<p></p><pre class="crayon-plain-tag">$¬†time gzip blog.gz.tar

real	0m38,189s
user	0m36,724s
sys	0m1,170s
$¬†time xz blog.xz.tar

real	2m0,761s
user	7m24,399s
sys	0m2,488s
$¬†time zstd --rm blog.zst.tar
blog.zst.tar         : 90.08%   (836802560 =&gt; 753810165 bytes, blog.zst.tar.zst)

real	0m5,070s
user	0m4,118s
sys	0m1,317s</pre><p></p>
<p style="text-align: justify;">Euh, ok, l√† encore, zstd est loin devant en termes de rapidit√©, xz est hors concours de par sa lenteur, et √ßa donne quoi sur les tailles r√©sultantes ?</p>
<p></p><pre class="crayon-plain-tag">$ l
-rw-r--r--  1 seboss666 seboss666 720M 02.03.2020 18:02  blog.gz.tar.gz
-rw-r--r--  1 seboss666 seboss666 799M 02.03.2020 17:58  blog.tar
-rw-r--r--  1 seboss666 seboss666 702M 02.03.2020 18:03  blog.xz.tar.xz
-rw-r--r--  1 seboss666 seboss666 719M 02.03.2020 18:03  blog.zst.tar.zst</pre><p></p>
<p style="text-align: justify;">Ah ! Effectivement, cette fois le r√©sultat est proche de gzip, mais donc pour un traitement huit fois plus rapide. Et √ßa en compression. Et en d√©compression ?</p>
<p></p><pre class="crayon-plain-tag">$ time gzip -d blog.gz.tar.gz

real	0m8,573s
user	0m7,003s
sys	0m0,988s
$¬†time xz -d blog.xz.tar.xz

real	0m43,338s
user	0m41,663s
sys	0m1,268s
$¬†time zstd -d --rm blog.zst.tar.zst
blog.zst.tar.zst    : 836802560 bytes

real	0m3,048s
user	0m0,529s
sys	0m1,146s</pre><p></p>
<p style="text-align: justify;">Bon, les temps de d√©compression sont un peu moins impressionnants, mais tout de m√™me, pr√®s de trois fois plus rapides. J&rsquo;arr√™te l√† les manipulations, je pense qu&rsquo;on a nos r√©ponses.</p>
<h3 style="text-align: justify;">Pas √©tonnant qu&rsquo;il soit populaire</h3>
<p style="text-align: justify;">√Ä voir les chiffres, on comprend un peu mieux le choix d&rsquo;abord d&rsquo;Ubuntu, puis d&rsquo;Arch Linux et donc de Manjaro, de basculer sur ce format plut√¥t qu&rsquo;un autre. Arch Linux utilisait xz jusqu&rsquo;ici, et on voit que si √ßa fonctionne bien d&rsquo;un point de vue stockage, et donc √©conomie en transfert de donn√©es via Internet, le co√ªt en termes de performances √† la fois en compression et d√©compression ne vaut finalement pas la chandelle. Autant consommer un peu plus d&rsquo;espace disque, un peu plus de r√©seau, pour finalement gagner en temps de travail aussi bien √† la cr√©ation qu&rsquo;√† l&rsquo;installation. √áa serait int√©ressant de comparer le co√ªt √©nerg√©tique entre le transfert additionnel sur le r√©seau, et les calculs n√©cessaires pour g√©n√©rer les archives, mais c&rsquo;est un peu compliqu√© et hors scope ici.</p>
<p style="text-align: justify;">Reste que le format est soutenu par Facebook, et naturellement √ßa fait un peu peur, mais vu la finalit√©, il y a peu √† craindre quant √† sa p√©rennit√©, contrairement au support PHP d&rsquo;HHVM qui a pris fin il y a un an. Si l&rsquo;utilitaire zstd n&rsquo;est pas dispo nativement sur votre syst√®me, vous pouvez vous tourner <a href="https://github.com/facebook/zstd" target="_blank" rel="noopener">vers le d√©p√¥t Github</a> qui regorge d&rsquo;informations √† son sujet, avec d&rsquo;autres chiffres de performances, effectu√©s sur une machine hors de port√©e du commun des mortels.</p>
<p style="text-align: justify;">En tout cas, je pense que c&rsquo;est une bonne d√©cision d&rsquo;y √™tre pass√© sur Arch Linux, et pour avoir souffert avec quelques cr√©ations de paquets AUR qui prennent beaucoup de temps m√™me avec xz en multiithread, j&rsquo;esp√®re que la plupart des recettes basculeront sur ce format rapidement.</p>
]]></content:encoded>
            <wfw:commentRss>https://blog.seboss666.info/2020/03/zstd-cest-quoi-ce-format-de-compression/feed/</wfw:commentRss>
            <slash:comments>6</slash:comments>
        </item>
        <item>
            <title>Debian, VMware, Terraform sont dans un bateau&#8230;</title>
            <link>https://blog.seboss666.info/2020/03/debian-vmware-terraform-sont-dans-un-bateau/</link>
            <comments>https://blog.seboss666.info/2020/03/debian-vmware-terraform-sont-dans-un-bateau/#comments</comments>
            <pubDate>Mon, 02 Mar 2020 17:30:50 +0000</pubDate>
            <dc:creator><![CDATA[Seboss666]]></dc:creator>
            <category><![CDATA[Astuces]]></category>
            <category><![CDATA[Sysadmin]]></category>
            <category><![CDATA[debian]]></category>
            <category><![CDATA[infrastructure as code]]></category>
            <category><![CDATA[mensonge]]></category>
            <category><![CDATA[personnalisation]]></category>
            <category><![CDATA[private cloud]]></category>
            <category><![CDATA[template]]></category>
            <category><![CDATA[terraform]]></category>
            <category><![CDATA[Ubuntu]]></category>
            <category><![CDATA[vmware]]></category>

            <guid isPermaLink="false">https://blog.seboss666.info/?p=6179</guid>
            <description><![CDATA[J&#8217;ai eu r√©cemment √† d√©ployer une vingtaine de machines sur un cluster Private Cloud Vmware fourni par OVH. J&#8217;ai pour √ßa test√© le code qu&#8217;un [...]]]></description>
            <content:encoded><![CDATA[<p style="text-align: justify;">J&rsquo;ai eu r√©cemment √† d√©ployer une vingtaine de machines sur un cluster Private Cloud Vmware fourni par OVH. J&rsquo;ai pour √ßa test√© le code qu&rsquo;un de leurs ing√©nieurs a <a href="https://www.ovh.com/blog/private_cloud_and_hashicorp_terraform_part1/" target="_blank" rel="noopener">partag√© sur le blog d&rsquo;OVH</a>, mais √ßa ne s&rsquo;est pas d√©roul√© comme pr√©vu. Et la solution a pris du temps, et c&rsquo;est d√©gueulasse&#8230;</p>
<p style="text-align: justify;"><span id="more-6179"></span></p>
<h3 style="text-align: justify;">Un vrai parcours du combattant</h3>
<p style="text-align: justify;">Mes machines doivent √™tre d√©ploy√©es en Debian 9 (on pleure pas trop vite s&rsquo;il vous plait), pas le choix parce qu&rsquo;il nous manque encore des pr√©requis internes pour la bonne gestion de Debian 10 chez nous. Qui dit d√©ploiement par terraform dit d&rsquo;abord cr√©ation d&rsquo;un template Debian 9.</p>
<p style="text-align: justify;"><em>Au passage je vous recommande vivement de vous int√©resser √† <a href="https://www.terraform.io/" target="_blank" rel="noopener">Terraform</a> si vous comptez bosser de l&rsquo;infrastructure ¬´¬†cloud¬†¬ª, y&rsquo;a une quantit√© hallucinante de providers et c&rsquo;est vraiment un outil sympa √† utiliser, qui s&rsquo;int√®gre assez facilement dans un flux de d√©ploiement automatis√© de bout en bout.</em></p>
<p style="text-align: justify;">Au d√©but mon manager m&rsquo;a fil√© un d√©p√¥t avec une configuration Packer, autre outil d√©velopp√© par Hashicorp, qu&rsquo;il avait utilis√© pour du CentOS 7. Apr√®s avoir pass√© une apr√®s-midi √† essayer de comprendre comment fonctionne le preseed de l&rsquo;installateur Debian, et √©chou√© √† le faire utiliser avec Packer (au passage, si on compare preseed √† kickstart, preseed c&rsquo;est de la merde en barre), j&rsquo;ai d√©cid√© de cr√©er mon template √† la main √† partir de l&rsquo;iso officielle 64bit, avec installation d&rsquo;open-vm-tools, comme recommand√© <a href="https://github.com/vmware/open-vm-tools#will-there-be-continued-support-for-vmware-tools-and-osp" target="_blank" rel="noopener">par la documentation de VMware</a>.</p>
<p style="text-align: justify;">Puis, une fois le template pr√™t et rang√© dans son dossier, je pr√©pare le code rapidement et proc√®de √† une premi√®re tentative de cr√©ation d&rsquo;une machine virtuelle √† partir du template. Comme on l&rsquo;imagine, puisqu&rsquo;on en parle aujourd&rsquo;hui, √ßa ne s&rsquo;est pas vraiment d√©roul√© comme je l&rsquo;attendais :</p>
<p></p><pre class="crayon-plain-tag">Error: error sending customization spec: Customization of the guest operating system 'debian9_64Guest' is not supported in this configuration. Microsoft Vista (TM) and Linux guests with Logical Volume Manager are supported only for recent ESX host and VMware Tools versions. Refer to vCenter documentation for supported configurations.</pre><p></p>
<p style="text-align: justify;">Et il supprime la machine virtuelle. Arf. Il se trouve que j&rsquo;ai le m√™me message apr√®s une tentative manuelle depuis l&rsquo;interface web en cochant l&rsquo;option qui correspond √† la personnalisation de l&rsquo;OS. Damned. D√©j√†, le message est sympathique car il parle de Vista, cancer n√©cessaire de Microsoft qui aura quand m√™me permis √† terme d&rsquo;avoir le g√©nial Windows 7 (qui vient de prendre sa retraite), mais aussi et plus surprenant, de LVM. Surprenant car je sais que VMware supporte parfaitement LVM dans ses diff√©rents outils, pour avoir bouff√© du VMware Converter sur un projet pr√©c√©dent. Sans plus de conviction, je perds donc du temps √† recr√©er un second template partitionn√© sans LVM cette fois; m√™me punition, m√™me message, l&rsquo;erreur est donc g√©n√©rique et d√©bile.</p>
<p style="text-align: justify;">Je me tourne alors vers le support OVH, en leur donnant tous les d√©tails de mes manipulations et tests. Leur r√©ponse, en substance :</p>
<blockquote><p>On reproduit, mais on comprend pas non plus</p></blockquote>
<p style="text-align: justify;">Et en effet, en cherchant partout sur les docs VMware √ßa devrait pas bloquer. Mais des r√©ponses comme celle-ci ne m&rsquo;avancent pas √† grand chose.</p>
<p style="text-align: justify;">Il fallait que j&rsquo;avance donc j&rsquo;ai d√©ploy√© mes machines de pr√©-production √† la main, fourni les acc√®s √† l&rsquo;agence de d√©veloppement et j&rsquo;ai un peu laiss√© de c√¥t√©, pendant que je relan√ßais √† intervalle r√©gulier le support pour avoir des nouvelles.</p>
<p style="text-align: justify;">R√©ponse quelques dizaines de jours et partage de traces terraform &amp; co plus tard : il faut modifier le type de machine virtuelle qu&rsquo;on cr√©e √† Ubuntu, m√™me si on installe Debian dedans. Mentir √† l&rsquo;hyperviseur, bravo, il est vrai que je l&rsquo;avais vu passer dans mes recherches Google, mais √ßa ne me pla√Æt pas vraiment et donc, j&rsquo;ai pas test√©. Mais maintenant et au point o√π on en est, pourquoi pas. Le support me dit que je peux tester avec leur template, mais √ßa √©choue sur la m√™me erreur, bravo.</p>
<p style="text-align: justify;">J&rsquo;entreprends donc de refaire un nouveau template, en mentant, avec LVM, et je r√©installe les m√™mes packages. Nouvelle tentative de d√©ploiement : √ßa semble fonctionner, je n&rsquo;ai plus le message d&rsquo;erreur de personnalisation, mais pas de bol, √ßa √©choue une √©tape plus tard. Ce coup-ci cependant, Terraform me laisse la machine pour d√©bug, et affiche ce message :</p>
<p></p><pre class="crayon-plain-tag">An error occurred while customizing VM client-test1-preprod1. For details reference the log file &lt;no_log&gt; in the guest OS.</pre><p></p>
<p style="text-align: justify;">j&rsquo;ai vraiment pas de bol, il devrait y avoir un fichier de log, il n&rsquo;existe pas. Je d√©couvre malgr√© tout un truc bizarre : la machine virtuelle est bien d√©marr√©e, mais la carte r√©seau n&rsquo;est pas connect√©e, alors que la case est bien coch√©e dans le template. Je refouille sur Google, et l√†, je tombe sur un message r√©cent, qui n&rsquo;existait pas au d√©but de mon probl√®me, qui parle d&rsquo;<a href="https://github.com/terraform-providers/terraform-provider-vsphere/issues/388" target="_blank" rel="noopener">un souci avec l&rsquo;unit systemd d&rsquo;open-vm-tools</a>.</p>
<p style="text-align: justify;">Je retourne donc dans le template (qu&rsquo;on convertit en machine virtuelle pour pouvoir en modifier le contenu), et plut√¥t que de modifier le fichier original qui pourrait √™tre √©cras√© par une √©ventuelle mise √† jour, j&rsquo;exploite les capacit√©s d&rsquo;override de systemd dont vient de parler Cascador <a href="https://www.blog-libre.org/2020/03/01/demarrer-un-service-selon-une-condition-avec-systemd/" target="_blank" rel="noopener">sur le Blog Libre</a> :</p>
<p></p><pre class="crayon-plain-tag">$ export EDITOR=vim
$ sudo systemctl edit open-vm-tools.service
#Contenu de l'override
[Unit]
After=dbus.service</pre><p></p>
<p style="text-align: justify;">On repasse en template, et on relance terraform, et l√†, 1m30s apr√®s :</p>
<p></p><pre class="crayon-plain-tag">Apply complete! Resources: 1 added, 0 changed, 0 destroyed.</pre><p></p>
<p style="text-align: justify;">Et tout √ßa, √ßa a pratiquement pris encore une apr√®s-midi qui n&rsquo;a pas pu √™tre consacr√©e √† d&rsquo;autres sujets (dont une investigation sur une corruption fr√©quente de base RPM sur du Redhat 7 qui semble caus√©e par une configuration qu&rsquo;on d√©ploie chez tous les clients&#8230;).</p>
<p style="text-align: justify;">Comme d&rsquo;habitude, je cherche et constate que personne n&rsquo;a remont√© le probl√®me chez Debian. J&rsquo;ai failli le faire, avant de comparer au paquet Debian 10, et je me suis ravis√©, car de toute fa√ßon, Debian 9 n&rsquo;a plus qu&rsquo;un an et demi devant lui, et le nombre de projets qu&rsquo;on sera amen√© √† mener dans un environnement similaire fait qu&rsquo;on pourra supporter cette petite bidouille. J&rsquo;ai tout de m√™me partag√© au support OVH qui pourra, au besoin, transmettre aux futurs infortun√©s qui seraient contraints au m√™me d√©ploiement sans avoir lu cet article.</p>
<h3 style="text-align: justify;">VMware, c&rsquo;est de la merde ?</h3>
<p style="text-align: justify;">En vrai pas tant que √ßa, mais effectivement sur ce point, Debian et Ubuntu partageant une base commune, je ne comprend pas pourquoi il ne ¬´¬†supporterait¬†¬ª pas le fait de d√©clarer correctement qu&rsquo;on utilise une Debian, surtout qu&rsquo;il bosse parfaitement derri√®re : hostname, fichier interfaces, tout est l√†, proprement configur√©. On rage d&rsquo;autant plus du coup d&rsquo;avoir perdus plusieurs apr√®s-midi et patient√© plusieurs jours sur un truc aussi b√™te.</p>
<p style="text-align: justify;">Et dans le d√©p√¥t d&rsquo;open-vm-tools, il n&rsquo;y a pas de fichier d&rsquo;unit systemd, je pense donc que c&rsquo;est une faiblesse introduite par le mainteneur du paquet pour Debian. D&rsquo;ailleurs, quand on voit le nombre de diff√©rences entre celui pour Debian 9 et celui pour Debian 10, c&rsquo;est qu&rsquo;il a d√ª √™tre plus longuement test√© et donc les probl√®mes mieux identifi√©s. Donc l√† non plus on ne peut pas enti√®rement bl√¢mer les d√©veloppeurs, m√™me si un petit coup de pouce documentaire n&rsquo;aurait pas √©t√© de trop de la part de l&rsquo;√©diteur. On salue par contre sans probl√®me le choix des licences rattach√©es au code publi√©, pas √©vident puisque VMware est un √©diteur de logiciel majoritairement propri√©taire √† la base.</p>
<p style="text-align: justify;">De mon c√¥t√©, j&rsquo;aimerai tester Terraform sur un autre hyperviseur, en l&rsquo;occurrence Proxmox puisque je l&rsquo;utilise chez moi et sur le serveur physique qui h√©berge entre autre ce blog, mais il n&rsquo;y a pas de provider officiel, juste <a href="https://github.com/Telmate/terraform-provider-proxmox" target="_blank" rel="noopener">un provider ind√©pendant</a> qui semble du coup avoir ses propres contraintes qu&rsquo;il faudra apprivoiser. Par contre vu le rythme actuel de publication, √ßa sera dans deux ans hein ^^&rsquo;</p>
]]></content:encoded>
            <wfw:commentRss>https://blog.seboss666.info/2020/03/debian-vmware-terraform-sont-dans-un-bateau/feed/</wfw:commentRss>
            <slash:comments>9</slash:comments>
        </item>
    </channel>
</rss>